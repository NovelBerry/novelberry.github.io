<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REINO CHAMPI√ë√ìN: Batalla de Compa√±eros</title>
    <style>
        /* Estilo de Consola Retro */
        body {
            background-color: #2c3e50; /* Azul Oscuro (Color Game Boy) */
            color: #ecf0f1; /* Gris Claro */
            font-family: 'Press Start 2P', monospace; /* Fuente Pixelada (Si est√° disponible) */
            font-family: 'Courier New', monospace; /* Alternativa simple */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }

        .game-container {
            padding: 20px;
            border: 6px solid #f1c40f; /* Borde Amarillo "Poder" */
            border-radius: 10px;
            background-color: #34495e; /* Azul/Gris Interior */
            max-width: 700px;
            min-height: 550px;
            position: relative;
            box-shadow: 0 0 0 10px #2c3e50;
        }

        h1 {
            color: #1abc9c; /* Verde Menta */
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px #000000;
        }

        /* DISPLAY DE ESTADO */
        #status-display {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #7f8c8d;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: left;
            background-color: #2c3e50;
        }
        .stat-pe { color: #f39c12; }
        .stat-team { color: #3498db; }

        /* PANTALLA DE BATALLA/HISTORIA */
        #story-text {
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 20px;
            white-space: pre-wrap;
            text-align: left;
            min-height: 150px;
            padding: 10px;
            border: 2px solid #e74c3c; /* Rojo Peligro */
            background-color: #252d37;
        }
        
        /* VISUAL DE BATALLA */
        .battle-screen {
            border: 3px solid #f39c12;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #1d2630;
            text-align: center;
        }
        .battle-foe { color: #e74c3c; font-size: 1.5em; }
        .battle-ally { color: #2ecc71; font-size: 1.5em; }

        /* BOTONES DE OPCI√ìN */
        #choice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .choice-button {
            background-color: #27ae60; /* Verde de Acci√≥n */
            color: #ffffff;
            border: 2px solid #2ecc71;
            padding: 10px 15px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.1s;
        }

        .choice-button:hover:not(:disabled) {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .choice-button:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
            border-color: #777;
        }
        
        /* Estilos de Batalla Espec√≠ficos */
        .battle-action { background-color: #3498db; }
        .battle-capture { background-color: #e74c3c; }
        .battle-item { background-color: #f1c40f; }
        
    </style>
    </head>
<body>

<div class="game-container">
    <h1>REINO CHAMPI√ë√ìN: BATALLA DE COMPA√ëEROS</h1>
    <div id="status-display"></div>
    <div id="battle-view" style="display:none;" class="battle-screen">
        <div class="battle-foe">Enemigo: <span id="foe-name"></span> üçÑ</div>
        <div class="battle-ally">T√∫: <span id="ally-name">MARIO</span> ‚≠ê</div>
        <p id="battle-log"></p>
    </div>
    <div id="story-text"></div>
    <div id="choice-buttons"></div>
</div>

<script>
    // =================================================================================
    // === SISTEMA DE JUEGO MARIO-POK√âMON (Mejorado) ===
    // =================================================================================

    let gameStatus = {
        potencia_pe: 100,
        equipo: ["MARIO"], // MARIO siempre es el l√≠der
        items: ["SUPER HONGO", "SUPER HONGO"], // Objeto inicial
        currentSceneId: 's1_intro'
    };
    
    // El Pok√©mon enemigo actual para la batalla
    let currentFoe = null; 

    // Lista de enemigos/compa√±eros posibles
    const COMPANIONS_AND_FOES = {
        'GOOMBA': { power: 15, recruitChance: 60, emoji: 'üçÑ' },
        'KOOPA_TROOPA': { power: 25, recruitChance: 40, emoji: 'üê¢' },
        'LAKITU': { power: 35, recruitChance: 25, emoji: '‚òÅÔ∏è' },
        'BOWSER_JR': { power: 50, recruitChance: 10, emoji: 'üî•' }
    };

    // --- FUNCIONES CORE ---

    function updateStatus() {
        const display = document.getElementById('status-display');
        const teamList = gameStatus.equipo.length > 0 ? gameStatus.equipo.join(', ') : 'VAC√çO';
        const itemsList = gameStatus.items.length > 0 ? gameStatus.items.join(', ') : 'NINGUNO';
        
        display.innerHTML = `
            <div class="stat-pe">‚ö° POTENCIA (PE): ${gameStatus.potencia_pe}</div>
            <div class="stat-team">‚≠ê EQUIPO: ${teamList} (${gameStatus.equipo.length}/6)</div>
            <div class="stat-items">üéí OBJETOS: ${itemsList}</div>
        `;
    }

    function applyChanges(changes) {
        if (!changes) return;

        // 1. Manejo de Puntos de Potencia (PE)
        if (changes.pe) {
            gameStatus.potencia_pe += changes.pe;
            gameStatus.potencia_pe = Math.max(0, gameStatus.potencia_pe); 
        }

        // 2. Manejo de Equipo (Reclutar)
        if (changes.reclutar) {
            changes.reclutar.forEach(newMember => {
                if (!gameStatus.equipo.includes(newMember) && gameStatus.equipo.length < 6) {
                    gameStatus.equipo.push(newMember);
                    alert(`¬°${newMember} se ha unido a tu equipo!`);
                } else if (gameStatus.equipo.length >= 6) {
                    alert('Tu equipo est√° lleno (M√°x. 6 miembros).');
                }
            });
        }
        
        // 3. Manejo de Items
        if (changes.item) {
            changes.item.forEach(newItem => {
                gameStatus.items.push(newItem);
            });
        }
        
        updateStatus();
    }

    function checkRequirements(requirements) {
        if (!requirements) return { isMet: true, reason: '' };
        if (requirements.min_pe && gameStatus.potencia_pe < requirements.min_pe) {
            return { isMet: false, reason: `Necesitas ${requirements.min_pe} PE.` };
        }
        if (requirements.requires_member && !gameStatus.equipo.includes(requirements.requires_member)) {
            return { isMet: false, reason: `Requiere tener a ${requirements.requires_member}.` };
        }
        return { isMet: true, reason: '' };
    }

    // --- FUNCIONES DE BATALLA (NUEVO) ---
    
    function startBattle(foeId, nextSuccess, nextFail) {
        // Inicializa el estado de batalla
        currentFoe = { 
            id: foeId, 
            ...COMPANIONS_AND_FOES[foeId], 
            hp: COMPANIONS_AND_FOES[foeId].power * 2 // HP es el doble de su poder base
        };
        
        document.getElementById('story-text').style.display = 'none';
        document.getElementById('battle-view').style.display = 'block';
        document.getElementById('foe-name').textContent = `${currentFoe.id} (${currentFoe.hp} HP) ${currentFoe.emoji}`;
        document.getElementById('battle-log').textContent = `¬°Un ${currentFoe.id} salvaje aparece! ¬øQu√© har√° MARIO?`;
        
        // Renderiza las opciones de batalla
        renderBattleOptions(nextSuccess, nextFail);
    }
    
    function renderBattleOptions(nextSuccess, nextFail) {
        const buttonsContainer = document.getElementById('choice-buttons');
        buttonsContainer.innerHTML = '';
        
        // Opci√≥n 1: Atacar
        const attackButton = createButton('ATACAR (Poder Base)', 'battle-action', () => performAttack(nextSuccess, nextFail));
        buttonsContainer.appendChild(attackButton);
        
        // Opci√≥n 2: Usar Objeto (Hongo)
        const itemButton = createButton('USAR SUPER HONGO', 'battle-item', () => useItem('SUPER HONGO', nextSuccess, nextFail));
        if (!gameStatus.items.includes('SUPER HONGO')) itemButton.disabled = true;
        buttonsContainer.appendChild(itemButton);
        
        // Opci√≥n 3: Intentar Reclutar (Capturar)
        const captureButton = createButton('INTENTAR RECLUTAR', 'battle-capture', () => attemptRecruit(nextSuccess, nextFail));
        buttonsContainer.appendChild(captureButton);
        
        // Opci√≥n 4: Huir (Siempre posible, pero con costo de PE)
        const runButton = createButton('HUIR (-15 PE)', '', () => endBattle(nextFail, { pe: -15 }));
        buttonsContainer.appendChild(runButton);
    }
    
    function performAttack(nextSuccess, nextFail) {
        const damage = 20 + Math.floor(Math.random() * 10); // Da√±o de 20 a 30
        currentFoe.hp -= damage;
        
        let log = `MARIO ataca con un Super Salto. ¬°${currentFoe.id} recibe ${damage} de da√±o! `;
        
        if (currentFoe.hp <= 0) {
            log += `¬°El ${currentFoe.id} ha sido derrotado!`;
            document.getElementById('battle-log').textContent = log;
            endBattle(nextSuccess, { pe: currentFoe.power * 2 }); // Ganas PE
            return;
        }

        // El enemigo contraataca
        const foeDamage = currentFoe.power;
        gameStatus.potencia_pe -= foeDamage;
        updateStatus();
        
        log += `El ${currentFoe.id} contraataca. Pierdes ${foeDamage} PE. `;
        
        if (gameStatus.potencia_pe <= 0) {
            document.getElementById('battle-log').textContent = log + '¬°MARIO ha sido vencido!';
            renderEnding('E_NO_PE');
            return;
        }
        
        document.getElementById('foe-name').textContent = `${currentFoe.id} (${currentFoe.hp} HP) ${currentFoe.emoji}`;
        document.getElementById('battle-log').textContent = log;
        renderBattleOptions(nextSuccess, nextFail); // Siguiente turno
    }
    
    function useItem(item, nextSuccess, nextFail) {
        if (item === 'SUPER HONGO') {
            gameStatus.potencia_pe += 30;
            gameStatus.items.splice(gameStatus.items.indexOf(item), 1); // Quitar uno
            
            document.getElementById('battle-log').textContent = `MARIO usa un ${item}. ¬°Recupera 30 PE!`;
            updateStatus();
            renderBattleOptions(nextSuccess, nextFail);
        }
    }
    
    function attemptRecruit(nextSuccess, nextFail) {
        const captureChance = currentFoe.recruitChance + (100 - currentFoe.hp); // M√°s f√°cil si tiene menos HP
        
        if (Math.random() * 100 < captureChance && gameStatus.equipo.length < 6) {
            document.getElementById('battle-log').textContent = `¬°MARIO lanza una Super Bola! ¬°Capturaste a ${currentFoe.id}!`;
            endBattle(nextSuccess, { reclutar: [currentFoe.id], pe: 10 });
        } else {
            document.getElementById('battle-log').textContent = `¬°El ${currentFoe.id} se libera! Pierdes turno y 10 PE.`;
            gameStatus.potencia_pe -= 10;
            updateStatus();
            if (gameStatus.potencia_pe <= 0) {
                renderEnding('E_NO_PE');
                return;
            }
            renderBattleOptions(nextSuccess, nextFail);
        }
    }
    
    function endBattle(nextScene, changes = {}) {
        applyChanges(changes);
        currentFoe = null;
        document.getElementById('battle-view').style.display = 'none';
        document.getElementById('story-text').style.display = 'block';
        
        // Pausa breve para que el jugador lea el resultado
        setTimeout(() => {
            renderScene(nextScene);
        }, 1500);
    }
    
    // --- UTILITIES ---
    function createButton(text, className, onClick) {
        const button = document.createElement('button');
        button.className = 'choice-button ' + className;
        button.textContent = text.toUpperCase();
        button.onclick = onClick;
        return button;
    }
    function disableButtons() {
        document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);
    }
    
    // --- RENDERIZADO PRINCIPAL ---
    
    function renderScene(sceneId) {
        if (gameStatus.potencia_pe <= 0) {
            renderEnding('E_NO_PE');
            return;
        }
        const scene = STORY_TREE[sceneId];
        if (!scene) { renderEnding(sceneId); return; }
        
        gameStatus.currentSceneId = sceneId;
        document.getElementById('story-text').innerHTML = scene.text;
        const buttonsContainer = document.getElementById('choice-buttons');
        buttonsContainer.innerHTML = '';
        
        if (scene.is_ending) { renderEnding(sceneId); return; }
        
        // Verifica si la escena es una batalla
        if (scene.is_battle) {
            startBattle(scene.foe, scene.next_success, scene.next_fail);
            return;
        }
        
        // Renderiza opciones normales
        scene.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-button';
            let costText = "";
            let requirementsMet = checkRequirements(choice.requirements);
            
            if (choice.changes && choice.changes.pe) {
                const peChange = choice.changes.pe;
                const sign = peChange >= 0 ? '+' : '';
                costText = ` [${sign}${peChange} PE]`;
            }

            button.textContent = choice.text + costText;
            
            if (!requirementsMet.isMet) {
                button.disabled = true;
                button.textContent = `${choice.text} (REQUERIMIENTO: ${requirementsMet.reason})`;
            }

            button.onclick = () => {
                if (button.disabled) return;
                disableButtons();
                applyChanges(choice.changes);
                renderScene(choice.next);
            };
            buttonsContainer.appendChild(button);
        });
        updateStatus();
    }
    
    // --- FINALES ---
    const ENDINGS = {
        'E_NO_PE': "GAME OVER. ¬°MARIO HA PERDIDO TODA SU ENERG√çA! Tu aventura se detiene aqu√≠. **FIN POR AGOTAMIENTO.**",
        'E_WIN': "¬°FELICITACIONES! Has derrotado al gran jefe y reunido el equipo legendario. El Reino Champi√±√≥n est√° a salvo. **FINAL BUENO.**",
        's500_final': ">>> FIN DE DEMOSTRACI√ìN. ¬°GRACIAS POR JUGAR! <<<",
    };

    function renderEnding(endingId) {
        document.getElementById('story-text').innerHTML = ENDINGS[endingId] || `FIN DE LA TRAMA. ID: ${endingId}`;
        document.getElementById('story-text').classList.add('ending');
        document.getElementById('story-text').style.display = 'block';
        document.getElementById('battle-view').style.display = 'none';
        document.getElementById('choice-buttons').innerHTML = `<button class="choice-button" onclick="window.location.reload()">REINICIAR AVENTURA</button>`;
        document.getElementById('story-text').style.textAlign = 'center';
    }


    // =================================================================================
    // === √ÅRBOL DE HISTORIA (ACTO 1 CON BATALLAS) ===
    // =================================================================================

    const STORY_TREE = {
        
        's1_intro': {
            text: "Eres MARIO, el Maestro Entrenador. Llegas a la Pradera Champi√±√≥n en busca de un equipo. Un Goomba salvaje te ha visto.",
            choices: [
                { text: "Enfrentar al Goomba (Iniciar Batalla)", next: 's2_battle_goomba', changes: { pe: -5 } },
                { text: "Escapar a la Casa de Toad", next: 's2_toad_house', changes: { pe: -10 } }
            ]
        },

        // --- NODOS DE BATALLA (NUEVO FORMATO) ---
        's2_battle_goomba': {
            is_battle: true,
            foe: 'GOOMBA',
            next_success: 's3_after_goomba', // Si ganas o reclutas
            next_fail: 's1_intro', // Si huyes o pierdes PE pero no mueres
            text: "El GOOMBA te bloquea. Es hora de la primera BATALLA."
        },
        
        's3_after_goomba': {
            text: "Tras la batalla, el camino est√° abierto. Ves una extra√±a tuber√≠a brillante. ¬øEntrar o continuar por el camino?",
            choices: [
                { text: "Entrar en la Tuber√≠a (Acceso R√°pido)", next: 's4_pipe', changes: { pe: -10 } },
                { text: "Continuar por el camino", next: 's4_road', changes: { pe: 5 } }
            ]
        },
        
        // --- NODOS NORMALES ---
        's2_toad_house': {
            text: "La casa de Toad est√° tranquila. Encuentras un kit de primeros auxilios. ¬øRecogerlos o no?",
            choices: [
                { text: "Recoger Super Hongos", next: 's3_after_toad', changes: { item: ["SUPER HONGO"], pe: 5 } },
                { text: "Dejar los objetos y salir", next: 's4_road', changes: { pe: -5 } }
            ]
        },
        
        's3_after_toad': {
            text: "Un Koopa Troopa te ve saliendo de la casa. Te desaf√≠a a una batalla por el territorio.",
            choices: [
                { text: "Aceptar el Desaf√≠o", next: 's4_battle_koopa', changes: { pe: -10 } },
                { text: "Intentar razonar con √©l (Requiere TOAD en el equipo)", next: 's5_reason', changes: { pe: -5 }, requirements: { requires_member: "TOAD" } }
            ]
        },

        's4_battle_koopa': {
            is_battle: true,
            foe: 'KOOPA_TROOPA',
            next_success: 's5_koopa_win',
            next_fail: 's4_road',
            text: "¬°El Koopa Troopa te ataca con su caparaz√≥n giratorio!"
        },
        
        's5_koopa_win': {
            text: "Has vencido al Koopa. ¬°Obtienes un nuevo Huevo de Yoshi!",
            choices: [
                { text: "ECLOSIONAR EL HUEVO (Reclutar a YOSHI)", next: 's500_final', changes: { reclutar: ["YOSHI"], pe: 30 } },
            ]
        },
        
        's4_pipe': {
            text: "La tuber√≠a te lleva a una zona de bonificaci√≥n, pero pierdes PE por la prisa.",
            choices: [
                { text: "Continuar la aventura...", next: 's500_final', changes: { pe: -15 } },
            ]
        },
        
        's4_road': {
            text: "Sigues el camino, es seguro, pero lento. Pierdes un poco de tiempo.",
            choices: [
                { text: "Continuar la aventura...", next: 's500_final', changes: { pe: -5 } },
            ]
        },
        
        // ... (Aqu√≠ continuar√≠an cientos de nodos: s6_... hasta s500+) ...
        
    };

    // Iniciar el juego
    window.onload = () => {
        updateStatus();
        renderScene(gameStatus.currentSceneId);
    };
</script>
</body>
</html>
