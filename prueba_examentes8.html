<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulación Exámenes Validación 8° Básico</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#10b981; --muted:#94a3b8; --paper:#f8fafc;
    }
    body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#071024 0%, #0b1220 100%);color:var(--paper);margin:0;padding:24px;min-height:100vh;}
    .container{max-width:980px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(0,0,0,0.1));border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.7);}
    h1{margin:0 0 8px;font-size:1.6rem}
    p.lead{color:var(--muted);margin-top:6px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px;}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;flex:1;min-width:220px;}
    button, select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--paper);padding:10px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);color:#032; border:none}
    .center{text-align:center}
    .question{margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .alternatives{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .alt{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .alt.selected{outline:2px solid rgba(16,185,129,0.25);background:rgba(16,185,129,0.03)}
    .footer{margin-top:18px;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .small{font-size:0.86rem;color:var(--muted)}
    .result{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:12px}
    .fail{color:#ff6b6b} .pass{color:#34d399}
    .review-list{margin-top:8px}
    .hide{display:none}
    .timer{font-weight:700}
    @media(max-width:700px){ .row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Simulación - Exámenes de Validación (8° básico)</h1>
    <p class="lead">Elige una asignatura y comienza la prueba. Cada prueba tiene 30 preguntas.</p>

    <div id="start-screen" class="card">
      <div class="row">
        <div>
          <label for="subject">Selecciona asignatura</label><br/>
          <select id="subject">
            <option value="matematica">Matemáticas</option>
            <option value="historia">Historia, Geografía y Cs. Sociales</option>
            <option value="lenguaje">Lengua y Literatura</option>
            <option value="ciencias">Ciencias Naturales</option>
            <option value="ingles">Inglés</option>
          </select>
        </div>
        <div>
          <label for="timer-toggle">Temporizador 90 min</label><br/>
          <select id="timer-toggle">
            <option value="on">Activado (90:00)</option>
            <option value="off" selected>Desactivado</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="startBtn" class="primary">Comenzar prueba</button>
        </div>
      </div>
      <p class="small">Esta simulación usa preguntas generadas a partir del temario oficial de 8° básico.</p>
    </div>

    <div id="quiz-screen" class="hide">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>
            <strong id="subject-title"></strong>
            <div class="small" id="qprogress">Pregunta <span id="curQ">1</span> / 30</div>
          </div>
          <div class="center">
            <div class="small">Tiempo</div>
            <div class="timer" id="timer">--:--</div>
          </div>
        </div>

        <div id="questionArea" class="question" aria-live="polite">
        </div>

        <div class="footer">
          <div>
            <button id="prevBtn">Anterior</button>
            <button id="nextBtn">Siguiente</button>
          </div>
          <div>
            <button id="finishBtn" class="primary">Terminar y corregir</button>
          </div>
        </div>
      </div>
    </div>

    <div id="result-screen" class="hide card">
      <h3>Resultado</h3>
      <div id="resultSummary" class="result"></div>
      <div id="reviewArea" class="hide">
        <h4>Preguntas que fallaste</h4>
        <div id="reviewList" class="review-list"></div>
      </div>
      <div style="margin-top:12px">
        <button id="restartBtn">Volver a inicio</button>
      </div>
    </div>
  </div>

  <script>
  const PASS_THRESHOLD = 0.60; // 60%
  const TOTAL_QUESTIONS = 30;

  // ... misma definición de bancos que antes ...
  // ↓↓↓ Pega aquí exactamente los arrays banks.matematica, banks.historia, etc. del código anterior ↓↓↓

  const banks = {
    matematica: [/* … mismas 30 preguntas matemáticas del código anterior …*/],
    historia: [/* … */],
    lenguaje: [/* … */],
    ciencias: [/* … */],
    ingles: [/* … */]
  };

  const subjectNames = {
    matematica: "Matemáticas",
    historia: "Historia, Geografía y Cs. Sociales",
    lenguaje: "Lengua y Literatura",
    ciencias: "Ciencias Naturales",
    ingles: "Inglés"
  };

  let currentBank = [];
  let userAnswers = [];
  let currentIndex = 0;
  let timerInterval = null;
  let timeLeft = 0;

  const startBtn = document.getElementById('startBtn');
  const subjectSelect = document.getElementById('subject');
  const timerToggle = document.getElementById('timer-toggle');
  const startScreen = document.getElementById('start-screen');
  const quizScreen = document.getElementById('quiz-screen');
  const questionArea = document.getElementById('questionArea');
  const curQ = document.getElementById('curQ');
  const qprogress = document.getElementById('qprogress');
  const subjectTitle = document.getElementById('subject-title');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');
  const timerEl = document.getElementById('timer');
  const resultScreen = document.getElementById('result-screen');
  const resultSummary = document.getElementById('resultSummary');
  const reviewArea = document.getElementById('reviewArea');
  const reviewList = document.getElementById('reviewList');
  const restartBtn = document.getElementById('restartBtn');

  function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

  function startQuiz(){
    const subj = subjectSelect.value;
    subjectTitle.textContent = subjectNames[subj];
    let source = banks[subj];
    if(!source || source.length===0){
      alert("No hay preguntas cargadas para esta asignatura.");
      return;
    }
    currentBank = JSON.parse(JSON.stringify(source));
    if(currentBank.length < TOTAL_QUESTIONS){
      while(currentBank.length < TOTAL_QUESTIONS){
        currentBank = currentBank.concat(JSON.parse(JSON.stringify(source)));
      }
    }
    currentBank = shuffle(currentBank).slice(0, TOTAL_QUESTIONS);
    userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
    currentIndex = 0;
    renderQuestion();
    startScreen.classList.add('hide');
    quizScreen.classList.remove('hide');
    resultScreen.classList.add('hide');
    if(timerToggle.value === 'on'){
      timeLeft = 90*60;
      updateTimerDisplay();
      timerInterval = setInterval(()=>{
        timeLeft--;
        updateTimerDisplay();
        if(timeLeft <= 0){ clearInterval(timerInterval); finishQuiz(); }
      },1000);
    } else {
      timerEl.textContent = '--:--';
    }
  }

  function updateTimerDisplay(){
    const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const s = String(timeLeft%60).padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
  }

  function renderQuestion(){
    const item = currentBank[currentIndex];
    curQ.textContent = currentIndex+1;
    qprogress.innerHTML = `Pregunta <strong>${currentIndex+1}</strong> / ${TOTAL_QUESTIONS}`;
    let html = `<div><strong>Pregunta ${currentIndex+1}:</strong> ${escapeHtml(item.q)}</div>`;
    html += `<div class="alternatives">`;
    const letters = ['A','B','C','D'];
    for(let i=0;i<4;i++){
      const letter = letters[i];
      const text = item.choices[i] || '';
      const selected = userAnswers[currentIndex]===letter ? 'selected' : '';
      html += `<div class="alt ${selected}" data-choice="${letter}"><strong>${letter}.</strong> ${escapeHtml(text)}</div>`;
    }
    html += `</div>`;
    questionArea.innerHTML = html;
    document.querySelectorAll('.alt').forEach(el=>{
      el.addEventListener('click',()=>{
        document.querySelectorAll('.alt').forEach(a=>a.classList.remove('selected'));
        el.classList.add('selected');
        userAnswers[currentIndex] = el.getAttribute('data-choice');
      });
    });
    prevBtn.disabled = currentIndex===0;
    nextBtn.disabled = currentIndex===TOTAL_QUESTIONS-1;
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  prevBtn.addEventListener('click',()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } });
  nextBtn.addEventListener('click',()=>{ if(currentIndex < TOTAL_QUESTIONS-1){ currentIndex++; renderQuestion(); } });
  finishBtn.addEventListener('click', finishQuiz);

  function finishQuiz(){
    if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
    let correct = 0;
    const missed = [];
    for(let i=0;i<TOTAL_QUESTIONS;i++){
      const right = currentBank[i].answer;
      const user = userAnswers[i];
      if(user === right){ correct++; }
      else {
        missed.push({index:i+1, q:currentBank[i].q, correct:right, chosen:user, choices:currentBank[i].choices});
      }
    }
    const pct = Math.round( (correct / TOTAL_QUESTIONS) * 100 );
    const passed = (correct / TOTAL_QUESTIONS) >= PASS_THRESHOLD;
    quizScreen.classList.add('hide');
    resultScreen.classList.remove('hide');
    resultSummary.innerHTML = `<strong>Puntaje:</strong> ${correct} / ${TOTAL_QUESTIONS} — <strong>${pct}%</strong>
      <div class="${passed ? 'pass' : 'fail'}" style="margin-top:8px"><strong>${passed ? 'APROBADO' : 'REPROBADO'}</strong></div>`;
    if(missed.length>0){
      reviewArea.classList.remove('hide');
      reviewList.innerHTML = '';
      missed.forEach(item=>{
        const letters=['A','B','C','D'];
        let choicesHtml = '<ul>';
        for(let i=0;i<4;i++){
          const L=letters[i];
          const txt = item.choices[i] || '';
          const isCorrect = (L === item.correct);
          choicesHtml += `<li><strong>${L}.</strong> ${escapeHtml(txt)} ${isCorrect ? '<em style="color:var(--accent)"> (correcta)</em>' : ''}</li>`;
        }
        choicesHtml += '</ul>';
        const chosenText = item.chosen ? item.chosen : '(sin respuesta)';
        reviewList.innerHTML += `<div style="margin-bottom:12px">
          <div><strong>Pregunta ${item.index}:</strong> ${escapeHtml(item.q)}</div>
          <div class="small">Tu respuesta: <strong>${escapeHtml(chosenText)}</strong></div>
          ${choicesHtml}
        </div>`;
      });
    } else {
      reviewArea.classList.add('hide');
    }
  }

  restartBtn.addEventListener('click',()=>{
    if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
    startScreen.classList.remove('hide');
    quizScreen.classList.add('hide');
    resultScreen.classList.add('hide');
  });

  startBtn.addEventListener('click', startQuiz);
  </script>
</body>
</html>
