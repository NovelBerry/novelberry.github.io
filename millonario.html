<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- FIREBASE MODULE: Inicializa la base de datos y llama a window.initGame -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración global (usa las variables del entorno Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;

        /**
         * Llama a la función de inicio principal del juego solo una vez.
         * ESTA FUNCIÓN AHORA SE LLAMA LO ANTES POSIBLE PARA DIBUJAR LA UI.
         */
        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            if (typeof window.initGame === 'function') {
                window.initGame(); 
                console.log("--- INICIO DE UI GARANTIZADO ---");
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        /**
         * Intenta la autenticación (preferido) y luego inicializa.
         */
        async function attemptAuthAndInit() {
            if (isGameInitialized) return; 
            
            try {
                if (initialAuthToken) {
                    await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await window.firebase.auth.signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Error en autenticación Firebase, iniciando en modo local:", error);
            }
            handleInitGame();
        }

        // 2. Observador de estado de autenticación
        window.auth.onAuthStateChanged((user) => {
             if (user) {
                attemptAuthAndInit();
             } else if (!isGameInitialized) {
                 attemptAuthAndInit();
             }
        });

        // 3. Fallback de tiempo (si la carga de Firebase es muy rápida, podemos inicializar inmediatamente)
        setTimeout(() => {
            if (!isGameInitialized) {
                handleInitGame(); 
            }
        }, 100); // 100ms es un buen compromiso para no esperar demasiado.
    </script>

    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        :root {
            --color-fondo-oscuro: #121212;
            --color-texto-claro: #f0f0f0;
            --color-acento-celeste: #00bcd4; 
            --color-secundario: #6495ed; 
            --color-exito: #388e3c; 
            --color-advertencia: #d32f2f; 
            --color-empresa: #ffc107; 
            --color-inversion: #9c27b0; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            transition: color 0.2s, background-color 0.2s; 
        }

        html, body {
            width: 100%;
            min-height: 100vh;
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            overflow-x: hidden; 
        }

        #fondo-decoracion {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#1e1e1e 1px, transparent 0);
            background-size: 20px 20px;
            opacity: 0.2; 
            z-index: -1;
        }

        /* --- BARRA DE NAVEGACIÓN --- */
        #nav-bar {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 20px;
            background-color: #0d0d0d;
            border-bottom: 3px solid var(--color-acento-celeste);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            z-index: 50; 
        }

        #nav-bar button {
            padding: 10px 15px;
            border: 2px solid var(--color-secundario);
            background-color: #1a1a1a;
            color: var(--color-texto-claro);
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            flex-grow: 1;
            max-width: 150px;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #nav-bar button:hover {
            background-color: var(--color-secundario);
            color: var(--color-fondo-oscuro);
            box-shadow: 0 0 10px var(--color-secundario);
        }

        #nav-bar button.active {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-acento-celeste);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.8);
        }

        /* --- CONTENEDORES DE VISTAS Y LAYOUT --- */
        #game-view-container {
            padding-top: 20px; 
            min-height: calc(100vh - 60px); 
        }

        .game-view {
            padding: 20px;
            display: none; 
        }
        
        .game-view.active {
            display: block;
        }

        .view-title {
            text-align: center;
            color: var(--color-acento-celeste);
            font-size: 2.2em;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 188, 212, 0.3);
            padding-bottom: 10px;
        }
        
        .grid-3-cols {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .asset-section, .company-section, .investment-section {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--color-secundario);
            box-shadow: 0 0 15px rgba(100, 149, 237, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .company-section { border-color: var(--color-empresa); }
        .investment-section { border-color: var(--color-inversion); }

        .asset-section h2, .company-section h2, .investment-section h2 {
            color: var(--color-secundario);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(100, 149, 237, 0.5);
            text-align: center;
            font-size: 1.5em;
        }
        
        .company-section h2 { color: var(--color-empresa); }
        .investment-section h2 { color: var(--color-inversion); }


        /* --- LAYOUT PRINCIPAL CLICKER (3 Columnas) --- */
        #main-game-layout {
            display: grid;
            grid-template-columns: 250px auto 250px; 
            width: 100%;
            min-height: 100vh;
            max-width: 1400px; 
            margin: 0 auto;
        }

        /* --- ESTILOS DEL PANEL LATERAL (Tienda/Mejoras) --- */
        .side-panel {
            background-color: #1e1e1e;
            border-right: 2px solid var(--color-acento-celeste);
            padding: 10px 5px;
            overflow-y: auto; 
            height: 100%;
            min-height: 100vh;
        }

        #generadores-panel {
            border-right: none;
            border-left: 2px solid var(--color-acento-celeste);
            grid-column: 3;
        }

        .side-panel h2 {
            text-align: center;
            color: var(--color-secundario); 
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(100, 149, 237, 0.5);
            padding-bottom: 5px;
            font-size: 1.3em;
            position: sticky;
            top: 0; 
            background-color: #1e1e1e;
            z-index: 10;
        }

        /* Estilo de cada elemento de tienda */
        .tienda-item {
            border: 1px solid #333;
            background-color: #242424; 
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.1s, opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .tienda-item:hover {
            background-color: #2e2e2e;
        }

        .item-bloqueado {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #1a1a1a !important;
            border: 1px dashed #555;
            transform: scale(0.98);
        }

        .item-comprado {
            border: 2px solid var(--color-exito); 
            background-color: #2e3d30;
            opacity: 0.8;
            cursor: default !important;
        }
        
        .item-comprado button {
            cursor: default !important;
        }

        /* --- ÁREA CENTRAL CLICKER --- */
        #clicker-area {
            padding: 20px;
            text-align: center;
            grid-column: 2; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
        }

        /* Sección de Información */
        #info-dinero {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid var(--color-acento-celeste);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
            min-width: 300px;
        }

        #info-dinero p {
            font-size: 1.4em;
            font-weight: 700;
            margin: 5px 0;
        }

        #info-dinero span {
            color: var(--color-secundario);
            font-weight: 900;
        }

        /* Botón de Clic */
        #billete-btn {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background-color: var(--color-exito);
            color: var(--color-texto-claro);
            font-size: 1.5em;
            cursor: pointer;
            border: 10px solid #2e7d32;
            box-shadow: 0 0 35px rgba(56, 142, 60, 0.9);
            transition: transform 0.1s, box-shadow 0.3s;
            outline: none;
            margin-top: 50px;
            font-weight: 900;
        }

        #billete-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 15px rgba(56, 142, 60, 1);
        }

        .emoji-billete {
            display: block;
            font-size: 6em; 
        }

        /* Botones generales */
        .tienda-item button {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            font-weight: 700;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            font-size: 0.9em;
            transition: background-color 0.1s;
        }
        
        .tienda-item button:hover:not(:disabled) {
            background-color: #00e5ff;
        }

        .tienda-item button:disabled {
            background-color: #444; 
            color: #888;
            cursor: not-allowed;
            opacity: 0.9;
        }

        /* Animación de Clic */
        @keyframes floatAndFade {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -80px); opacity: 0; }
        }

        .animacion-clic {
            position: absolute;
            font-size: 2em;
            font-weight: 900;
            color: #ffd700; 
            text-shadow: 0 0 5px #ff8c00;
            pointer-events: none; 
            animation: floatAndFade 0.8s ease-out;
            z-index: 1000; 
        }
        
        /* Contenedores de Activos, Empresas, Inversiones */
        .asset-shop, .company-shop, .investment-shop {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 5px 0;
            overflow-y: auto;
        }
        
        /* Reiniciar Juego */
        #reset-btn {
            background-color: var(--color-advertencia);
            color: var(--color-texto-claro);
            padding: 10px;
            border: 2px solid var(--color-advertencia);
            border-radius: 6px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s;
            font-weight: 700;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        #reset-btn:hover {
            background-color: #ff5252;
        }
        
        /* Mensaje de Usuario */
        #user-info-footer {
            text-align: center;
            font-size: 0.8em; 
            color: #888;
            padding: 10px;
        }


        /* ================================================== */
        /* --- MEDIA QUERIES (RESPONSIVENESS) --- */
        /* ================================================== */

        @media (max-width: 900px) {
            /* ... Estilos de Media Query ... */
            #nav-bar {
                gap: 5px;
                flex-wrap: wrap; 
            }
            #nav-bar button {
                flex-grow: 1; 
                padding: 8px 10px;
                font-size: 0.8em;
                max-width: none;
            }
            
            #main-game-layout {
                grid-template-columns: 1fr;
                padding-top: 0;
            }

            #clicker-area {
                grid-row: 1;
                padding-top: 10px;
            }

            #mejoras-clic-panel {
                grid-row: 2;
                border-right: none;
                border-bottom: 2px solid var(--color-acento-celeste);
            }
            
            #generadores-panel {
                grid-column: 1;
                grid-row: 3;
                border-left: none;
                border-top: 2px solid var(--color-acento-celeste);
            }

            .side-panel {
                height: auto; 
                position: static;
                padding: 10px;
            }
            
            #mejoras-clic-tienda, #generadores-tienda {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                gap: 10px;
            }

            .tienda-item {
                width: 47%; 
                margin: 5px 0;
            }
            
            #billete-btn {
                width: 200px;
                height: 200px;
                margin-top: 20px;
            }

            .grid-3-cols {
                grid-template-columns: 1fr; 
                max-width: 90%;
            }
            
            .asset-shop, .company-shop, .investment-shop {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
            }
            
            .asset-shop .tienda-item, .company-shop .tienda-item, .investment-shop .tienda-item {
                width: 47%; 
            }
        }
    </style>
</head>
<body>
    <div id="fondo-decoracion"></div>

    <div id="nav-bar">
        <button id="nav-clicker" onclick="cambiarVista('clicker')" class="active"><i class="fas fa-hand-pointer"></i> Clic & Negocios</button>
        <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-car"></i> Activos & Lujos</button>
        <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Mis Empresas</button>
        <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
        <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-pie"></i> Estadísticas</button>
    </div>

    <div id="game-view-container">

        <!-- ================================================== -->
        <!-- VISTA 1: CLICKER & NEGOCIOS -->
        <!-- ================================================== -->
        <div id="view-clicker" class="game-view active">
            <div id="main-game-layout">

                <!-- Panel Izquierdo: Mejoras de Clic -->
                <div id="mejoras-clic-panel" class="side-panel">
                    <h2>Mejoras de Clic (IPC)</h2>
                    <div id="mejoras-clic-tienda">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>

                <!-- Área Central: Botón Clicker & Info -->
                <div id="clicker-area">
                    <h1 style="margin-top: 0;">¡Conviértete en Millonario!</h1>
                    
                    <div id="info-dinero">
                        <p>DINERO: <span id="dinero-actual">$0.00</span></p>
                        <p>IPC (por Clic): <span id="ipc-actual">$1.00</span></p>
                        <p>IPS (por Segundo): <span id="ips-actual">$0.00</span></p>
                    </div>

                    <button id="billete-btn" onclick="hacerClic()">
                        <span class="emoji-billete">💵</span>
                        <br>HACER CLIC
                    </button>
                    
                </div>

                <!-- Panel Derecho: Generadores Pasivos -->
                <div id="generadores-panel" class="side-panel">
                    <h2>Generadores Pasivos (IPS)</h2>
                    <div id="generadores-tienda">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 2: ACTIVOS Y LUJOS -->
        <!-- ================================================== -->
        <div id="view-assets" class="game-view">
            <h1 class="view-title" style="color:var(--color-secundario);">Activos, Lujos y Capital</h1>
            <div class="grid-3-cols">
                
                <div class="asset-section">
                    <h2>Vehículos (Lujos)</h2>
                    <div id="tienda-vehiculos" class="asset-shop">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>

                <div class="asset-section">
                    <h2>Propiedades (Lujos)</h2>
                    <div id="tienda-propiedades" class="asset-shop">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>

                <div class="asset-section">
                    <h2>Inversión Bursátil (Acciones)</h2>
                    <div id="tienda-acciones" class="asset-shop">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 3: EMPRESAS PROPIAS -->
        <!-- ================================================== -->
        <div id="view-companies" class="game-view">
            <h1 class="view-title" style="color:var(--color-empresa);">Crea tu Propia Empresa</h1>
            <div id="companies-grid" class="grid-3-cols">
                
                <div class="company-section" style="grid-column: 1 / span 3;">
                    <h2>Oportunidades de Negocio (Comprar Unidades)</h2>
                    <div id="tienda-empresas" class="company-shop">
                        <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>
                
                <div class="company-section" style="grid-column: 1 / span 3;">
                    <h2>Mis Empresas Activas (Estadísticas)</h2>
                    <div id="empresas-activas" class="company-shop" style="display: flex; flex-wrap: wrap;">
                        <p style="text-align: center; color: #999; width: 100%;">Compra tu primera empresa para ver sus estadísticas.</p>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 4: INVERSIONES EXTERNAS -->
        <!-- ================================================== -->
        <div id="view-investments" class="game-view">
            <h1 class="view-title" style="color:var(--color-inversion);">Invierte en el Mercado de Capitales</h1>
            <div class="grid-3-cols">
                
                <div class="investment-section" style="grid-column: 1 / span 3;">
                    <h2>Fondos de Inversión Fija (Binario)</h2>
                    <div id="tienda-inversiones" class="investment-shop">
                         <!-- El JS poblará esto INSTANTÁNEAMENTE al iniciar -->
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 5: ESTADÍSTICAS -->
        <!-- ================================================== -->
        <div id="view-stats" class="game-view">
            <h1 class="view-title">Tu Perfil de Riqueza</h1>
            <div id="stats-content">
                <p style="text-align:center; color:var(--color-acento-celeste);">Cargando estadísticas...</p>
            </div>
             <button id="reset-btn" onclick="mostrarConfirmacionReset()">
                <i class="fas fa-redo-alt"></i> REINICIAR EL JUEGO (PERDERÁS TODO)
            </button>
            <div id="user-info-footer">
                ID de Usuario: <span id="user-id-display">Cargando...</span> | ¡Guarda tu progreso automáticamente!
            </div>
            
            <!-- Modal simple de confirmación (alternativa a alert/confirm) -->
            <div id="reset-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: #222; padding: 30px; border-radius: 10px; border: 2px solid var(--color-advertencia); text-align: center; max-width: 400px;">
                    <h3 style="color: var(--color-advertencia); margin-bottom: 20px;">ATENCIÓN: REINICIO DE JUEGO</h3>
                    <p style="margin-bottom: 20px;">¿Estás absolutamente seguro de que quieres reiniciar? Esta acción es irreversible y perderás todo tu dinero y activos.</p>
                    <button onclick="resetearJuego(); document.getElementById('reset-modal').style.display = 'none';" style="background-color: var(--color-advertencia); color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
                        Sí, REINICIAR
                    </button>
                    <button onclick="document.getElementById('reset-modal').style.display = 'none';" style="background-color: #444; color: white; padding: 10px 20px; border: none; border-radius: 4px;">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =========================================================================
        // 1. ESTADO GLOBAL Y DEFINICIONES DE ITEMS
        // =========================================================================

        let estadoJuego = {
            dineroActual: 0,
            ipc: 1, 
            ips: 0, 
            conteoClicks: 0,
            totalGanado: 0,
            
            // Almacenamiento de items comprados
            generadores: {}, 
            mejoras: {},     
            propiedades: {}, 
            acciones: {},    
            empresas: {},    
        };

        const formatMoneda = new Intl.NumberFormat('es-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        });

        // --- Catálogos de Items ---
        const ITEMS_IPC = [];
        for (let i = 1; i <= 40; i++) {
            const costoBase = 50;
            const factorCosto = 1.6;
            const costo = Math.round(costoBase * Math.pow(factorCosto, i));
            const multiplicador = 2; 
            ITEMS_IPC.push({ id: `mejora_ipc_${i}`, nombre: `Eficiencia de Clic Nivel ${i}`, costo: costo, multiplicador_ipc: multiplicador, descripcion: `Duplica el ingreso base de tu clic.` });
        }

        const ITEMS_IPS = [
            { id: 'puesto_limonada', nombre: 'Puesto de Limonada', costo: 100, ips_base: 0.1, factor: 1.15, descripcion: 'Genera $0.10 por segundo.' },
            { id: 'vendedor_ambulante', nombre: 'Vendedor Ambulante', costo: 1100, ips_base: 1, factor: 1.15, descripcion: 'Genera $1 por segundo.' },
            { id: 'tienda_online', nombre: 'Tienda Online', costo: 12000, ips_base: 8, factor: 1.15, descripcion: 'Genera $8 por segundo.' },
            { id: 'bienes_raices_peq', nombre: 'Agencia de Bienes Raíces', costo: 150000, ips_base: 50, factor: 1.15, descripcion: 'Genera $50 por segundo.' },
            { id: 'granja_servidores', nombre: 'Granja de Servidores 🖥️', costo: 1800000, ips_base: 400, factor: 1.17, descripcion: 'Ingreso constante por procesamiento de datos.' },
            { id: 'planta_solar', nombre: 'Planta de Energía Solar ☀️', costo: 25000000, ips_base: 3000, factor: 1.18, descripcion: 'Venta de energía renovable a la red.' },
        ];
        
        const ITEMS_ACTIVOS = [
            { id: 'auto_deportivo', nombre: 'Auto Deportivo 🏎️', costo: 1000000, tipo: 'vehiculo', ips_fijo: 100, descripcion: 'Lujo. Aumenta tu IPS en $100.' },
            { id: 'yate_lujo', nombre: 'Yate de Lujo 🛥️', costo: 4000000, tipo: 'vehiculo', ips_fijo: 300, descripcion: 'Lujo. Aumenta tu IPS en $300.' },
            { id: 'apartamento_lujo', nombre: 'Apartamento de Lujo 🏙️', costo: 2000000, tipo: 'propiedad', ips_fijo: 200, descripcion: 'Propiedad. Aumenta tu IPS en $200.' },
            { id: 'mansion_lujo', nombre: 'Mansión de Lujo 🏰', costo: 5000000, tipo: 'propiedad', ips_fijo: 500, descripcion: 'Propiedad. Aumenta tu IPS en $500.' },
            
            { id: 'acciones_bluechip', nombre: 'Acciones Blue Chip 📊', costo: 100000, tipo: 'accion', ips_por_unidad: 5, factor: 1.2, descripcion: 'Inversión estable. Genera $5 IPS por unidad.', factor: 1.2 },
            { id: 'techcorp_stock', nombre: 'Acciones TechCorp (TC) 💻', costo: 800000, tipo: 'accion', ips_por_unidad: 45, factor: 1.3, descripcion: 'Gigante tecnológico. Genera $45 IPS por unidad.', factor: 1.3 },
        ];
        
        const ITEMS_COMPANIES = [
            { id: 'stand_comida', nombre: 'Food Truck (Comida)', costo: 10000, ips_por_unidad: 5, factor: 1.2, descripcion: 'Pequeño negocio de comida callejera.' },
            { id: 'consultoria_it', nombre: 'Consultoría IT', costo: 150000, ips_por_unidad: 40, factor: 1.3, descripcion: 'Servicios de desarrollo de software.' },
            { id: 'produccion_cine', nombre: 'Estudio de Producción 🎬', costo: 1000000, ips_por_unidad: 200, factor: 1.4, descripcion: 'Crea contenido de entretenimiento digital.' },
        ];

        const ITEMS_INVESTMENTS = [
            { id: 'fondo_riesgo', nombre: 'Fondo de Alto Riesgo 🚨', costo: 25000, tipo: 'inversion', ips_fijo: 10, descripcion: 'Alto retorno, alto riesgo (IPS fijo).' },
            { id: 'bonos_estado', nombre: 'Bonos del Estado 🛡️', costo: 500000, tipo: 'inversion', ips_fijo: 100, descripcion: 'Inversión segura con rendimiento estable.' },
        ];
        
        // Catálogo unificado para búsqueda rápida
        const ALL_ITEMS = [...ITEMS_IPC, ...ITEMS_IPS, ...ITEMS_ACTIVOS, ...ITEMS_COMPANIES, ...ITEMS_INVESTMENTS];


        // =========================================================================
        // 2. FUNCIONES CORE DEL JUEGO
        // =========================================================================

        /**
         * Calcula el costo del siguiente nivel de un ítem.
         */
        function calcularCosto(item, cantidad) {
            // Si tiene factor (escalable), usa progresión geométrica.
            if (item.factor) {
                // El costo se redondea para evitar números decimales en los precios
                return Math.round(item.costo * Math.pow(item.factor, cantidad));
            }
            // Si es binario (compra única), devuelve el costo base.
            return item.costo;
        }

        /**
         * Lógica del click principal.
         */
        function hacerClic() {
            const ipc_actual = calcularIPC();
            
            estadoJuego.dineroActual += ipc_actual;
            estadoJuego.conteoClicks++;
            estadoJuego.totalGanado += ipc_actual;

            crearAnimacionClic(formatMoneda.format(ipc_actual));

            actualizarDisplay();
            actualizarBotones(); 
            guardarJuego();
        }

        /**
         * Lógica para comprar cualquier ítem.
         */
        function comprarItem(tipo, id) {
            const item = ALL_ITEMS.find(i => i.id === id);
            if (!item) {
                console.error("Item no encontrado:", id);
                return;
            }

            let almacenamiento;
            let esBinario = false;

            if (item.id.startsWith('mejora_ipc')) {
                almacenamiento = estadoJuego.mejoras;
                esBinario = true;
            } else if (ITEMS_IPS.includes(item)) {
                almacenamiento = estadoJuego.generadores;
            } else if (item.tipo === 'accion') {
                almacenamiento = estadoJuego.acciones;
            } else if (item.tipo === 'empresa') {
                almacenamiento = estadoJuego.empresas;
            } else if (['vehiculo', 'propiedad', 'inversion'].includes(item.tipo)) {
                almacenamiento = estadoJuego.propiedades;
                esBinario = true;
            }
            
            const cantidadActual = esBinario ? (almacenamiento[id] ? 1 : 0) : (almacenamiento[id] || 0);
            const costo = calcularCosto(item, cantidadActual);

            // 1. Check de binario: Ya comprado
            if (esBinario && cantidadActual > 0) return; 

            // 2. Check de dinero
            if (estadoJuego.dineroActual < costo) {
                console.warn("Dinero insuficiente para comprar:", item.nombre);
                return;
            }
            
            estadoJuego.dineroActual -= costo;

            // 3. Actualizar almacenamiento
            if (esBinario) {
                almacenamiento[id] = true; 
            } else {
                almacenamiento[id] = (almacenamiento[id] || 0) + 1;
            }
            
            // 4. Actualizar juego
            recalcularIPS();
            actualizarDisplay();
            
            // Redibujar solo la sección afectada
            if (item.id.startsWith('mejora_ipc')) dibujarTiendaIPC();
            else if (ITEMS_IPS.includes(item)) dibujarTiendaIPS();
            else if (item.tipo === 'accion' || item.tipo === 'vehiculo' || item.tipo === 'propiedad') dibujarTiendaActivos();
            else if (item.tipo === 'empresa') dibujarTiendaEmpresas();
            else if (item.tipo === 'inversion') dibujarTiendaInversiones();

            actualizarBotones(); 
            guardarJuego();
        }

        function calcularIPC() {
            let ipc_base = 1;
            
            ITEMS_IPC.forEach(item => {
                if (estadoJuego.mejoras[item.id]) {
                    ipc_base *= item.multiplicador_ipc; 
                }
            });
            // El IPC siempre debe ser un número entero (o con un decimal para evitar errores de coma flotante)
            return Math.round(ipc_base * 100) / 100 || 1; 
        }

        function recalcularIPS() {
            let ips_total = 0;
            
            // --- 1. Generadores Pasivos (IPS) ---
            ITEMS_IPS.forEach(item => {
                const cantidad = estadoJuego.generadores[item.id] || 0;
                ips_total += cantidad * item.ips_base;
            });
            
            // --- 2. Acciones y Empresas (Escalables) ---
            const escalables = [...ITEMS_ACTIVOS.filter(i => i.tipo === 'accion'), ...ITEMS_COMPANIES];
            escalables.forEach(item => {
                const almacenamiento = item.tipo === 'accion' ? estadoJuego.acciones : estadoJuego.empresas;
                const cantidad = almacenamiento[item.id] || 0;
                ips_total += cantidad * item.ips_por_unidad;
            });

            // --- 3. Activos Binarios (Propiedades, Vehículos, Inversiones Fijas) ---
            const binarios = [...ITEMS_ACTIVOS.filter(i => i.tipo !== 'accion'), ...ITEMS_INVESTMENTS];
            binarios.forEach(item => {
                if (estadoJuego.propiedades[item.id]) {
                    ips_total += item.ips_fijo;
                }
            });

            estadoJuego.ips = Math.round(ips_total * 100) / 100;
        }

        // =========================================================================
        // 3. FUNCIONES DE UI Y RENDERIZADO
        // =========================================================================

        function actualizarDisplay() {
            document.getElementById('dinero-actual').textContent = formatMoneda.format(estadoJuego.dineroActual);
            document.getElementById('ipc-actual').textContent = formatMoneda.format(calcularIPC());
            document.getElementById('ips-actual').textContent = formatMoneda.format(estadoJuego.ips);

            // Actualizar vistas secundarias si están activas
            if (document.getElementById('view-stats')?.classList.contains('active')) {
                dibujarEstadisticas();
            }
            if (document.getElementById('view-companies')?.classList.contains('active')) {
                dibujarEmpresasActivas();
            }
        }

        function dibujarTiendaIPC() {
            const contenedor = document.getElementById('mejoras-clic-tienda');
            contenedor.innerHTML = ''; 
            let mejorasPendientes = false;
            
            ITEMS_IPC.forEach(item => {
                const yaComprado = estadoJuego.mejoras[item.id];
                
                if (yaComprado) return; 
                
                mejorasPendientes = true;
                const costo = calcularCosto(item, 0);

                const itemDiv = document.createElement('div');
                itemDiv.className = 'tienda-item';
                itemDiv.setAttribute('data-costo', costo);
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre}</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">${item.descripcion}</p>
                    <p style="color:#ffd700; font-weight:700;">Costo: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('ipc_mejora', '${item.id}')">
                        COMPRAR
                    </button>
                `;
                contenedor.appendChild(itemDiv);
            });
            
            if (!mejorasPendientes) {
                 contenedor.innerHTML = '<p style="text-align: center; color: #999;">Todas las mejoras de IPC han sido adquiridas.</p>';
            }
        }

        function dibujarTiendaIPS() {
            const contenedor = document.getElementById('generadores-tienda');
            contenedor.innerHTML = ''; 

            ITEMS_IPS.forEach(item => {
                const cantidad = estadoJuego.generadores[item.id] || 0;
                const costo = calcularCosto(item, cantidad);
                const ipsTotal = (cantidad * item.ips_base).toFixed(2);

                const itemDiv = document.createElement('div');
                itemDiv.className = 'tienda-item';
                itemDiv.setAttribute('data-costo', costo); 
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre} (x${cantidad})</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">IPS/Unidad: ${formatMoneda.format(item.ips_base)} | Total: ${formatMoneda.format(ipsTotal)}</p>
                    <p style="color:#ffd700; font-weight:700;">Costo Siguiente: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('ips', '${item.id}')">
                        COMPRAR
                    </button>
                `;
                contenedor.appendChild(itemDiv);
            });
        }

        function dibujarTiendaActivos() {
            const contVehiculos = document.getElementById('tienda-vehiculos');
            const contPropiedades = document.getElementById('tienda-propiedades');
            const contAcciones = document.getElementById('tienda-acciones');
            
            contVehiculos.innerHTML = '';
            contPropiedades.innerHTML = '';
            contAcciones.innerHTML = '';

            // Activos Binarios (Vehículos y Propiedades)
            ITEMS_ACTIVOS.filter(i => i.tipo !== 'accion').forEach(item => {
                const yaComprado = estadoJuego.propiedades[item.id];
                const contenedorObjetivo = item.tipo === 'vehiculo' ? contVehiculos : contPropiedades;
                const costo = item.costo;

                const itemDiv = document.createElement('div');
                itemDiv.className = `tienda-item ${yaComprado ? 'item-comprado' : ''}`;
                itemDiv.setAttribute('data-costo', costo);
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre}</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">${item.descripcion}</p>
                    <p>IPS Fijo: ${formatMoneda.format(item.ips_fijo)}</p>
                    <p style="color:#ffd700; font-weight:700;">Costo: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('${item.tipo}', '${item.id}')" ${yaComprado ? 'disabled' : ''}>
                        ${yaComprado ? 'ADQUIRIDO ✅' : 'COMPRAR'}
                    </button>
                `;
                contenedorObjetivo.appendChild(itemDiv);
            });

            // Acciones (Escalables)
            ITEMS_ACTIVOS.filter(i => i.tipo === 'accion').forEach(item => {
                const cantidad = estadoJuego.acciones[item.id] || 0;
                const costo = calcularCosto(item, cantidad);
                const ipsTotal = cantidad * item.ips_por_unidad;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'tienda-item';
                itemDiv.setAttribute('data-costo', costo);
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre} (x${cantidad})</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">Genera ${formatMoneda.format(item.ips_por_unidad)} IPS por unidad.</p>
                    <p>IPS Total: <span style="font-weight:700; color:#ffd700;">${formatMoneda.format(ipsTotal)}</span></p>
                    <p style="color:var(--color-secundario); font-weight:700;">Costo Siguiente: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('${item.tipo}', '${item.id}')">
                        COMPRAR ACCIÓN
                    </button>
                `;
                contAcciones.appendChild(itemDiv);
            });
        }
        
        function dibujarTiendaEmpresas() {
            const contenedor = document.getElementById('tienda-empresas');
            contenedor.innerHTML = ''; 

            ITEMS_COMPANIES.forEach(item => {
                const cantidad = estadoJuego.empresas[item.id] || 0;
                const costo = calcularCosto(item, cantidad);
                const ipsTotal = cantidad * item.ips_por_unidad;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'tienda-item';
                itemDiv.setAttribute('data-costo', costo); 
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre} (Unidades: ${cantidad})</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">IPS/Unidad: ${formatMoneda.format(item.ips_por_unidad)} | Total IPS: ${formatMoneda.format(ipsTotal)}</p>
                    <p style="color:var(--color-empresa); font-weight:700;">Costo Siguiente: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('empresa', '${item.id}')">
                        CONSTRUIR UNIDAD
                    </button>
                `;
                contenedor.appendChild(itemDiv);
            });
            dibujarEmpresasActivas();
        }

        function dibujarEmpresasActivas() {
            const contenedor = document.getElementById('empresas-activas');
            contenedor.innerHTML = '';
            let tieneEmpresas = false;

            ITEMS_COMPANIES.forEach(item => {
                const cantidad = estadoJuego.empresas[item.id] || 0;
                if (cantidad > 0) {
                    tieneEmpresas = true;
                    const ipsTotal = cantidad * item.ips_por_unidad;

                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'tienda-item';
                    statsDiv.style.border = '2px solid var(--color-empresa)';
                    statsDiv.innerHTML = `
                        <p><strong>${item.nombre}</strong></p>
                        <p>Unidades Activas: <span style="font-weight:700; color:var(--color-empresa);">${cantidad}</span></p>
                        <p>IPS Total: <span style="font-weight:700; color:#ffd700;">${formatMoneda.format(ipsTotal)}</span></p>
                        <p style="font-size:0.8em; margin-top:5px; color:#ccc;">${item.descripcion}</p>
                    `;
                    contenedor.appendChild(statsDiv);
                }
            });

            if (!tieneEmpresas) {
                contenedor.innerHTML = '<p style="text-align: center; color: #999; width: 100%;">Compra tu primera empresa para ver sus estadísticas.</p>';
            }
        }
        
        function dibujarTiendaInversiones() {
            const contenedor = document.getElementById('tienda-inversiones');
            contenedor.innerHTML = ''; 

            ITEMS_INVESTMENTS.forEach(item => {
                const yaComprado = estadoJuego.propiedades[item.id];
                const costo = item.costo; 

                const itemDiv = document.createElement('div');
                itemDiv.className = `tienda-item ${yaComprado ? 'item-comprado' : ''}`;
                itemDiv.setAttribute('data-costo', costo);
                itemDiv.innerHTML = `
                    <p><strong>${item.nombre}</strong></p>
                    <p style="font-size:0.8em; margin-top:5px;">${item.descripcion}</p>
                    <p>Rentabilidad: <span style="font-weight:700; color:#ffd700;">${formatMoneda.format(item.ips_fijo)} IPS</span></p>
                    <p style="color:var(--color-inversion); font-weight:700;">Costo: ${formatMoneda.format(costo)}</p>
                    <button id="btn-${item.id}" onclick="comprarItem('${item.tipo}', '${item.id}')" ${yaComprado ? 'disabled' : ''}>
                        ${yaComprado ? 'INVERTIDO' : 'INVERTIR'}
                    </button>
                `;
                contenedor.appendChild(itemDiv);
            });
        }


        /**
         * Actualiza los botones de compra (habilitar/deshabilitar y bloqueo visual)
         */
        function actualizarBotones() {
            const botones = document.querySelectorAll('.tienda-item button'); 
            
            botones.forEach(button => {
                const itemDiv = button.closest('.tienda-item');
                if (!itemDiv) return;
                
                // Si ya fue comprado (binario), se mantiene deshabilitado.
                if (itemDiv.classList.contains('item-comprado')) {
                     button.disabled = true;
                     return; 
                }
                
                const costoAttr = itemDiv.getAttribute('data-costo');
                if (!costoAttr) return; 
                
                const costo = parseFloat(costoAttr);
                
                if (estadoJuego.dineroActual >= costo) {
                    button.disabled = false;
                    itemDiv.classList.remove('item-bloqueado');
                } else {
                    button.disabled = true;
                    itemDiv.classList.add('item-bloqueado');
                }
            });
        }

        function dibujarEstadisticas() {
            const contenedor = document.getElementById('stats-content');
            if (!contenedor) return;
            
            recalcularIPS();

            let inventarioHTML = '<h3 style="color: var(--color-empresa); border-bottom: 1px dashed #333; padding-bottom: 5px;">Resumen de Inventario Activo</h3><ul style="list-style-type: none; padding-left: 0;">';
            let inventarioVacio = true;

            // Mostrar todas las mejoras, generadores, etc.
            ALL_ITEMS.forEach(item => {
                let cantidad = 0;
                let ipsTotal = 0;
                let simbolo = '❓';

                if (item.id.startsWith('mejora_ipc') && estadoJuego.mejoras[item.id]) {
                    cantidad = 1;
                    simbolo = '✅';
                    ipsTotal = 0; // El IPC no suma IPS
                } else if (ITEMS_IPS.includes(item)) {
                    cantidad = estadoJuego.generadores[item.id] || 0;
                    simbolo = '⚙️';
                    ipsTotal = cantidad * item.ips_base;
                } else if (item.tipo === 'accion') {
                    cantidad = estadoJuego.acciones[item.id] || 0;
                    simbolo = '📊';
                    ipsTotal = cantidad * item.ips_por_unidad;
                } else if (item.tipo === 'empresa') {
                    cantidad = estadoJuego.empresas[item.id] || 0;
                    simbolo = '🏢';
                    ipsTotal = cantidad * item.ips_por_unidad;
                } else if (['vehiculo', 'propiedad', 'inversion'].includes(item.tipo) && estadoJuego.propiedades[item.id]) {
                    cantidad = 1;
                    simbolo = item.tipo === 'vehiculo' ? '🚗' : item.tipo === 'propiedad' ? '🏡' : '📈';
                    ipsTotal = item.ips_fijo;
                }

                if (cantidad > 0) {
                    inventarioVacio = false;
                    const ipsText = ipsTotal > 0 ? `| IPS: ${formatMoneda.format(ipsTotal)}` : '(IPC)';
                    inventarioHTML += `<li style="margin-bottom: 5px; background: #222; padding: 5px; border-radius: 4px;">${simbolo} ${item.nombre} (x${cantidad > 1 ? cantidad : ''}) ${ipsText}</li>`;
                }
            });
            
            if (inventarioVacio) {
                inventarioHTML += '<li>No has adquirido ningún activo o mejora aún.</li>';
            }
            
            inventarioHTML += '</ul>';

            contenedor.innerHTML = `
                <div class="stats-panel" style="background: #1e1e1e; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--color-acento-celeste);">
                    <h3>Estadísticas de Capital</h3>
                    <p><strong>Dinero Actual:</strong> <span style="color: var(--color-exito);">${formatMoneda.format(estadoJuego.dineroActual)}</span></p>
                    <p><strong>Dinero Total Ganado:</strong> ${formatMoneda.format(estadoJuego.totalGanado)}</p>
                    <p><strong>Número de Clics:</strong> ${estadoJuego.conteoClicks}</p>
                    <p><strong>Ingreso por Clic (IPC):</strong> <span style="color: var(--color-exito);">${formatMoneda.format(calcularIPC())}</span></p>
                    <p><strong>Ingreso por Segundo (IPS):</strong> <span style="color: var(--color-secundario);">${formatMoneda.format(estadoJuego.ips)}</span></p>
                </div>
                <div class="stats-panel" style="background: #1e1e1e; padding: 20px; border-radius: 10px; border: 2px solid var(--color-empresa);">
                    ${inventarioHTML}
                </div>
            `;
        }

        function crearAnimacionClic(texto) {
            const billeteBtn = document.getElementById('billete-btn');
            const anim = document.createElement('div');
            anim.textContent = texto;
            anim.className = 'animacion-clic';
            
            const rect = billeteBtn.getBoundingClientRect();
            // Posicionar justo encima del botón
            anim.style.left = `${rect.left + rect.width / 2}px`;
            anim.style.top = `${rect.top + rect.height / 2}px`;
            
            document.body.appendChild(anim);

            setTimeout(() => {
                anim.remove();
            }, 800);
        }

        function mostrarConfirmacionReset() {
             document.getElementById('reset-modal').style.display = 'flex';
        }

        // =========================================================================
        // 4. GESTIÓN DE VISTAS Y ESTADO PERSISTENTE (FIREBASE)
        // =========================================================================

        function cambiarVista(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.style.display = 'none';
                view.classList.remove('active');
            });
            document.querySelectorAll('#nav-bar button').forEach(btn => {
                btn.classList.remove('active');
            });

            const vistaElement = document.getElementById(`view-${vista}`);
            const navButton = document.getElementById(`nav-${vista}`);
            
            if (vistaElement) {
                vistaElement.style.display = 'block';
                vistaElement.classList.add('active');
            }
            if (navButton) {
                navButton.classList.add('active');
            }
            
            // Forzar actualización de datos en vistas de contenido
            if (vista === 'stats') dibujarEstadisticas();
            else if (vista === 'companies') { dibujarTiendaEmpresas(); dibujarEmpresasActivas(); }
            else if (vista === 'assets') dibujarTiendaActivos(); 
            else if (vista === 'investments') dibujarTiendaInversiones();

            actualizarBotones();
        }

        function resetearJuego() {
            estadoJuego = {
                dineroActual: 0, ipc: 1, ips: 0, conteoClicks: 0, totalGanado: 0,
                generadores: {}, mejoras: {}, propiedades: {}, acciones: {}, empresas: {},
            };
            
            dibujarTodasLasTiendas(); // Redibujar la UI con el estado inicial
            actualizarDisplay();
            actualizarBotones();
            cambiarVista('clicker');
            guardarJuego(); 
        }

        let db;
        let auth;
        let userId;

        const getDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return window.firebase.firestore.doc(window.db, `/artifacts/${appId}/users/${userId}/clicker_data/game_state`);
        };


        async function guardarJuego() {
            // Guardar solo si Firebase está inicializado y tenemos un ID de usuario
            if (!db || !userId || !auth.currentUser) return;
            try {
                const gameRef = getDocRef();
                // Usamos un clon simple del estado para guardar
                const dataToSave = JSON.parse(JSON.stringify(estadoJuego));
                await window.firebase.firestore.setDoc(gameRef, dataToSave);
            } catch (e) {
                console.error("Error guardando el juego: ", e);
            }
        }

        async function cargarJuego() {
            // Cargar solo si Firebase está inicializado y tenemos un ID de usuario
            if (!db || !userId || !auth.currentUser) {
                console.warn("CargarJuego: Firebase no inicializado. Jugando sin persistencia.");
                actualizarDisplay();
                return;
            }
            try {
                const gameRef = getDocRef();
                const docSnap = await window.firebase.firestore.getDoc(gameRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Asegurar que los campos numéricos se carguen como float
                    data.dineroActual = parseFloat(data.dineroActual || 0);
                    data.conteoClicks = parseInt(data.conteoClicks || 0);
                    data.totalGanado = parseFloat(data.totalGanado || 0);
                    
                    estadoJuego = { ...estadoJuego, ...data };
                    console.log("Juego cargado exitosamente. Progreso recuperado.");
                } else {
                    console.log("No se encontraron datos guardados. Iniciando juego nuevo.");
                }
                
                document.getElementById('user-id-display').textContent = userId;

                // Actualizar la interfaz con los datos cargados
                dibujarTodasLasTiendas(); // Redibuja con las cantidades/costos correctos
                actualizarDisplay();
                actualizarBotones();
                
            } catch (e) {
                console.error("Error cargando el juego: ", e);
                // Si falla la carga, al menos nos aseguramos de que el display se actualice (con el estado base)
                actualizarDisplay(); 
            }
        }

        // =========================================================================
        // 5. INICIALIZACIÓN Y BUCLE DE JUEGO
        // =========================================================================

        function ingresosPasivos() {
            recalcularIPS();
            // Generamos ingreso cada 100ms (10 veces por segundo)
            const ingreso = estadoJuego.ips / 10; 
            estadoJuego.dineroActual += ingreso;
            estadoJuego.totalGanado += ingreso;
            
            actualizarDisplay(); 
            actualizarBotones();
        }

        let saveCounter = 0; 

        function gameLoop() {
            ingresosPasivos();

            // Guardar cada 10 segundos (100 iteraciones * 100ms)
            saveCounter++;
            if (saveCounter >= 100) { 
                guardarJuego();
                saveCounter = 0;
            }

            // Llamada recurrente al bucle
            setTimeout(gameLoop, 100); 
        }

        /**
         * Inicializa el juego (llamada desde el módulo de Firebase).
         */
        window.initGame = function() {
            db = window.db;
            auth = window.auth;
            // Usar el UID si estamos autenticados, si no, usar un ID temporal para modo local
            userId = auth.currentUser?.uid || crypto.randomUUID(); 

            // 1. DIBUJAR INMEDIATAMENTE: Esto garantiza que todos los botones aparecen al instante.
            dibujarTodasLasTiendas(); 
            
            // 2. Iniciar la carga de datos (asíncrona)
            cargarJuego();
            
            // 3. Iniciar el bucle del juego (IPS)
            gameLoop();
        }

        function dibujarTodasLasTiendas() {
            dibujarTiendaIPC();
            dibujarTiendaIPS();
            dibujarTiendaActivos();
            dibujarTiendaEmpresas();
            dibujarTiendaInversiones();
        }
        
        // Exponer funciones necesarias globalmente
        window.hacerClic = hacerClic;
        window.comprarItem = comprarItem;
        window.cambiarVista = cambiarVista;
        window.resetearJuego = resetearJuego;
        window.mostrarConfirmacionReset = mostrarConfirmacionReset;
    </script>
</body>
</html>
