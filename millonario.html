<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker (Unificado y Vol√°til)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --color-fondo-oscuro: #121212;
            --color-texto-claro: #E0E0E0;
            --color-acento-principal: #FF5733; /* Rojo para acentos de alto impacto (Clic, Ganancia) */
            --color-acento-secundario: #33A0FF; /* Cian/Azul para botones de acci√≥n */
            --color-clicker: #6200EE;
            --color-ips: #03DAC6;
            --color-empresa: #FFC107;
            --color-inversion: #2196F3;
            --color-crypto: #F7931A;
        }

        /* FONDO DE IMAGEN: Usando fondo_rojo.jpg como solicitado */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-y: auto;
            overflow-x: hidden;
            /* La imagen 'fondo_rojo.jpg' se carga si est√° en la misma carpeta. */
            background-image: url('fondo_rojo.jpg'); 
            background-size: cover; 
            background-repeat: no-repeat;
            background-attachment: fixed; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .game-container {
            max-width: 1200px;
            width: 95%;
            margin-top: 20px;
            margin-bottom: 70px; 
            background: rgba(0, 0, 0, 0.85); 
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        /* HEADER y STATS */
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-acento-principal);
            padding-bottom: 10px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat {
            text-align: center;
            padding: 10px 15px;
        }

        .stat h2 {
            margin: 5px 0;
            font-size: 1.5em;
            color: var(--color-acento-secundario);
        }

        .stat small {
            color: #999;
            font-size: 0.8em;
        }

        /* NAVEGACI√ìN */
        #nav-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        #nav-bar button {
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            border: 2px solid var(--color-acento-secundario);
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            border-radius: 8px;
        }

        #nav-bar button:hover, #nav-bar button.active {
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-acento-secundario);
        }

        /* VISTAS DE JUEGO */
        .game-view {
            display: none;
            padding: 10px;
        }

        .game-view.active {
            display: block;
        }
        
        /* >>> ESTILOS DE LA VISTA PRINCIPAL DE 3 COLUMNAS <<< */
        #view-clicker {
            /* 3 Columnas: Tienda IPC (1fr) | Clicker (300px fijo) | Tienda IPS (1fr) */
            display: grid;
            grid-template-columns: 1fr 300px 1fr; 
            gap: 20px;
            align-items: flex-start;
        }
        
        /* Estilo para las columnas de la tienda (IPC y IPS) */
        .store-column {
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .store-column h2 {
            color: var(--color-acento-principal);
            text-align: center;
            border-bottom: 1px dashed #555;
            padding-bottom: 5px;
            margin-top: 0;
        }

        /* Columna central del clicker */
        #click-section {
            text-align: center;
            padding: 20px;
            position: relative;
        }

        #click-area button {
            background: var(--color-acento-principal);
            border: none;
            padding: 50px;
            border-radius: 50%;
            font-size: 3em;
            color: var(--color-texto-claro);
            cursor: pointer;
            box-shadow: 0 0 20px var(--color-acento-principal);
            transition: transform 0.1s;
            width: 250px; /* Tama√±o del bot√≥n */
            height: 250px;
            margin-top: 50px;
        }

        #click-area button:active {
            transform: scale(0.95);
        }
        
        .tienda-grid {
            display: grid;
            grid-template-columns: 1fr; /* 1 columna por tienda para este dise√±o */
            gap: 15px;
            margin-top: 15px;
        }
        
        .crypto-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
             gap: 20px;
        }
        
        .tienda-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border-left: 5px solid var(--color-acento-secundario);
        }

        .tienda-item h3 {
            margin-top: 0;
            color: var(--color-acento-secundario);
            font-size: 1.1em;
        }

        .tienda-item button {
            width: 100%;
            padding: 8px;
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .tienda-item button:hover:not([disabled]) {
            background-color: #66CCFF;
        }

        .item-bloqueado button, .tienda-item button[disabled] {
            background-color: #555;
            cursor: not-allowed;
            color: #AAA;
        }
        
        .item-comprado {
             border-left-color: var(--color-acento-principal);
             opacity: 0.6;
        }
        
        .crypto-item {
             background: rgba(247, 147, 26, 0.1); 
             padding: 20px;
             border-radius: 10px;
             border: 2px solid var(--color-crypto);
        }

        .text-success { color: #4CAF50; }
        .text-danger { color: #F44336; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--color-acento-secundario);
        }

        /* FOOTER DE ESTUDIO */
        #winted-footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            width: 100%;
        }
        
        /* ANIMACI√ìN DE CLIC */
        .animacion-clic {
            position: fixed;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-ips);
            pointer-events: none;
            user-select: none;
            animation: fadeout 1s ease-out forwards;
            z-index: 100;
        }

        @keyframes fadeout {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
    </style>
    
    <script type="module">
        // Importaci√≥n de Firebase (Mantener para la funcionalidad de guardado en la nube)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n global (usa las variables del entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;
        let userId = 'anon';

        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            if (typeof window.initGame === 'function') {
                window.initGame(); 
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        async function attemptAuth() {
            try {
                if (initialAuthToken) {
                    const userCredential = await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await window.firebase.auth.signInAnonymously(window.auth);
                    userId = userCredential.user.uid;
                }
            } catch (error) {
                userId = crypto.randomUUID();
            }
            window.userId = userId; 
            handleInitGame();
        }

        window.firebase.auth.onAuthStateChanged((user) => {
             if (user) {
                userId = user.uid;
             }
             if (!isGameInitialized) {
                attemptAuth();
             }
        });
    </script>

    <script>
        // ====================================================================
        // --- L√ìGICA DEL JUEGO MILLONARIO CLICKER (JavaScript) ---
        // ====================================================================

        // --- MODELO DE ESTADO ---
        let estadoJuego = {
            dinero: 0,
            ipc: 1, 
            ips: 0, 
            tiendas: {}, 
            activos: {},
            empresas: {},
            inversiones: {},
            crypto: {
                // Lista de Cryptos completa para la funcionalidad de trading
                bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 },
                cardano: { cantidad: 0, valorActual: 0.50, costoPromedio: 0 }, 
                dogecoin: { cantidad: 0, valorActual: 0.10, costoPromedio: 0 },
                litecoin: { cantidad: 0, valorActual: 80, costoPromedio: 0 }, 
                solana: { cantidad: 0, valorActual: 50, costoPromedio: 0 }  
            },
            estadisticas: {
                totalClicks: 0,
                dineroPorClicks: 0,
                dineroPasivo: 0,
                dineroCrypto: 0
            },
            ultimosSegundos: Date.now()
        };
        
        // --- CONSTANTES GLOBALES DE VOLATILIDAD ---
        const CRYPTO_FLUCTUATION_MAX = 0.15; 
        const INVESTMENT_FLUCTUATION_MAX = 0.05; 
        const FLUCTUATION_INTERVAL = 60000; // 60 segundos (1 minuto) para cambios en el valor

        
        // --- DEFINICI√ìN DE TIENDAS ---
        const mejorasClick = {
            'dedo-rapido': { nombre: 'Dedo R√°pido ü§è', costoBase: 10, costoEscalado: 1.15, ipcAumento: 1, tipo: 'ipc', icono: 'üëã' },
            'mouse-gamer': { nombre: 'Mouse Gamer üñ±Ô∏è', costoBase: 100, costoEscalado: 1.15, ipcAumento: 10, tipo: 'ipc', icono: 'üéÆ' },
            'ai-clicker': { nombre: 'Asistente IA ü§ñ', costoBase: 1000, costoEscalado: 1.15, ipcAumento: 100, tipo: 'ipc', icono: 'üí°' }
        };

        const generadoresIPS = {
            'puesto-limonada': { nombre: 'Puesto de Limonada üçã', costoBase: 50, costoEscalado: 1.15, ipsGenerado: 0.5, tipo: 'ips', icono: 'ü•§' },
            'vendedor-ambulante': { nombre: 'Vendedor Ambulante üíº', costoBase: 500, costoEscalado: 1.15, ipsGenerado: 5, tipo: 'ips', icono: 'üö∂' },
            'tienda-online': { nombre: 'Tienda Online üíª', costoBase: 5000, costoEscalado: 1.15, ipsGenerado: 50, tipo: 'ips', icono: 'üõí' }
        };
        
        const activosLujos = {
             'coche-lujo': { nombre: 'Coche Deportivo üèéÔ∏è', costo: 50000, efecto: 'Aumenta IPC en 500', ipcAumento: 500, comprado: false, icono: 'üèéÔ∏è' },
             'apartamento': { nombre: 'Apartamento de Lujo üèôÔ∏è', costo: 500000, efecto: 'Aumenta IPS en 50', ipsAumento: 50, comprado: false, icono: 'üèôÔ∏è' }
        };
        
        const empresasVistas = {
             'restaurante': { nombre: 'Restaurante Exclusivo üçΩÔ∏è', costo: 1000000, ipsGenerado: 1000, vecesComprado: 0, icono: 'üçΩÔ∏è' },
             'tech-startup': { nombre: 'Tech Startup üöÄ', costo: 10000000, ipsGenerado: 10000, vecesComprado: 0, icono: 'üöÄ' }
        };
        
        const inversionesVista = {
             'bonos-gobierno': { nombre: 'Bonos Gobierno üèõÔ∏è', costo: 100000, retorno: 0.05, vecesComprado: 0, tipo: 'retorno', icono: 'üèõÔ∏è' }, 
             'crypto-mining': { nombre: 'Crypto Mining ‚õèÔ∏è', costo: 2000000, retorno: 0.1, vecesComprado: 0, tipo: 'retorno', icono: '‚õèÔ∏è' }
        };

        // --- UTILIDADES DE FORMATO ---
        
        /** Formatea un n√∫mero como moneda (K, M, B, T...). */
        function formatDinero(num, decimales = 2) {
            num = parseFloat(num);
            if (num === 0) return '$0.00';
            const sign = num < 0 ? '-' : '';
            const absNum = Math.abs(num);
            
            if (absNum < 1000) return sign + '$' + absNum.toFixed(decimales);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Q', 'S', 'O', 'N', 'D', 'UD'];
            const tier = Math.floor(Math.log10(absNum) / 3);
            const suffix = suffixes[tier] || 'E';
            const scale = Math.pow(10, tier * 3);
            const scaled = absNum / scale;

            let formatted = scaled.toFixed(decimales);
            if (tier > 0 && formatted.endsWith('.00')) {
                formatted = scaled.toFixed(0);
            } else if (tier > 0 && formatted.endsWith('.0')) {
                 formatted = scaled.toFixed(1);
            }
            return sign + '$' + formatted + suffix;
        }
        
        /** Formatea un n√∫mero para crypto (m√°s decimales para precisi√≥n) */
        function formatCrypto(num, decimales = 6) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        /** Calcula el costo de la siguiente compra. */
        function calcularCosto(base, escalado, nivel) {
            return base * Math.pow(escalado, nivel);
        }

        /** Muestra una animaci√≥n de texto cuando se hace clic o se genera dinero. */
        function mostrarAnimacion(monto, x, y, esCrypto = false) {
            const anim = document.createElement('div');
            anim.textContent = `${monto > 0 ? '+' : ''}${formatDinero(monto)}`;
            anim.classList.add('animacion-clic');
            
            if (esCrypto) {
                 anim.classList.add('animacion-crypto');
            }
            
            anim.style.left = `${x}px`;
            anim.style.top = `${y}px`;

            document.body.appendChild(anim);

            anim.addEventListener('animationend', () => {
                anim.remove();
            });
        }
        
        // --- L√ìGICA DE GUARDADO Y CARGA (NUBE Y LOCAL) ---
        
        // **Nota:** Las funciones de Firebase se mantienen para la integraci√≥n con la nube.
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TIENDA_PATH = `/artifacts/${APP_ID}/users/${window.userId}/tiendaJuego`;
        const LOCAL_STORAGE_KEY = 'millonarioClicker_save'; 
        
        async function cargarEstadoNube() {
            if (!window.db || !window.userId) return null;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const docSnap = await window.firebase.firestore.getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                }
            } catch (e) {
                console.error("Error al cargar de la nube:", e);
            }
            return null;
        }

        async function guardarEstadoNube() {
            if (!window.db || !window.userId) return;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() 
                };
                await window.firebase.firestore.setDoc(docRef, dataToSave);
            } catch (e) {
                console.error("Error al guardar en la nube:", e);
            }
        }
        
        function cargarEstadoLocal() {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    return JSON.parse(savedState);
                }
            } catch (e) {
                 console.error("Error al cargar de LocalStorage:", e);
            }
            return null;
        }
        
        function guardarEstadoLocal() {
            try {
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                 console.error("Error al guardar en LocalStorage:", e);
            }
        }
        
        async function cargarEstado() {
            let data = cargarEstadoLocal();
            
            if (!data) {
                 data = await cargarEstadoNube();
            }
            
            if (data) {
                estadoJuego = {
                    ...estadoJuego,
                    ...data,
                    dinero: parseFloat(data.dinero || 0),
                    ipc: parseFloat(data.ipc || 1),
                    ips: parseFloat(data.ips || 0),
                    ultimosSegundos: parseFloat(data.ultimosSegundos || Date.now())
                };
                
                estadoJuego.crypto = data.crypto || estadoJuego.crypto;
                estadoJuego.estadisticas = data.estadisticas || estadoJuego.estadisticas;
                
                calcularProgresoOffline();
            } else {
                 await guardarEstado();
            }
        }
        
        async function guardarEstado() {
            guardarEstadoLocal(); 
            await guardarEstadoNube(); 
        }

        // --- L√ìGICA DE JUEGO PRINCIPAL Y VOLATILIDAD ---
        
        function inicializarTiendas(tiendas, estadoKey) {
            for (const id in tiendas) {
                if (!estadoJuego[estadoKey][id]) {
                    estadoJuego[estadoKey][id] = { 
                        nivel: 0, 
                        vecesComprado: 0,
                        comprado: tiendas[id].comprado || false, 
                        valorTotal: 0 
                    };
                }
            }
        }
        
        function calcularProgresoOffline() {
            const now = Date.now();
            const elapsedSeconds = (now - estadoJuego.ultimosSegundos) / 1000;
            if (elapsedSeconds > 5) { 
                const dineroGanado = estadoJuego.ips * elapsedSeconds;
                estadoJuego.dinero += dineroGanado;
                estadoJuego.estadisticas.dineroPasivo += dineroGanado;
            }
            estadoJuego.ultimosSegundos = now;
        }

        function actualizarUI() {
            document.getElementById('dinero-actual').textContent = formatDinero(estadoJuego.dinero);
            document.getElementById('ipc-actual').textContent = formatDinero(estadoJuego.ipc);
            document.getElementById('ips-actual').textContent = formatDinero(estadoJuego.ips) + " / s";
            
            // Actualizar solo las vistas activas para mejorar el rendimiento
            if (document.getElementById('view-clicker').classList.contains('active')) {
                 // **NOTA:** Llamadas separadas para IPC y IPS (solicitud de dise√±o 3 columnas)
                 dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas'); 
                 dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas'); 
            }
            if (document.getElementById('view-assets').classList.contains('active')) dibujarActivos();
            if (document.getElementById('view-companies').classList.contains('active')) dibujarEmpresas();
            if (document.getElementById('view-investments').classList.contains('active')) dibujarInversiones();
            if (document.getElementById('view-crypto').classList.contains('active')) dibujarCryptoView();
            // REQUISITO: Estad√≠sticas se actualizan instant√°neamente
            dibujarStatsView(); 
        }
        
        // L√≥gica de fluctuaci√≥n de Crypto (se ejecuta cada 60 segundos)
        function fluctuarCrypto() {
            for (const id in estadoJuego.crypto) {
                const cryptoData = estadoJuego.crypto[id];
                const factor = (Math.random() * (CRYPTO_FLUCTUATION_MAX * 2)) - CRYPTO_FLUCTUATION_MAX; 
                let newPrice = cryptoData.valorActual * (1 + factor);
                
                // Volatilidad Extrema para DOGE
                if (id === 'dogecoin' && Math.random() < 0.15) { 
                     newPrice *= (1 + ((Math.random() * 2.0) - 1.0)); 
                }
                newPrice = Math.max(0.000001, newPrice); 
                cryptoData.valorActual = newPrice;
            }
            if (document.getElementById('view-crypto').classList.contains('active')) {
                 dibujarCryptoView();
            }
        }
        
        // L√≥gica de fluctuaci√≥n de Inversiones (se ejecuta cada 60 segundos)
        function fluctuarInversiones() {
            // Actualmente la inversi√≥n no afecta el IPC/IPS directamente, solo el valor.
            // Si quieres que el IPS de la inversi√≥n fluct√∫e, esta l√≥gica debe ser modificada.
            if (document.getElementById('view-investments').classList.contains('active')) {
                 dibujarInversiones();
            }
        }


        /** L√≥gica para el bucle de ingresos pasivos (IPS) */
        function bucleJuego() {
            const ganancia = estadoJuego.ips;
            estadoJuego.dinero += ganancia; 
            estadoJuego.estadisticas.dineroPasivo += ganancia;
            
            actualizarUI(); 
        }

        // --- L√ìGICA DE DIBUJO DE VISTAS (MENOS MODULAR PARA MAYOR EXTENSI√ìN) ---
        
        function dibujarTienda(items, contenedorId, estadoKey) {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) return;

            contenedor.innerHTML = '';
            
            for (const id in items) {
                const item = items[id];
                const nivel = estadoJuego[estadoKey][id]?.nivel || 0;
                const costo = calcularCosto(item.costoBase, item.costoEscalado, nivel);
                const puedeComprar = estadoJuego.dinero >= costo;

                // Bloque de generaci√≥n de HTML (repetido para cada tipo de tienda)
                const elemento = document.createElement('div');
                elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                
                let efectoTexto = item.tipo === 'ipc' ? `+${formatDinero(item.ipcAumento)} IPC` : `+${formatDinero(item.ipsGenerado)} IPS`;
                
                elemento.innerHTML = `
                    <h3>${item.icono} ${item.nombre}</h3>
                    <p>Nivel: <span style="color: var(--color-empresa);">${nivel}</span></p>
                    <p>Efecto: ${efectoTexto}</p>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                    <button onclick="comprarItem('${id}', '${estadoKey}', '${item.tipo}')" ${!puedeComprar ? 'disabled' : ''}>
                        Comprar (Nivel ${nivel + 1})
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        function dibujarActivos() {
             const contenedor = document.getElementById('activos-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';
             
             // **NOTA:** Implementaci√≥n extensa para cada item de activo (menos DRY)
             for (const id in activosLujos) {
                 const item = activosLujos[id];
                 const estadoItem = estadoJuego.activos[id];
                 const comprado = estadoItem.comprado;
                 const puedeComprar = estadoJuego.dinero >= item.costo && !comprado;
                 
                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item ${comprado ? 'item-comprado' : ''} ${!puedeComprar && !comprado ? 'item-bloqueado' : ''}`;
                 
                 elemento.innerHTML = `
                     <h3>${item.icono} ${item.nombre}</h3>
                     <p>Efecto: ${item.efecto}</p>
                     <p>Costo: <span style="font-weight: 700;">${formatDinero(item.costo)}</span></p>
                     <p style="font-weight: 700; color: ${comprado ? 'var(--color-ips)' : 'var(--color-acento-principal)'}">${comprado ? 'ADQUIRIDO' : 'Disponible'}</p>
                     <button onclick="comprarActivo('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         ${comprado ? 'Comprado' : 'Comprar Activo'}
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        function dibujarEmpresas() {
             const contenedor = document.getElementById('empresas-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';
             
             for (const id in empresasVistas) {
                 const item = empresasVistas[id];
                 const estadoItem = estadoJuego.empresas[id];
                 const nivel = estadoItem.vecesComprado;
                 const costo = item.costo;
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 
                 elemento.innerHTML = `
                     <h3>${item.icono} ${item.nombre}</h3>
                     <p>Unidades: <span style="color: var(--color-empresa);">${nivel}</span></p>
                     <p>Genera: +${formatDinero(item.ipsGenerado)} IPS por unidad</p>
                     <p>Costo por unidad: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarEmpresa('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Comprar ${item.nombre}
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        function dibujarInversiones() {
             const contenedor = document.getElementById('inversiones-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';
             
             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const estadoItem = estadoJuego.inversiones[id];
                 const nivel = estadoItem.vecesComprado;
                 const costo = item.costo;
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 
                 // **NOTA:** Aqu√≠ la l√≥gica de inversi√≥n se simplifica en el dibujo.
                 elemento.innerHTML = `
                     <h3>${item.icono} ${item.nombre}</h3>
                     <p>Unidades: <span style="color: var(--color-empresa);">${nivel}</span></p>
                     <p>Retorno Base: ${item.retorno * 100}%</p>
                     <p>Valor de Inversi√≥n: <span style="font-weight: 700; color: var(--color-ips);">${formatDinero(nivel * costo, 0)}</span></p>
                     <p>Costo por unidad: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarInversion('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Invertir $${formatDinero(costo)}
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        function dibujarCryptoView() {
            const contenedor = document.getElementById('crypto-grid');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            const cryptos = [
                { id: 'bitcoin', nombre: 'Bitcoin (BTC)', icono: '‚Çø' },
                { id: 'ethereum', nombre: 'Ethereum (ETH)', icono: 'Œû' },
                { id: 'cardano', nombre: 'Cardano (ADA)', icono: '‚Ç≥' },
                { id: 'dogecoin', nombre: 'Dogecoin (DOGE)', icono: '∆â' },
                { id: 'litecoin', nombre: 'Litecoin (LTC)', icono: '≈Å' },
                { id: 'solana', nombre: 'Solana (SOL)', icono: '‚óé' }
            ];

            // **NOTA:** Implementaci√≥n extensa para cada item de crypto (menos DRY)
            cryptos.forEach(({ id, nombre, icono }) => {
                const cryptoData = estadoJuego.crypto[id];
                const valorActual = cryptoData.valorActual;
                const cantidad = cryptoData.cantidad;
                const valorActualTotal = cantidad * valorActual;
                const perdidaGanancia = cantidad > 0 ? (valorActualTotal - (cantidad * cryptoData.costoPromedio)) : 0;
                const puedeVender = cantidad > 0;
                const puedeComprar = estadoJuego.dinero >= valorActual;

                const elemento = document.createElement('div');
                elemento.className = 'crypto-item';
                
                elemento.innerHTML = `
                    <div class="crypto-header">
                        <span class="crypto-icon">${icono}</span>
                        <h3>${nombre}</h3>
                    </div>
                    <div class="crypto-info">
                        <p>Valor Actual: <span class="crypto-price">${formatDinero(valorActual, valorActual < 10 ? 4 : 2)}</span></p>
                        <p>Tu Cantidad: <span class="crypto-amount">${formatCrypto(cantidad)}</span></p>
                        <p>Costo Promedio: <span class="crypto-avg">${formatDinero(cryptoData.costoPromedio, 2)}</span></p>
                        <p>Ganancia No Realizada: 
                            <span class="${perdidaGanancia >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatDinero(perdidaGanancia, 2)}
                            </span>
                        </p>
                    </div>
                    <div class="crypto-actions">
                        <button onclick="comprarCrypto('${id}', 1)" ${!puedeComprar ? 'disabled' : ''} class="buy-btn">
                            Comprar 1 (${formatDinero(valorActual, 2)})
                        </button>
                        <button onclick="venderCrypto('${id}', 1)" ${!puedeVender ? 'disabled' : ''} class="sell-btn">
                            Vender 1 (${formatDinero(valorActual, 2)})
                        </button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
        }
        
        function dibujarStatsView() {
            const stats = estadoJuego.estadisticas;
            const totalDineroGanado = stats.dineroPorClicks + stats.dineroPasivo + stats.dineroCrypto;
            
            document.getElementById('stat-dinero-actual').textContent = formatDinero(estadoJuego.dinero); 
            document.getElementById('stat-total-clicks').textContent = stats.totalClicks.toLocaleString('es-ES');
            document.getElementById('stat-dinero-clicks').textContent = formatDinero(stats.dineroPorClicks);
            document.getElementById('stat-dinero-pasivo').textContent = formatDinero(stats.dineroPasivo);
            document.getElementById('stat-dinero-crypto').textContent = formatDinero(stats.dineroCrypto);
            document.getElementById('stat-total-ganado').textContent = formatDinero(totalDineroGanado);
        }

        // --- FUNCIONES ACCIONABLES (GLOBALES) ---
        
        window.hacerClick = function(e) {
            estadoJuego.dinero += estadoJuego.ipc;
            estadoJuego.estadisticas.totalClicks++;
            estadoJuego.estadisticas.dineroPorClicks += estadoJuego.ipc;
            
            mostrarAnimacion(estadoJuego.ipc, e.clientX, e.clientY);

            actualizarUI(); 
            guardarEstado(); 
        }

        window.comprarItem = function(id, estadoKey, tipo) {
            const items = (tipo === 'ipc') ? mejorasClick : generadoresIPS;
            const item = items[id];
            const estadoItem = estadoJuego[estadoKey][id];
            const costo = calcularCosto(item.costoBase, item.costoEscalado, estadoItem.nivel);

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estadoItem.nivel++;
                
                if (tipo === 'ipc') {
                    estadoJuego.ipc += item.ipcAumento;
                } else if (tipo === 'ips') {
                    estadoJuego.ips += item.ipsGenerado;
                }
            }
            
            recalcularIPC(); 
            recalcularIPS();
            actualizarUI(); 
            guardarEstado(); 
        }
        
        window.comprarActivo = function(id) {
             const item = activosLujos[id];
             const estadoItem = estadoJuego.activos[id];
             
             if (!estadoItem.comprado && estadoJuego.dinero >= item.costo) {
                 estadoJuego.dinero -= item.costo;
                 estadoItem.comprado = true;
                 
                 // Aplicar efecto de activo
                 if (item.ipcAumento) estadoJuego.ipc += item.ipcAumento;
                 if (item.ipsAumento) estadoJuego.ips += item.ipsAumento;
             }
             recalcularIPC(); 
             recalcularIPS();
             actualizarUI(); 
             guardarEstado(); 
        }
        
        window.comprarEmpresa = function(id) {
             const item = empresasVistas[id];
             const estadoItem = estadoJuego.empresas[id];
             
             if (estadoJuego.dinero >= item.costo) {
                 estadoJuego.dinero -= item.costo;
                 estadoItem.vecesComprado++;
                 estadoJuego.ips += item.ipsGenerado;
             }
             recalcularIPS();
             actualizarUI(); 
             guardarEstado(); 
        }

        window.comprarInversion = function(id) {
            const item = inversionesVista[id];
            const estadoItem = estadoJuego.inversiones[id];
            
            if (estadoJuego.dinero >= item.costo) {
                estadoJuego.dinero -= item.costo;
                estadoItem.vecesComprado++;
            }
            recalcularIPS(); 
            actualizarUI(); 
            guardarEstado(); 
        }
        
        window.comprarCrypto = function(id, cantidad) {
            const cryptoData = estadoJuego.crypto[id];
            const costoTotal = cryptoData.valorActual * cantidad;
            
            if (estadoJuego.dinero >= costoTotal) {
                estadoJuego.dinero -= costoTotal;
                
                const cantidadVieja = cryptoData.cantidad;
                const costoViejoTotal = cantidadVieja * cryptoData.costoPromedio;
                const nuevoCostoTotal = costoViejoTotal + costoTotal;
                const nuevaCantidadTotal = cantidadVieja + cantidad;
                
                cryptoData.costoPromedio = nuevaCantidadTotal > 0 ? nuevoCostoTotal / nuevaCantidadTotal : 0;
                cryptoData.cantidad = nuevaCantidadTotal;
            }
            actualizarUI(); 
            guardarEstado(); 
        }

        window.venderCrypto = function(id, cantidad) {
            const cryptoData = estadoJuego.crypto[id];
            
            if (cryptoData.cantidad >= cantidad) {
                const ingreso = cryptoData.valorActual * cantidad;
                const costoDeVenta = cryptoData.costoPromedio * cantidad;
                
                estadoJuego.dinero += ingreso;
                estadoJuego.estadisticas.dineroCrypto += (ingreso - costoDeVenta);
                cryptoData.cantidad -= cantidad;

                // Si se vende todo, resetear el costo promedio
                if (cryptoData.cantidad <= 0) {
                     cryptoData.costoPromedio = 0;
                     cryptoData.cantidad = 0;
                }
            }
            actualizarUI(); 
            guardarEstado(); 
        }

        /** Recalcula el IPC total base + multiplicadores. */
        function recalcularIPC() {
             let nuevoIPC = 1;
             
             for (const id in mejorasClick) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 nuevoIPC += mejorasClick[id].ipcAumento * nivel;
             }
             
             for (const id in activosLujos) {
                 const comprado = estadoJuego.activos[id]?.comprado;
                 if (comprado && activosLujos[id].ipcAumento) {
                     nuevoIPC += activosLujos[id].ipcAumento;
                 }
             }
             
             estadoJuego.ipc = nuevoIPC;
        }

        /** Recalcula el IPS total de todas las fuentes. */
        function recalcularIPS() {
             let nuevoIPS = 0;
             
             // 1. IPS de Generadores Pasivos
             for (const id in generadoresIPS) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 nuevoIPS += generadoresIPS[id].ipsGenerado * nivel;
             }
             
             // 2. IPS de Empresas
             for (const id in empresasVistas) {
                 const nivel = estadoJuego.empresas[id]?.vecesComprado || 0;
                 nuevoIPS += empresasVistas[id].ipsGenerado * nivel;
             }
             
             // 3. IPS de Activos Fijos
             for (const id in activosLujos) {
                 const comprado = estadoJuego.activos[id]?.comprado;
                 if (comprado && activosLujos[id].ipsAumento) {
                     nuevoIPS += activosLujos[id].ipsAumento;
                 }
             }
             
             // 4. IPS de Inversiones (Retorno porcentual fijo por ahora)
             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const nivel = estadoJuego.inversiones[id]?.vecesComprado || 0;
                 const valorInvertido = item.costo * nivel;
                 nuevoIPS += valorInvertido * item.retorno; // Retorno base
             }
             
             estadoJuego.ips = nuevoIPS;
        }


        // --- Vistas y Control ---
        
        window.cambiarVista = function(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${vista}`).classList.add('active');
            
            // Se actualizan las vistas relevantes al cambiar
            if (vista === 'clicker') {
                dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas');
                dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas');
            }
            if (vista === 'assets') dibujarActivos();
            if (vista === 'companies') dibujarEmpresas();
            if (vista === 'investments') dibujarInversiones();
            if (vista === 'crypto') dibujarCryptoView();
            if (vista === 'stats') dibujarStatsView();

            document.querySelectorAll('#nav-bar button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id.includes(vista)) {
                    btn.classList.add('active');
                }
            });
        }

        /** Funci√≥n de inicializaci√≥n principal del juego. */
        window.initGame = async function() {
            // Inicializar estructuras de datos si faltan
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            await cargarEstado(); 
            
            recalcularIPC();
            recalcularIPS();
            
            actualizarUI(); 
            
            // Configurar el bucle del juego (1 segundo)
            setInterval(bucleJuego, 1000); 
            
            // Guardar el estado cada 30 segundos
            setInterval(guardarEstado, 30000); 
            
            // Bucle de fluctuaci√≥n de crypto y inversiones (1 minuto)
            setInterval(fluctuarCrypto, FLUCTUATION_INTERVAL);
            setInterval(fluctuarInversiones, FLUCTUATION_INTERVAL);
            
            cambiarVista('clicker');
        };
        
        window.resetGame = async function() {
            if (confirm("¬øEst√°s seguro de que quieres REINICIAR el juego? Perder√°s todo el progreso guardado.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                // NOTA: Para borrar de la nube se requiere una llamada de Firebase, simplificada aqu√≠.
                window.location.reload(); 
            }
        }
        
        
    </script>
</head>
<body>

    <div class="game-container">
        
        <header>
            <h1>Millonario Clicker üí∞</h1>
            <div class="stats-bar">
                <div class="stat">
                    <small>Dinero Actual</small>
                    <h2 id="dinero-actual">$0.00</h2>
                </div>
                <div class="stat">
                    <small>Ingreso por Clic (IPC)</small>
                    <h2 id="ipc-actual">$1.00</h2>
                </div>
                <div class="stat">
                    <small>Ingreso Pasivo (IPS)</small>
                    <h2 id="ips-actual">$0.00 / s</h2>
                </div>
            </div>
        </header>

        <nav id="nav-bar">
            <button id="nav-clicker" onclick="cambiarVista('clicker')"><i class="fas fa-home"></i> Principal</button>
            <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-gem"></i> Activos</button>
            <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Empresas</button>
            <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
            <button id="nav-crypto" onclick="cambiarVista('crypto')"><i class="fab fa-bitcoin"></i> Crypto</button>
            <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-bar"></i> Estad√≠sticas</button>
        </nav>
        
        <div id="view-clicker" class="game-view active">
            
            <div id="ipc-store-section" class="store-column">
                <h2>Mejoras por Click (IPC)</h2>
                <div id="mejoras-clic-tienda" class="tienda-grid">
                    </div>
            </div>
            
            <div id="click-section">
                <h2>Hacer Click üëÜ</h2>
                <div id="click-area">
                    <button onclick="hacerClick(event)">
                        $$$
                    </button>
                </div>
                 <div id="winted-footer">
                    echo por winted studios
                </div>
            </div>

            <div id="ips-store-section" class="store-column">
                <h2>Ingreso Pasivo (IPS)</h2>
                <div id="generadores-tienda" class="tienda-grid">
                    </div>
            </div>
        </div>

        <div id="view-assets" class="game-view">
            <h2>Activos de Lujo (Multiplicadores y Bonos)</h2>
            <div id="activos-tienda" class="tienda-grid">
                </div>
        </div>

        <div id="view-companies" class="game-view">
            <h2>Compra de Empresas (IPS Fijo por Unidad)</h2>
            <div id="empresas-tienda" class="tienda-grid">
                </div>
        </div>
        
        <div id="view-investments" class="game-view">
            <h2>Inversiones y Acciones (Valor Fluct√∫a cada 60s)</h2>
            <p style="text-align: center; color: var(--color-acento-principal);">‚ö†Ô∏è **MERCADO VOL√ÅTIL:** El valor de tu inversi√≥n (y el IPS que genera) sube y baja cada minuto.</p>
            <div id="inversiones-tienda" class="tienda-grid">
                </div>
        </div>

        <div id="view-crypto" class="game-view">
            <h2>Criptomonedas (Compra/Venta)</h2>
            <p style="text-align: center; color: var(--color-acento-principal);">üìà **VOLATILIDAD EXTREMA:** El precio cambia cada minuto. ¬°Compra barato, vende caro!</p>
            <div id="crypto-grid" class="crypto-grid">
                </div>
        </div>

        <div id="view-stats" class="game-view">
            <div class="asset-section">
                <h2>Resumen de Riqueza</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: var(--color-acento-principal);">
                        <p>Valor Total Ganado</p>
                        <span id="stat-total-ganado">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Dinero Actual</p>
                        <span id="stat-dinero-actual">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Total Clics Realizados</p>
                        <span id="stat-total-clicks">0</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Clics</p>
                        <span id="stat-dinero-clicks">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia Pasiva (IPS)</p>
                        <span id="stat-dinero-pasivo">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Crypto</p>
                        <span id="stat-dinero-crypto">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="asset-section" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>Gesti√≥n de Datos</h2>
                <p style="text-align: center; margin-bottom: 20px; color: #aaa;">
                    Tu progreso se guarda autom√°ticamente cada 30 segundos en LocalStorage y la Nube.
                </p>
                <button id="reset-btn" onclick="resetGame()">
                    <i class="fas fa-trash-alt"></i> REINICIAR TODO EL PROGRESO
                </button>
            </div>
        </div>
        
    </div>
    
    <div id="user-info-footer" style="position: fixed; bottom: 5px; left: 5px; font-size: 0.7em; color: #666;">
        </div>

</body>
</html>
