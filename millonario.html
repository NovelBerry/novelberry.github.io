<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- FIREBASE MODULE: Inicializa la base de datos y llama a window.initGame -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n global (usa las variables del entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;
        let userId = 'anon';

        /**
         * Llama a la funci√≥n de inicio principal del juego solo una vez.
         */
        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            console.log("--- INICIO DE UI GARANTIZADO. User ID:", userId, "---");
            if (typeof window.initGame === 'function') {
                window.initGame(); 
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        /**
         * Intenta la autenticaci√≥n y establece el userId.
         */
        async function attemptAuth() {
            try {
                if (initialAuthToken) {
                    const userCredential = await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await window.firebase.auth.signInAnonymously(window.auth);
                    userId = userCredential.user.uid;
                }
            } catch (error) {
                console.error("Error en autenticaci√≥n Firebase, usando ID aleatorio:", error);
                userId = crypto.randomUUID();
            }
            window.userId = userId; // Hacer el userId globalmente accesible
            handleInitGame();
        }

        // 2. Observador de estado de autenticaci√≥n (garantiza el flujo de inicio)
        window.firebase.auth.onAuthStateChanged((user) => {
             if (user) {
                userId = user.uid;
             }
             if (!isGameInitialized) {
                attemptAuth();
             }
        });
    </script>

    <script>
        // ====================================================================
        // --- L√ìGICA DEL JUEGO MILLONARIO CLICKER (JavaScript) ---
        // ====================================================================

        // --- MODELO DE ESTADO ---
        let estadoJuego = {
            dinero: 0,
            ipc: 1, // Ingreso por Clic
            ips: 0, // Ingreso por Segundo
            tiendas: {}, // Clave: ID de la tienda, Valor: { nivel: X, vecesComprado: Y }
            activos: {},
            empresas: {},
            inversiones: {},
            ultimosSegundos: Date.now()
        };
        
        // ID de la aplicaci√≥n para Firebase Firestore
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TIENDA_PATH = `/artifacts/${APP_ID}/users/${window.userId}/tiendaJuego`;

        // --- DEFINICI√ìN DE TIENDAS ---
        const mejorasClick = {
            'dedo-rapido': { nombre: 'Dedo R√°pido ü§è', costoBase: 10, costoEscalado: 1.15, ipcAumento: 1, tipo: 'ipc', icono: 'üëã' },
            'mouse-gamer': { nombre: 'Mouse Gamer üñ±Ô∏è', costoBase: 100, costoEscalado: 1.15, ipcAumento: 10, tipo: 'ipc', icono: 'üéÆ' },
            'ai-clicker': { nombre: 'Asistente IA ü§ñ', costoBase: 1000, costoEscalado: 1.15, ipcAumento: 100, tipo: 'ipc', icono: 'üí°' }
        };

        const generadoresIPS = {
            'puesto-limonada': { nombre: 'Puesto de Limonada üçã', costoBase: 50, costoEscalado: 1.15, ipsGenerado: 0.5, tipo: 'ips', icono: 'ü•§' },
            'vendedor-ambulante': { nombre: 'Vendedor Ambulante üíº', costoBase: 500, costoEscalado: 1.15, ipsGenerado: 5, tipo: 'ips', icono: 'üö∂' },
            'tienda-online': { nombre: 'Tienda Online üíª', costoBase: 5000, costoEscalado: 1.15, ipsGenerado: 50, tipo: 'ips', icono: 'üõí' }
        };
        
        const activosLujos = {
             'coche-lujo': { nombre: 'Coche Deportivo üèéÔ∏è', costo: 50000, efecto: 'Aumenta IPC en 500', ipcAumento: 500, comprado: false },
             'apartamento': { nombre: 'Apartamento de Lujo üèôÔ∏è', costo: 500000, efecto: 'Aumenta IPS en 50', ipsAumento: 50, comprado: false },
             'yate': { nombre: 'Yate Privado üõ•Ô∏è', costo: 5000000, efecto: 'Duplica todo el IPC', multiplicadorIPC: 2, comprado: false }
        };
        
        const empresasVistas = {
             'restaurante': { nombre: 'Restaurante Exclusivo üçΩÔ∏è', costo: 1000000, ipsGenerado: 1000, vecesComprado: 0 },
             'tech-startup': { nombre: 'Tech Startup üöÄ', costo: 10000000, ipsGenerado: 10000, vecesComprado: 0 }
        };
        
        const inversionesVista = {
             'bonos-gobierno': { nombre: 'Bonos Gobierno üèõÔ∏è', costo: 100000, retorno: 0.05, vecesComprado: 0, tipo: 'retorno' }, // 5% de retorno
             'crypto-mining': { nombre: 'Crypto Mining ‚õèÔ∏è', costo: 2000000, retorno: 0.1, vecesComprado: 0, tipo: 'retorno' } // 10% de retorno
        };


        // --- UTILIDADES ---
        
        /** Formatea un n√∫mero como moneda. */
        function formatDinero(num) {
            if (num === 0) return '$0.00';
            const sign = num < 0 ? '-' : '';
            const absNum = Math.abs(num);
            
            if (absNum < 1000) return sign + '$' + absNum.toFixed(2);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Q'];
            const tier = Math.floor(Math.log10(absNum) / 3);
            const suffix = suffixes[tier] || '';
            const scale = Math.pow(10, tier * 3);
            const scaled = absNum / scale;

            // Mostrar dos decimales solo si no es un n√∫mero entero.
            const formatted = scaled.toFixed(scaled % 1 !== 0 ? 2 : 0);
            return sign + '$' + formatted + suffix;
        }

        /** Calcula el costo de la siguiente compra. */
        function calcularCosto(base, escalado, nivel) {
            return base * Math.pow(escalado, nivel);
        }

        /** Muestra una animaci√≥n de texto cuando se hace clic o se genera dinero. */
        function mostrarAnimacion(monto, x, y) {
            const anim = document.createElement('div');
            anim.textContent = `+${formatDinero(monto)}`;
            anim.classList.add('animacion-clic');
            
            // Posicionar con respecto al billete
            anim.style.left = `${x}px`;
            anim.style.top = `${y}px`;

            document.body.appendChild(anim);

            // Eliminar despu√©s de la animaci√≥n
            anim.addEventListener('animationend', () => {
                anim.remove();
            });
        }

        // --- FIREBASE (Guardar/Cargar) ---
        
        async function cargarEstado() {
            if (!window.db || !window.userId) return;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const docSnap = await window.firebase.firestore.getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Cargar estado principal
                    estadoJuego = {
                        ...estadoJuego,
                        ...data,
                        // Asegurar que el dinero sea un n√∫mero y no un string si Firebase lo serializa mal
                        dinero: parseFloat(data.dinero || 0),
                        ipc: parseFloat(data.ipc || 1),
                        ips: parseFloat(data.ips || 0)
                    };
                    console.log("Estado cargado:", estadoJuego);
                    // Forzar el c√°lculo del progreso offline
                    calcularProgresoOffline();
                } else {
                    // Si no existe, inicializar con el estado predeterminado y guardar
                    await guardarEstado();
                }
            } catch (e) {
                console.error("Error cargando el estado: ", e);
            }
        }

        async function guardarEstado() {
            if (!window.db || !window.userId) return;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                // Solo guardar los valores que cambian
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    ultimosSegundos: Date.now() // Actualizar el tiempo de guardado
                };
                await window.firebase.firestore.setDoc(docRef, dataToSave);
                console.log("Estado guardado con √©xito.");
            } catch (e) {
                console.error("Error guardando el estado: ", e);
            }
        }
        
        // --- L√ìGICA DE JUEGO PRINCIPAL ---

        /** * Inicializa el estado de las tiendas si es la primera vez.
         * Lo hacemos aqu√≠ para no sobreescribir los datos cargados.
         */
        function inicializarTiendas(tiendas, estadoKey) {
            for (const id in tiendas) {
                if (!estadoJuego[estadoKey][id]) {
                    estadoJuego[estadoKey][id] = { 
                        nivel: 0, 
                        vecesComprado: 0,
                        comprado: tiendas[id].comprado || false // Para activos fijos
                    };
                }
            }
        }
        
        function calcularProgresoOffline() {
            const now = Date.now();
            const elapsedSeconds = (now - estadoJuego.ultimosSegundos) / 1000;
            if (elapsedSeconds > 5) { // Si estuvo ausente por m√°s de 5 segundos
                const dineroGanado = estadoJuego.ips * elapsedSeconds;
                estadoJuego.dinero += dineroGanado;
                console.log(`Ganancia offline: +${formatDinero(dineroGanado)} durante ${Math.round(elapsedSeconds)} segundos.`);
            }
            estadoJuego.ultimosSegundos = now;
        }

        function actualizarUI() {
            document.getElementById('dinero-actual').textContent = formatDinero(estadoJuego.dinero);
            document.getElementById('ipc-actual').textContent = formatDinero(estadoJuego.ipc);
            document.getElementById('ips-actual').textContent = formatDinero(estadoJuego.ips) + " / s";
            
            // Actualizar botones de tienda
            dibujarTodasLasTiendas();
            
            // Mostrar User ID en el pie de p√°gina
            document.getElementById('user-info-footer').textContent = `ID de Sesi√≥n: ${window.userId}`;
        }
        
        /** * Llama a las funciones de dibujo de todas las vistas activas/paneles.
         * Se llama despu√©s de cargar el estado y en cada actualizaci√≥n.
         */
        function dibujarTodasLasTiendas() {
            dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas');
            dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas');
            dibujarActivos();
            dibujarEmpresas();
            dibujarInversiones();
            actualizarBotonesVista();
        }

        /** Actualiza el estado de los botones de navegaci√≥n seg√∫n la vista activa */
        function actualizarBotonesVista() {
             const vistaActiva = document.querySelector('.game-view.active').id.replace('view-', '');
             document.querySelectorAll('#nav-bar button').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.id.includes(vistaActiva)) {
                     btn.classList.add('active');
                 }
             });
        }


        /** L√≥gica para el bucle de ingresos pasivos (IPS) */
        function bucleJuego() {
            estadoJuego.dinero += estadoJuego.ips;
            actualizarUI();
        }

        // --- L√ìGICA DE COMPRA ---

        /** * Dibuja los items de mejora o generadores. 
         * @param {object} items - El objeto que define la tienda (ej: mejorasClick)
         * @param {string} contenedorId - El ID del elemento donde se dibujar√°n los botones
         * @param {string} estadoKey - La clave en estadoJuego donde se guarda el progreso (ej: 'tiendas')
         */
        function dibujarTienda(items, contenedorId, estadoKey) {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) return;

            contenedor.innerHTML = '';
            
            for (const id in items) {
                const item = items[id];
                const nivel = estadoJuego[estadoKey][id]?.nivel || 0;
                const costo = calcularCosto(item.costoBase, item.costoEscalado, nivel);
                const puedeComprar = estadoJuego.dinero >= costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                let efectoTexto = '';
                if (item.tipo === 'ipc') {
                    efectoTexto = `+${formatDinero(item.ipcAumento)} IPC por nivel`;
                } else if (item.tipo === 'ips') {
                    efectoTexto = `+${formatDinero(item.ipsGenerado)} IPS por nivel`;
                }
                
                elemento.innerHTML = `
                    <h3>${item.icono} ${item.nombre}</h3>
                    <p>Nivel: <span style="color: var(--color-empresa);">${nivel}</span></p>
                    <p>Efecto: ${efectoTexto}</p>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                    <button onclick="comprarItem('${id}', '${estadoKey}', '${item.tipo}')" ${!puedeComprar ? 'disabled' : ''}>
                        Comprar (Nivel ${nivel + 1})
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Activos (Compra √∫nica)
        function dibujarActivos() {
            const contenedor = document.getElementById('activos-tienda');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            for (const id in activosLujos) {
                const item = activosLujos[id];
                const estado = estadoJuego.activos[id] || { comprado: false };
                const comprado = estado.comprado;
                const puedeComprar = !comprado && estadoJuego.dinero >= item.costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item asset-item ${comprado ? 'item-comprado' : ''} ${!puedeComprar && !comprado ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                elemento.innerHTML = `
                    <h3>${item.icono || '‚ú®'} ${item.nombre}</h3>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(item.costo)}</span></p>
                    <p>Efecto: <span style="color: var(--color-inversion);">${item.efecto}</span></p>
                    <button onclick="comprarActivo('${id}')" ${comprado || !puedeComprar ? 'disabled' : ''}>
                        ${comprado ? 'Comprado' : 'Comprar Lujo'}
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Empresas (Generan IPS)
        function dibujarEmpresas() {
             const contenedor = document.getElementById('empresas-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in empresasVistas) {
                 const item = empresasVistas[id];
                 const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
                 
                 // Costo de la empresa: 10% de aumento por cada compra (ejemplo simple)
                 const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item company-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const ipsTotal = estado.vecesComprado * item.ipsGenerado;

                 elemento.innerHTML = `
                     <h3>${item.icono || 'üè¢'} ${item.nombre}</h3>
                     <p>Compradas: <span style="color: var(--color-exito);">${estado.vecesComprado}</span></p>
                     <p>IPS Total: <span style="font-weight: 700;">${formatDinero(ipsTotal)} / s</span></p>
                     <p>Costo Pr√≥xima: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarEmpresa('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Fundar Nueva (IPS: +${formatDinero(item.ipsGenerado)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        // Dibujo de Inversiones (Generan Retorno %)
        function dibujarInversiones() {
             const contenedor = document.getElementById('inversiones-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
                 
                 // El costo es fijo por paquete de inversi√≥n
                 const costo = item.costo; 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item investment-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const retornoIPS = estado.valorTotal * item.retorno / 10; // Ejemplo: 5% anual / 10 = 0.5% por segundo (para hacerlo r√°pido)
                 
                 elemento.innerHTML = `
                     <h3>${item.icono || 'üìà'} ${item.nombre}</h3>
                     <p>Valor Total: <span style="color: var(--color-acento-celeste);">${formatDinero(estado.valorTotal)}</span></p>
                     <p>Retorno IPS: <span style="font-weight: 700;">${formatDinero(retornoIPS)} / s</span></p>
                     <p>Costo Paquete: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarInversion('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Invertir (+${formatDinero(item.costo)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }


        // --- FUNCIONES ACCIONABLES (GLOBALES) ---

        /** * Funci√≥n p√∫blica para el bot√≥n de clic principal.
         * @param {Event} e - Evento de clic para obtener posici√≥n.
         */
        window.hacerClick = function(e) {
            estadoJuego.dinero += estadoJuego.ipc;
            
            const x = e.clientX;
            const y = e.clientY;
            mostrarAnimacion(estadoJuego.ipc, x, y);

            actualizarUI();
            guardarEstado();
        }

        /**
         * Funci√≥n p√∫blica para comprar Mejoras/Generadores IPS.
         */
        window.comprarItem = function(id, estadoKey, tipo) {
            const item = (tipo === 'ipc' ? mejorasClick[id] : generadoresIPS[id]);
            const estadoActual = estadoJuego[estadoKey][id] || { nivel: 0 };
            const costo = calcularCosto(item.costoBase, item.costoEscalado, estadoActual.nivel);

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estadoActual.nivel++;
                estadoJuego[estadoKey][id] = estadoActual;

                if (tipo === 'ipc') {
                    estadoJuego.ipc += item.ipcAumento;
                } else if (tipo === 'ips') {
                    estadoJuego.ips += item.ipsGenerado;
                }
                
                recalcularIPS(); // Recalcula el IPS total (incluyendo activos y empresas)
                actualizarUI();
                guardarEstado();
            }
        }
        
        /**
         * Funci√≥n p√∫blica para comprar Activos/Lujos.
         */
        window.comprarActivo = function(id) {
            const item = activosLujos[id];
            const estado = estadoJuego.activos[id] || { comprado: false };
            
            if (!estado.comprado && estadoJuego.dinero >= item.costo) {
                estadoJuego.dinero -= item.costo;
                estado.comprado = true;
                estadoJuego.activos[id] = estado;
                
                // Aplicar el efecto del activo
                if (item.ipcAumento) {
                    estadoJuego.ipc += item.ipcAumento;
                }
                if (item.ipsAumento) {
                    estadoJuego.ips += item.ipsAumento;
                }
                if (item.multiplicadorIPC) {
                    // Esto se aplicar√° en recalcularIPS
                }
                
                recalcularIPC(); // Asegurar que el IPC se recalcule si hay multiplicadores
                recalcularIPS();
                actualizarUI();
                guardarEstado();
            }
        }
        
        /**
         * Funci√≥n p√∫blica para comprar Empresas.
         */
        window.comprarEmpresa = function(id) {
            const item = empresasVistas[id];
            const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
            const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estadoJuego.empresas[id] = estado;
                
                recalcularIPS();
                actualizarUI();
                guardarEstado();
            }
        }

        /**
         * Funci√≥n p√∫blica para comprar Inversiones (bonos/crypto).
         */
        window.comprarInversion = function(id) {
            const item = inversionesVista[id];
            const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
            const costo = item.costo; 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estado.valorTotal += costo; // A√±adir el costo al valor total invertido
                estadoJuego.inversiones[id] = estado;
                
                recalcularIPS(); // El IPS cambiar√° por el nuevo valor total
                actualizarUI();
                guardarEstado();
            }
        }

        
        /** Recalcula el IPC total base + multiplicadores. */
        function recalcularIPC() {
            let baseIPC = 1;
            
            // 1. IPC base de Mejoras Click
            for (const id in mejorasClick) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 baseIPC += nivel * mejorasClick[id].ipcAumento;
            }
            
            // 2. IPC de Activos fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].ipcAumento) {
                    baseIPC += activosLujos[id].ipcAumento;
                }
            }

            // Establecer el nuevo IPC (antes de multiplicadores)
            estadoJuego.ipc = baseIPC;
            
            // 3. Multiplicadores de Activos
            let multiplicador = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPC) {
                    multiplicador *= activosLujos[id].multiplicadorIPC;
                }
            }
            
            // Aplicar multiplicador
            estadoJuego.ipc = estadoJuego.ipc * multiplicador;
        }

        /** Recalcula el IPS total de todas las fuentes. */
        function recalcularIPS() {
            let totalIPS = 0;

            // 1. IPS de Generadores (Tienda)
            for (const id in generadoresIPS) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 totalIPS += nivel * generadoresIPS[id].ipsGenerado;
            }
            
            // 2. IPS de Activos Fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].ipsAumento) {
                    totalIPS += activosLujos[id].ipsAumento;
                }
            }

            // 3. IPS de Empresas
            for (const id in empresasVistas) {
                 const vecesComprado = estadoJuego.empresas[id]?.vecesComprado || 0;
                 totalIPS += vecesComprado * empresasVistas[id].ipsGenerado;
            }
            
            // 4. IPS de Inversiones (porcentaje de valor total)
            for (const id in inversionesVista) {
                 const inversion = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { valorTotal: 0 };
                 
                 // Retorno IPS = Valor total * Tasa de retorno anual / 10 (para hacerlo r√°pido)
                 totalIPS += estado.valorTotal * inversion.retorno / 10; 
            }

            estadoJuego.ips = totalIPS;
        }


        /**
         * Funci√≥n p√∫blica para cambiar la vista entre Clicker, Activos, Empresas, etc.
         */
        window.cambiarVista = function(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${vista}`).classList.add('active');
            
            // Actualizar botones de navegaci√≥n
            actualizarBotonesVista();
        }

        /** * Funci√≥n de inicializaci√≥n principal del juego.
         * Se llama desde el m√≥dulo de Firebase una vez que la autenticaci√≥n est√° lista.
         */
        window.initGame = async function() {
            // Inicializar estructuras de datos si faltan
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            await cargarEstado(); 
            
            // Recalcular IPC y IPS despu√©s de cargar el estado
            recalcularIPC();
            recalcularIPS();
            
            // Dibuja la UI inicial (incluyendo los botones de tienda)
            actualizarUI(); 
            
            // Configurar el bucle del juego (1 segundo)
            setInterval(bucleJuego, 1000); 
            
            // Guardar el estado cada 10 segundos
            setInterval(guardarEstado, 10000);
            
            // Asegurar que la vista inicial sea 'clicker'
            cambiarVista('clicker');
        };
        
        // --- FUNCI√ìN DE REINICIO ---
        window.resetGame = async function() {
            if (!confirm('¬øEst√°s seguro de que quieres REINICIAR el juego? Perder√°s todo el progreso.')) return;
            
            estadoJuego = {
                dinero: 0,
                ipc: 1, 
                ips: 0, 
                tiendas: {}, 
                activos: {},
                empresas: {},
                inversiones: {},
                ultimosSegundos: Date.now()
            };
            
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');
            
            recalcularIPC();
            recalcularIPS();
            actualizarUI();
            await guardarEstado();
            alert('Juego Reiniciado con √©xito.'); // Usamos alert aqu√≠ como excepci√≥n para el mensaje de confirmaci√≥n/√©xito cr√≠tico.
        }

    </script>
    
    <style>
        /* --- FUENTES Y ESTILOS GENERALES --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        :root {
            --color-fondo-oscuro: #121212;
            --color-texto-claro: #f0f0f0;
            --color-acento-celeste: #00bcd4; /* Color de acento para todo (portafolio y clicker) */
            --color-secundario: #6495ed; /* Azul para el IPC del clicker y t√≠tulos de panel */
            --color-exito: #388e3c; /* Verde para el bot√≥n de clic y items comprados */
            --color-advertencia: #d32f2f; /* Rojo para reiniciar */
            --color-empresa: #ffc107; /* Amarillo para empresas */
            --color-inversion: #9c27b0; /* P√∫rpura para inversiones */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            transition: color 0.2s, background-color 0.2s, border-color 0.2s;
        }

        /* --- REGLAS MODIFICADAS PARA PERMITIR EL SCROLL --- */
        html, body {
            width: 100%;
            min-height: 100vh;
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            overflow-y: auto; /* Permite el scroll vertical si el contenido desborda. */
            overflow-x: hidden; /* Previene el scroll horizontal no deseado */
        }

        /* --- DECORACI√ìN DE FONDO --- */
        #fondo-decoracion {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#1e1e1e 1px, transparent 0);
            background-size: 20px 20px;
            opacity: 0.2; 
            z-index: -1;
        }

        /* --- BARRA DE NAVEGACI√ìN --- */
        #nav-bar {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 20px;
            background-color: #0d0d0d;
            border-bottom: 3px solid var(--color-acento-celeste);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            z-index: 50; 
        }

        #nav-bar button {
            padding: 10px 15px;
            border: 2px solid var(--color-secundario);
            background-color: #1a1a1a;
            color: var(--color-texto-claro);
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            flex-grow: 1;
            max-width: 150px;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #nav-bar button:hover {
            background-color: var(--color-secundario);
            color: var(--color-fondo-oscuro);
            box-shadow: 0 0 10px var(--color-secundario);
        }

        #nav-bar button.active {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-acento-celeste);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.8);
        }

        /* --- CONTENEDORES DE VISTAS Y LAYOUT --- */
        #game-view-container {
            padding-top: 20px; 
            min-height: calc(100vh - 60px); 
        }

        .game-view {
            padding: 20px;
            display: none; 
            min-height: 80vh; 
        }
        
        .game-view.active {
            display: block;
        }

        .view-title {
            text-align: center;
            color: var(--color-acento-celeste);
            font-size: 2.2em;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 188, 212, 0.3);
            padding-bottom: 10px;
        }
        
        .grid-3-cols {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .asset-section, .company-section, .investment-section {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--color-secundario);
            box-shadow: 0 0 15px rgba(100, 149, 237, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%; /* Asegura que la columna se extienda */
        }
        
        .company-section { border-color: var(--color-empresa); }
        .investment-section { border-color: var(--color-inversion); }

        .asset-section h2, .company-section h2, .investment-section h2 {
            color: var(--color-secundario);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(100, 149, 237, 0.5);
            text-align: center;
            font-size: 1.5em;
        }
        
        .company-section h2 { color: var(--color-empresa); }
        .investment-section h2 { color: var(--color-inversion); }
        
        .asset-shop, .company-shop, .investment-shop {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 5px 0;
            flex-grow: 1; /* Permite que la tienda ocupe el espacio restante */
        }


        /* ================================================== */
        /* --- LAYOUT PRINCIPAL CLICKER (3 Columnas) --- */
        /* ================================================== */

        #main-game-layout {
            display: grid;
            /* Grid de 3 columnas: Panel Izq (280px), Centro (Auto), Panel Der (280px) */
            grid-template-columns: 280px auto 280px; 
            width: 100%;
            max-width: 1400px; 
            margin: 0 auto;
            min-height: calc(100vh - 60px); /* Ajusta para la barra de navegaci√≥n */
        }

        /* --- ESTILOS DEL PANEL LATERAL (Tienda/Mejoras) --- */

        .side-panel {
            background-color: #1e1e1e;
            border-right: 2px solid var(--color-acento-celeste);
            padding: 10px 5px;
            overflow-y: auto; /* Scroll dentro del panel */
            height: calc(100vh - 60px); /* Ajusta la altura para la barra de navegaci√≥n */
            position: sticky;
            top: 0;
        }

        #generadores-panel {
            border-right: none;
            border-left: 2px solid var(--color-acento-celeste);
            grid-column: 3;
        }

        /* T√≠tulo del Panel */
        .side-panel h2 {
            text-align: center;
            color: var(--color-secundario); 
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(100, 149, 237, 0.5);
            padding-bottom: 5px;
            font-size: 1.3em;
            position: sticky;
            top: 0; 
            background-color: #1e1e1e;
            z-index: 10;
        }

        /* Estilo de cada elemento de tienda */
        .tienda-item {
            border: 1px solid #333;
            background-color: #242424; 
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.1s, opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .tienda-item:hover {
            background-color: #2e2e2e;
        }

        .tienda-item p {
            font-size: 0.9em;
            margin: 3px 0;
        }

        .tienda-item h3 {
            font-size: 1em;
            color: var(--color-secundario);
            margin-bottom: 5px;
            font-weight: 900;
        }


        /* Estilo para items que no se pueden comprar (bloqueados por gating o costo) */
        .item-bloqueado {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #1a1a1a !important;
            border: 1px dashed #555;
            transform: scale(0.98);
        }

        .item-comprado {
            border: 2px solid var(--color-exito); 
            background-color: #2e3d30;
            opacity: 0.8;
            cursor: default !important;
        }
        
        .item-comprado button {
            cursor: default !important;
        }


        /* --- ESTILOS DEL √ÅREA CENTRAL (Clicker y Stats) --- */

        #clicker-area {
            padding: 20px;
            text-align: center;
            grid-column: 2; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
        }

        #clicker-area h1 {
            color: var(--color-acento-celeste);
            font-size: 2.5em;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* Secci√≥n de Informaci√≥n */
        #info-dinero {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid var(--color-acento-celeste);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
            min-width: 300px;
        }

        #info-dinero p {
            font-size: 1.4em;
            font-weight: 700;
            margin: 5px 0;
        }

        #info-dinero span {
            color: var(--color-secundario);
            font-weight: 900;
        }

        /* Bot√≥n de Clic */
        #billete-btn {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background-color: var(--color-exito);
            color: var(--color-texto-claro);
            font-size: 1.5em;
            cursor: pointer;
            border: 10px solid #2e7d32;
            box-shadow: 0 0 35px rgba(56, 142, 60, 0.9);
            transition: transform 0.1s, box-shadow 0.3s;
            outline: none;
            margin-top: 50px;
            font-weight: 900;
        }

        #billete-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 15px rgba(56, 142, 60, 1);
        }

        .emoji-billete {
            display: block;
            font-size: 6em; 
        }

        /* Botones generales */
        .tienda-item button {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            font-weight: 700;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            font-size: 0.9em;
            transition: background-color 0.1s;
        }
        
        .tienda-item button:hover:not(:disabled) {
            background-color: #00e5ff;
        }

        .tienda-item button:disabled {
            background-color: #444; 
            color: #888;
            cursor: not-allowed;
            opacity: 0.9;
        }

        /* Animaci√≥n de Clic */
        @keyframes floatAndFade {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -80px); opacity: 0; }
        }

        .animacion-clic {
            position: absolute;
            font-size: 2em;
            font-weight: 900;
            color: #ffd700; 
            text-shadow: 0 0 5px #ff8c00;
            pointer-events: none; 
            animation: floatAndFade 0.8s ease-out;
            z-index: 1000; 
        }
        
        /* Reiniciar Juego */
        #reset-btn {
            background-color: var(--color-advertencia);
            color: var(--color-texto-claro);
            padding: 10px;
            border: 2px solid var(--color-advertencia);
            border-radius: 6px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s;
            font-weight: 700;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        #reset-btn:hover {
            background-color: #ff5252;
        }
        
        /* Mensaje de Usuario */
        #user-info-footer {
            text-align: center;
            font-size: 0.8em; 
            color: #888;
            padding: 10px;
        }


        /* ================================================== */
        /* --- MEDIA QUERIES (RESPONSIVENESS) --- */
        /* ================================================== */

        @media (max-width: 900px) {
            
            #nav-bar {
                gap: 5px;
                flex-wrap: wrap; 
                padding: 10px;
            }
            #nav-bar button {
                flex-grow: 1; 
                padding: 8px 10px;
                font-size: 0.8em;
                max-width: none;
            }
            
            #main-game-layout {
                grid-template-columns: 1fr;
                padding-top: 0;
                min-height: auto; /* Permite que la vista se haga larga */
            }

            #clicker-area {
                grid-row: 1;
                padding-top: 10px;
            }

            /* Los paneles laterales ahora van abajo y se hacen est√°ticos */
            #mejoras-clic-panel {
                grid-row: 2;
                border-right: none;
                border-bottom: 2px solid var(--color-acento-celeste);
            }
            
            #generadores-panel {
                grid-column: 1;
                grid-row: 3;
                border-left: none;
                border-top: 2px solid var(--color-acento-celeste);
            }

            .side-panel {
                height: auto; 
                position: static;
                padding: 10px;
            }
            
            /* Tiendas en dos columnas para m√≥viles */
            #mejoras-clic-tienda, #generadores-tienda {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                gap: 10px;
            }

            .tienda-item {
                width: 47%; 
                margin: 5px 0;
            }
            
            #billete-btn {
                width: 200px;
                height: 200px;
                margin-top: 20px;
            }

            /* Activos/Empresas/Inversiones en dos columnas */
            .grid-3-cols {
                grid-template-columns: 1fr; 
                max-width: 90%;
            }
            
            .asset-shop, .company-shop, .investment-shop {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
                flex-grow: 0;
            }
            
            .asset-shop .tienda-item, .company-shop .tienda-item, .investment-shop .tienda-item {
                width: 47%; 
            }
        }
    </style>
</head>
<body>
    <div id="fondo-decoracion"></div>

    <div id="nav-bar">
        <button id="nav-clicker" onclick="cambiarVista('clicker')" class="active"><i class="fas fa-hand-pointer"></i> Clic & Negocios</button>
        <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-car"></i> Activos & Lujos</button>
        <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Mis Empresas</button>
        <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
        <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-pie"></i> Estad√≠sticas</button>
    </div>

    <div id="game-view-container">

        <!-- ================================================== -->
        <!-- VISTA 1: CLICKER & NEGOCIOS -->
        <!-- ================================================== -->
        <div id="view-clicker" class="game-view active">
            <div id="main-game-layout">

                <!-- Panel Izquierdo: Mejoras de Clic -->
                <div id="mejoras-clic-panel" class="side-panel">
                    <h2>Mejoras de Clic (IPC)</h2>
                    <div id="mejoras-clic-tienda">
                        <!-- Puntos de mejora de IPC se dibujan aqu√≠ -->
                    </div>
                </div>

                <!-- √Årea Central: Bot√≥n Clicker & Info -->
                <div id="clicker-area">
                    <h1 style="margin-top: 0;">¬°Convi√©rtete en Millonario!</h1>
                    
                    <div id="info-dinero">
                        <p>DINERO: <span id="dinero-actual">$0.00</span></p>
                        <p>IPC (por Clic): <span id="ipc-actual">$1.00</span></p>
                        <p>IPS (por Seg): <span id="ips-actual">$0.00 / s</span></p>
                    </div>

                    <button id="billete-btn" onclick="hacerClick(event)">
                        <span class="emoji-billete">üíµ</span>
                        HACER CLIC
                    </button>
                    
                </div>

                <!-- Panel Derecho: Generadores IPS -->
                <div id="generadores-panel" class="side-panel">
                    <h2>Generadores Pasivos (IPS)</h2>
                    <div id="generadores-tienda">
                        <!-- Generadores de IPS se dibujan aqu√≠ -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 2: ACTIVOS & LUJOS -->
        <!-- ================================================== -->
        <div id="view-assets" class="game-view">
            <h1 class="view-title">Activos y Lujos (Efectos √önicos)</h1>
            <div class="grid-3-cols">
                <div class="asset-section" style="grid-column: 1 / -1;">
                    <h2>Mis Lujos Personales</h2>
                    <div id="activos-tienda" class="asset-shop">
                        <!-- Lujos se dibujan aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 3: EMPRESAS -->
        <!-- ================================================== -->
        <div id="view-companies" class="game-view">
             <h1 class="view-title">Empresas (Ingresos Pasivos Sostenidos)</h1>
             <div class="grid-3-cols">
                 <div class="company-section" style="grid-column: 1 / -1;">
                     <h2>Fundar Negocios</h2>
                     <div id="empresas-tienda" class="company-shop">
                         <!-- Empresas se dibujan aqu√≠ -->
                     </div>
                 </div>
             </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 4: INVERSIONES -->
        <!-- ================================================== -->
        <div id="view-investments" class="game-view">
             <h1 class="view-title">Inversiones (Retorno Porcentual)</h1>
             <div class="grid-3-cols">
                 <div class="investment-section" style="grid-column: 1 / -1;">
                     <h2>Instrumentos de Inversi√≥n</h2>
                     <div id="inversiones-tienda" class="investment-shop">
                         <!-- Inversiones se dibujan aqu√≠ -->
                     </div>
                 </div>
             </div>
        </div>

        <!-- ================================================== -->
        <!-- VISTA 5: ESTAD√çSTICAS -->
        <!-- ================================================== -->
        <div id="view-stats" class="game-view">
            <h1 class="view-title">Estad√≠sticas y Gesti√≥n</h1>
            <div class="grid-3-cols">
                <div class="asset-section" style="grid-column: 1 / -1;">
                    <h2>Gesti√≥n del Juego</h2>
                    <p style="text-align: center; margin-bottom: 20px;">
                        Toda la informaci√≥n de progreso y dinero se guarda autom√°ticamente.
                    </p>
                    <button id="reset-btn" onclick="resetGame()">
                        <i class="fas fa-trash-alt"></i> REINICIAR TODO EL PROGRESO
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="user-info-footer">
        <!-- El ID del usuario se muestra aqu√≠ -->
    </div>

</body>
</html>
