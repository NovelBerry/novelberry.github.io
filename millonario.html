<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker V2.1 - C√≥digos y Guardado Local</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script type="module">
        // ====================================================================
        // NOTA: M√ìDULO DE FIREBASE (EXISTENTE)
        // Se mantiene la estructura de Firebase para el guardado en la nube.
        // Si no se define __firebase_config, usa un ID 'anon' local.
        // ====================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n global (usa las variables del entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;
        let userId = 'anon';

        /**
         * Llama a la funci√≥n de inicio principal del juego solo una vez.
         */
        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            console.log("--- INICIO DE UI GARANTIZADO. User ID:", userId, "---");
            if (typeof window.initGame === 'function') {
                window.initGame(); 
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        /**
         * Intenta la autenticaci√≥n y establece el userId.
         */
        async function attemptAuth() {
            try {
                if (initialAuthToken) {
                    const userCredential = await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await window.firebase.auth.signInAnonymously(window.auth);
                    userId = userCredential.user.uid;
                }
            } catch (error) {
                console.error("Error en autenticaci√≥n Firebase, usando ID aleatorio:", error);
                userId = crypto.randomUUID();
            }
            window.userId = userId; // Hacer el userId globalmente accesible
            handleInitGame();
        }

        // 2. Observador de estado de autenticaci√≥n (garantiza el flujo de inicio)
        window.firebase.auth.onAuthStateChanged((user) => {
             if (user) {
                userId = user.uid;
             }
             if (!isGameInitialized) {
                attemptAuth();
             }
        });
    </script>

    <script>
        // ====================================================================
        // --- L√ìGICA DEL JUEGO MILLONARIO CLICKER (JavaScript) ---
        // ====================================================================

        // --- MODELO DE ESTADO (Inicial) ---
        let estadoJuego = {
            dinero: 0,
            ipc: 1, // Ingreso por Clic
            ips: 0, // Ingreso por Segundo
            tiendas: {}, // Mejoras IPC / Generadores IPS
            activos: {}, // Lujos/Compra √∫nica
            empresas: {}, // Empresas predefinidas
            empresasPersonalizadas: [], 
            inversiones: {}, // Inversiones de retorno
            crypto: {
                bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 }
            },
            estadisticas: {
                totalClicks: 0,
                dineroPorClicks: 0,
                dineroPasivo: 0,
                dineroCrypto: 0
            },
            codigosCanjeados: [], // [MODIFICACI√ìN: NUEVO] Almacenar c√≥digos canjeados
            ultimosSegundos: Date.now()
        };
        
        // ID de la aplicaci√≥n para Firebase Firestore
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TIENDA_PATH = `/artifacts/${APP_ID}/users/${window.userId}/tiendaJuego`;
        const LOCAL_STORAGE_KEY = 'millonarioClickerSave'; // [MODIFICACI√ìN: NUEVO] Clave para Local Storage
        
        // --- CONSTANTES GLOBALES DE CRYPTO Y VOLATILIDAD ---
        const CRYPTO_FLUCTUATION_RATE = 0.05; 
        const INVERSION_FLUCTUATION_RATE = 0.02; 
        const CRYPTO_UPDATE_INTERVAL = 60000; 

        // [MODIFICACI√ìN: NUEVO] C√≥digos de Canje
        const CODIGOS_PROMOCIONALES = {
            'NOVELBERRYGOOD': 16000000000, // 16 billones
            'WINTEDSTUDIOS': 4000000000,  // 4 billones
            'DEVELOPER': 999000000         // 999 millones
        };
        

        // --- DEFINICI√ìN DE TIENDAS (Mantenidas) ---
        const mejorasClick = {
            'dedo-rapido': { nombre: 'Dedo R√°pido ü§è', costoBase: 10, costoEscalado: 1.15, ipcAumento: 1, tipo: 'ipc', icono: 'üëã' },
            'mouse-gamer': { nombre: 'Mouse Gamer üñ±Ô∏è', costoBase: 100, costoEscalado: 1.15, ipcAumento: 10, tipo: 'ipc', icono: 'üéÆ' },
            'ai-clicker': { nombre: 'Asistente IA ü§ñ', costoBase: 1000, costoEscalado: 1.15, ipcAumento: 100, tipo: 'ipc', icono: 'üí°' },
            'bot-autoclick': { nombre: 'Bot Autoclick ü¶æ', costoBase: 10000, costoEscalado: 1.15, ipcAumento: 1000, tipo: 'ipc', icono: 'ü§ñ' }
        };

        const generadoresIPS = {
            'puesto-limonada': { nombre: 'Puesto de Limonada üçã', costoBase: 50, costoEscalado: 1.15, ipsGenerado: 0.5, tipo: 'ips', icono: 'ü•§' },
            'vendedor-ambulante': { nombre: 'Vendedor Ambulante üíº', costoBase: 500, costoEscalado: 1.15, ipsGenerado: 5, tipo: 'ips', icono: 'üö∂' },
            'tienda-online': { nombre: 'Tienda Online üíª', costoBase: 5000, costoEscalado: 1.15, ipsGenerado: 50, tipo: 'ips', icono: 'üõí' },
            'granja-solar': { nombre: 'Granja Solar ‚òÄÔ∏è', costoBase: 50000, costoEscalado: 1.15, ipsGenerado: 500, tipo: 'ips', icono: '‚ö°' },
            'bienes-raices': { nombre: 'Bienes Ra√≠ces üèòÔ∏è', costoBase: 500000, costoEscalado: 1.15, ipsGenerado: 5000, tipo: 'ips', icono: 'üè†' }
        };
        
        const activosLujos = {
             'coche-lujo': { nombre: 'Coche Deportivo üèéÔ∏è', costo: 50000, efecto: 'Aumenta IPC en 500', ipcAumento: 500, comprado: false, icono: 'üèéÔ∏è' },
             'apartamento': { nombre: 'Apartamento de Lujo üèôÔ∏è', costo: 500000, efecto: 'Aumenta IPS en 50', ipsAumento: 50, comprado: false, icono: 'üèôÔ∏è' },
             'yate': { nombre: 'Yate Privado üõ•Ô∏è', costo: 5000000, efecto: 'Duplica todo el IPC', multiplicadorIPC: 2, comprado: false, icono: 'üõ•Ô∏è' },
             'isla-privada': { nombre: 'Isla Privada üèùÔ∏è', costo: 50000000, efecto: 'Multiplica IPS por 1.5', multiplicadorIPS: 1.5, comprado: false, icono: 'üèùÔ∏è' }
        };
        
        const empresasVistas = {
             'restaurante': { nombre: 'Restaurante Exclusivo üçΩÔ∏è', costo: 1000000, ipsGenerado: 1000, vecesComprado: 0, icono: 'üçΩÔ∏è' },
             'tech-startup': { nombre: 'Tech Startup üöÄ', costo: 10000000, ipsGenerado: 10000, vecesComprado: 0, icono: 'üöÄ' },
             'cadena-hoteles': { nombre: 'Cadena de Hoteles üè®', costo: 100000000, ipsGenerado: 100000, vecesComprado: 0, icono: 'üè®' },
             'aerolinea-lowcost': { nombre: 'Aerol√≠nea Low Cost ‚úàÔ∏è', costo: 1000000000, ipsGenerado: 1000000, vecesComprado: 0, icono: '‚úàÔ∏è' }
        };

        const opcionesCrearEmpresa = [
            { id: 0, nombre: 'Red Social Innovadora', ips: 15000, costo: 15000000, icono: 'üì±' },
            { id: 1, nombre: 'Plataforma de E-Learning', ips: 12000, costo: 12000000, icono: 'üéì' },
            { id: 2, nombre: 'Consultora de Ciberseguridad', ips: 18000, costo: 20000000, icono: 'üõ°Ô∏è' },
            { id: 3, nombre: 'F√°brica de Robots de Limpieza', ips: 10000, costo: 10000000, icono: 'ü§ñ' },
            { id: 4, nombre: 'Cadena de Cafeter√≠as Tem√°ticas', ips: 8000, costo: 8000000, icono: '‚òï' },
            { id: 5, nombre: 'Servicio de Suscripci√≥n Gourmet', ips: 9000, costo: 9000000, icono: 'üì¶' },
            { id: 6, nombre: 'Estudio de Videojuegos Indie', ips: 11000, costo: 11000000, icono: 'üïπÔ∏è' },
            { id: 7, nombre: 'Agencia de Viajes Espaciales', ips: 25000, costo: 30000000, icono: 'üöÄ' }
        ];
        
        const inversionesVista = {
             'bonos-gobierno': { nombre: 'Bonos Gobierno üèõÔ∏è', costo: 100000, retorno: 0.05, vecesComprado: 0, tipo: 'retorno', icono: 'üèõÔ∏è' }, 
             'fondo-indexado': { nombre: 'Fondo Indexado S&P üìà', costo: 500000, retorno: 0.08, vecesComprado: 0, tipo: 'retorno', icono: 'üìä' }, 
             'inmo-comercial': { nombre: 'Inmuebles Comerciales üè¢', costo: 1500000, retorno: 0.1, vecesComprado: 0, tipo: 'retorno', icono: 'üè¢' }, 
             'crypto-mining': { nombre: 'Crypto Mining ‚õèÔ∏è', costo: 2000000, retorno: 0.12, vecesComprado: 0, tipo: 'retorno', icono: '‚õèÔ∏è' }, 
             'commodities': { nombre: 'Commodities (Oro/Petr√≥leo) üõ¢Ô∏è', costo: 5000000, retorno: 0.15, vecesComprado: 0, tipo: 'retorno', icono: 'üíé' }, 
             'private-equity': { nombre: 'Private Equity üîí', costo: 15000000, retorno: 0.18, vecesComprado: 0, tipo: 'retorno', icono: 'üíº' }, 
             'venture-capital': { nombre: 'Venture Capital üí∏', costo: 50000000, retorno: 0.22, vecesComprado: 0, tipo: 'retorno', icono: 'üí∞' }, 
             'fondos-hedge': { nombre: 'Hedge Funds Globales üåç', costo: 100000000, retorno: 0.25, vecesComprado: 0, tipo: 'retorno', icono: 'üß≠' } 
        };


        // --- UTILIDADES (Mantenidas) ---
        
        /** Formatea un n√∫mero como moneda. */
        function formatDinero(num, decimales = 2) {
            num = parseFloat(num);
            if (num === 0) return '$0.00';
            const sign = num < 0 ? '-' : '';
            const absNum = Math.abs(num);
            
            if (absNum < 1000) return sign + '$' + absNum.toFixed(decimales);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Q', 'S', 'O', 'N', 'D', 'UD'];
            const tier = Math.floor(Math.log10(absNum) / 3);
            const suffix = suffixes[tier] || 'E';
            const scale = Math.pow(10, tier * 3);
            const scaled = absNum / scale;

            const formatted = scaled.toFixed(scaled % 1 !== 0 || tier > 0 ? decimales : 0);
            return sign + '$' + formatted + suffix;
        }
        
        /** Formatea un n√∫mero para crypto (m√°s decimales para precisi√≥n) */
        function formatCrypto(num, decimales = 6) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        /** Calcula el costo de la siguiente compra. */
        function calcularCosto(base, escalado, nivel) {
            return base * Math.pow(escalado, nivel);
        }

        /** Muestra una animaci√≥n de texto cuando se hace clic o se genera dinero. */
        function mostrarAnimacion(monto, x, y, esCrypto = false) {
            const anim = document.createElement('div');
            anim.textContent = `${monto > 0 ? '+' : ''}${formatDinero(monto)}`;
            anim.classList.add('animacion-clic');
            
            if (esCrypto) {
                 anim.classList.add('animacion-crypto');
            }
            
            // Posicionar con respecto al billete
            anim.style.left = `${x}px`;
            anim.style.top = `${y}px`;

            document.body.appendChild(anim);

            // Eliminar despu√©s de la animaci√≥n
            anim.addEventListener('animationend', () => {
                anim.remove();
            });
        }

        // --- FIREBASE y LOCAL STORAGE (Guardar/Cargar - Cloud Save + Local Save) ---
        
        /** Guarda el estado en Local Storage y Cloud Save. */
        async function guardarEstado() {
            // [MODIFICACI√ìN: UNIFICACI√ìN DE DATOS A GUARDAR]
            const dataToSave = {
                dinero: estadoJuego.dinero,
                ipc: estadoJuego.ipc,
                ips: estadoJuego.ips,
                tiendas: estadoJuego.tiendas,
                activos: estadoJuego.activos,
                empresas: estadoJuego.empresas,
                empresasPersonalizadas: estadoJuego.empresasPersonalizadas, 
                inversiones: estadoJuego.inversiones,
                crypto: estadoJuego.crypto,
                estadisticas: estadoJuego.estadisticas,
                codigosCanjeados: estadoJuego.codigosCanjeados, // [MODIFICACI√ìN: A√ëADIDO]
                ultimosSegundos: Date.now() // Actualizar el tiempo de guardado
            };
            
            // 1. Guardar en Local Storage (Guardado en Navegador)
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                // console.log("Estado guardado en Local Storage con √©xito.");
            } catch (e) {
                console.error("Error guardando el estado en Local Storage: ", e);
            }
            
            // 2. Guardar en Cloud Save (Firebase)
            if (window.db && window.userId && window.userId !== 'anon') { // Solo si hay autenticaci√≥n real
                 const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
                 try {
                     await window.firebase.firestore.setDoc(docRef, dataToSave);
                     // console.log("Estado guardado en Cloud Save con √©xito.");
                 } catch (e) {
                     console.error("Error guardando el estado en Cloud Save: ", e);
                 }
            }
        }
        
        /** Carga el estado: prioriza Cloud Save, si falla usa Local Storage. */
        async function cargarEstado() {
            let loadedData = null;
            let loadedFrom = 'default';

            // 1. Intentar cargar desde Cloud Save (Firebase)
            if (window.db && window.userId && window.userId !== 'anon') {
                 const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
                 try {
                     const docSnap = await window.firebase.firestore.getDoc(docRef);
                     if (docSnap.exists()) {
                         loadedData = docSnap.data();
                         loadedFrom = 'cloud';
                     }
                 } catch (e) {
                     console.error("Error cargando el estado desde Cloud Save: ", e);
                 }
            }
            
            // 2. Si Cloud Save fall√≥ o est√° vac√≠o, intentar cargar desde Local Storage
            if (!loadedData) {
                try {
                    const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (localData) {
                        loadedData = JSON.parse(localData);
                        loadedFrom = 'local';
                    }
                } catch (e) {
                    console.error("Error cargando el estado desde Local Storage: ", e);
                }
            }

            if (loadedData) {
                console.log(`Estado cargado desde: ${loadedFrom}.`);
                // Mapear los datos cargados al estadoJuego (con conversi√≥n de tipos y validaci√≥n)
                estadoJuego = {
                    ...estadoJuego,
                    ...loadedData,
                    dinero: parseFloat(loadedData.dinero || 0),
                    ipc: parseFloat(loadedData.ipc || 1),
                    ips: parseFloat(loadedData.ips || 0),
                    ultimosSegundos: parseFloat(loadedData.ultimosSegundos || Date.now())
                };
                // Asegurar que las estructuras anidadas existan
                estadoJuego.tiendas = loadedData.tiendas || estadoJuego.tiendas;
                estadoJuego.activos = loadedData.activos || estadoJuego.activos;
                estadoJuego.empresas = loadedData.empresas || estadoJuego.empresas;
                estadoJuego.empresasPersonalizadas = loadedData.empresasPersonalizadas || estadoJuego.empresasPersonalizadas;
                estadoJuego.inversiones = loadedData.inversiones || estadoJuego.inversiones;
                estadoJuego.crypto = loadedData.crypto || estadoJuego.crypto;
                estadoJuego.estadisticas = loadedData.estadisticas || estadoJuego.estadisticas;
                estadoJuego.codigosCanjeados = loadedData.codigosCanjeados || []; // [MODIFICACI√ìN: A√ëADIDO]

                // Forzar el c√°lculo del progreso offline
                calcularProgresoOffline();
            } else {
                 // Si no existe guardado, guardar el estado predeterminado.
                 await guardarEstado();
            }
        }
        
        // --- L√ìGICA DE JUEGO PRINCIPAL (Mantenida) ---

        /** * Inicializa el estado de las tiendas si es la primera vez. */
        function inicializarTiendas(tiendas, estadoKey) {
            for (const id in tiendas) {
                if (!estadoJuego[estadoKey][id]) {
                    estadoJuego[estadoKey][id] = { 
                        nivel: 0, 
                        vecesComprado: 0,
                        comprado: tiendas[id].comprado || false, 
                        valorTotal: 0 
                    };
                }
            }
        }
        
        function calcularProgresoOffline() {
            const now = Date.now();
            const elapsedSeconds = (now - estadoJuego.ultimosSegundos) / 1000;
            if (elapsedSeconds > 5) { 
                const dineroGanado = estadoJuego.ips * elapsedSeconds;
                estadoJuego.dinero += dineroGanado;
                console.log(`Ganancia offline: +${formatDinero(dineroGanado)} durante ${Math.round(elapsedSeconds)} segundos.`);
                estadoJuego.estadisticas.dineroPasivo += dineroGanado;
            }
            estadoJuego.ultimosSegundos = now;
        }

        function actualizarUI() {
            document.getElementById('dinero-actual').textContent = formatDinero(estadoJuego.dinero);
            document.getElementById('ipc-actual').textContent = formatDinero(estadoJuego.ipc);
            document.getElementById('ips-actual').textContent = formatDinero(estadoJuego.ips) + " / s";
            
            // Actualizar todas las vistas
            dibujarTodasLasTiendas();
            dibujarCryptoView();
            dibujarStatsView();
            
            // Mostrar User ID en el pie de p√°gina
            document.getElementById('user-info-footer').textContent = `ID de Sesi√≥n: ${window.userId}`;
        }
        
        /** * Llama a las funciones de dibujo de todas las vistas activas/paneles. */
        function dibujarTodasLasTiendas() {
            dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas'); 
            dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas'); 
            
            dibujarActivos();
            dibujarEmpresas();
            dibujarInversiones();
            actualizarBotonesVista();
        }

        /** Actualiza el estado de los botones de navegaci√≥n seg√∫n la vista activa */
        function actualizarBotonesVista() {
             const vistaActivaElement = document.querySelector('.game-view.active');
             if (!vistaActivaElement) return;
             
             const vistaActiva = vistaActivaElement.id.replace('view-', '');
             document.querySelectorAll('#nav-bar button').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.id.includes(vistaActiva)) {
                     btn.classList.add('active');
                 }
             });
        }

        /** L√≥gica de fluctuaci√≥n de Crypto (Volatilidad) */
        function fluctuarCrypto() {
            const factor = Math.random() * (CRYPTO_FLUCTUATION_RATE * 2) - CRYPTO_FLUCTUATION_RATE; 
            
            // Fluctaci√≥n de Bitcoin
            const oldBtcValue = estadoJuego.crypto.bitcoin.valorActual;
            let newBtcValue = oldBtcValue * (1 + factor);
            newBtcValue = Math.max(1, newBtcValue); 
            estadoJuego.crypto.bitcoin.valorActual = newBtcValue;
            
            // Fluctaci√≥n de Ethereum 
            const oldEthValue = estadoJuego.crypto.ethereum.valorActual;
            let newEthValue = oldEthValue * (1 + (factor * 1.2));
            newEthValue = Math.max(1, newEthValue);
            estadoJuego.crypto.ethereum.valorActual = newEthValue;
            
            if (document.getElementById('view-crypto').classList.contains('active')) {
                 dibujarCryptoView();
            }
        }
        
        /** L√≥gica de fluctuaci√≥n de Inversiones (Volatilidad) */
        function fluctuarInversiones() {
            for (const id in inversionesVista) {
                const estado = estadoJuego.inversiones[id];
                if (estado && estado.valorTotal > 0) {
                    const factor = Math.random() * (INVERSION_FLUCTUATION_RATE * 2) - INVERSION_FLUCTUATION_RATE;
                    const cambio = estado.valorTotal * factor;
                    
                    estado.valorTotal += cambio;
                    estado.valorTotal = Math.max(0, estado.valorTotal); 
                    
                    recalcularIPS();
                }
            }
            if (document.getElementById('view-investments').classList.contains('active')) {
                 dibujarInversiones();
            }
        }

        /** L√≥gica para el bucle de ingresos pasivos (IPS) */
        function bucleJuego() {
            // [REVISADO: El IPS se a√±ade a 'dinero' y 'dineroPasivo' cada segundo sin fallos.]
            const ganancia = estadoJuego.ips;
            estadoJuego.dinero += ganancia;
            estadoJuego.estadisticas.dineroPasivo += ganancia;
            actualizarUI();
        }

        // --- L√ìGICA DE VISTAS (Mantenidas) ---

        /** * Dibuja los items de mejora o generadores. (Usado por las columnas IPC/IPS) */
        function dibujarTienda(items, contenedorId, estadoKey) {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) return;

            contenedor.innerHTML = '';
            
            for (const id in items) {
                const item = items[id];
                const nivel = estadoJuego[estadoKey][id]?.nivel || 0;
                const costo = calcularCosto(item.costoBase, item.costoEscalado, nivel);
                const puedeComprar = estadoJuego.dinero >= costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                let efectoTexto = '';
                if (item.tipo === 'ipc') {
                    efectoTexto = `+${formatDinero(item.ipcAumento)} IPC por nivel`;
                } else if (item.tipo === 'ips') {
                    efectoTexto = `+${formatDinero(item.ipsGenerado)} IPS por nivel`;
                }
                
                elemento.innerHTML = `
                    <h3>${item.icono} ${item.nombre}</h3>
                    <p>Nivel: <span style="color: var(--color-empresa);">${nivel}</span></p>
                    <p>Efecto: ${efectoTexto}</p>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                    <button onclick="comprarItem('${id}', '${estadoKey}', '${item.tipo}')" ${!puedeComprar ? 'disabled' : ''}>
                        Comprar (Nivel ${nivel + 1})
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Activos (Compra √∫nica)
        function dibujarActivos() {
            const contenedor = document.getElementById('activos-tienda');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            for (const id in activosLujos) {
                const item = activosLujos[id];
                const estado = estadoJuego.activos[id] || { comprado: false };
                const comprado = estado.comprado;
                const puedeComprar = !comprado && estadoJuego.dinero >= item.costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item asset-item ${comprado ? 'item-comprado' : ''} ${!puedeComprar && !comprado ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                elemento.innerHTML = `
                    <h3>${item.icono || '‚ú®'} ${item.nombre}</h3>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(item.costo)}</span></p>
                    <p>Efecto: <span style="color: var(--color-inversion);">${item.efecto}</span></p>
                    <button onclick="comprarActivo('${id}')" ${comprado || !puedeComprar ? 'disabled' : ''}>
                        ${comprado ? 'Comprado' : 'Comprar Lujo'}
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Empresas (Generan IPS)
        function dibujarEmpresas() {
             const contenedor = document.getElementById('empresas-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';
             
             // --- 1. BOT√ìN DE CREAR MI EMPRESA ---
             const crearBtn = document.createElement('div');
             crearBtn.className = 'tienda-item create-company-item';
             crearBtn.style.borderLeft = '5px solid var(--color-secundario)';
             crearBtn.innerHTML = `
                 <h3><i class="fas fa-plus-circle"></i> Crear Mi Empresa</h3>
                 <p>¬°Define tu propio imperio! Nombre, tipo y comienza a generar ingresos pasivos.</p>
                 <button onclick="mostrarModalCrearEmpresa()">
                     Elegir Concepto y Fundar
                 </button>
             `;
             contenedor.appendChild(crearBtn);

             // --- 2. EMPRESAS PERSONALIZADAS ---
             estadoJuego.empresasPersonalizadas.forEach((empresa, index) => {
                 const costoReinversion = empresa.ips * 5; 
                 const puedeReinvertir = estadoJuego.dinero >= costoReinversion;
                 
                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item personal-company-item`;
                 elemento.style.borderLeft = '5px solid var(--color-exito)';
                 
                 elemento.innerHTML = `
                     <h3>${empresa.icono || 'üè¢'} ${empresa.nombrePersonalizado}</h3>
                     <p>Concepto: ${empresa.nombreBase}</p>
                     <p>IPS Generado: <span style="font-weight: 700; color: var(--color-exito);">${formatDinero(empresa.ips)} / s</span></p>
                     <p>
                         <button onclick="reinvertirEmpresaPersonalizada(${index})" ${!puedeReinvertir ? 'disabled' : ''} style="width: 100%; padding: 5px; margin-top: 5px; background-color: var(--color-empresa); color: var(--color-fondo-oscuro); border: none; border-radius: 4px; cursor: pointer;">
                             Reinvertir (+25% IPS) - ${formatDinero(costoReinversion)}
                         </button>
                     </p>
                 `;
                 contenedor.appendChild(elemento);
             });
             
             // --- 3. EMPRESAS PREDEFINIDAS ---
             for (const id in empresasVistas) {
                 const item = empresasVistas[id];
                 const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
                 
                 const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item company-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const ipsTotal = estado.vecesComprado * item.ipsGenerado;

                 elemento.innerHTML = `
                     <h3>${item.icono || 'üè¢'} ${item.nombre}</h3>
                     <p>Compradas: <span style="color: var(--color-empresa);">${estado.vecesComprado}</span></p>
                     <p>IPS Total: <span style="font-weight: 700;">${formatDinero(ipsTotal)} / s</span></p>
                     <p>Costo Pr√≥xima: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarEmpresa('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Fundar Nueva (IPS: +${formatDinero(item.ipsGenerado)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        // Dibujo de Inversiones (Generan Retorno %)
        function dibujarInversiones() {
             const contenedor = document.getElementById('inversiones-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
                 
                 const costo = item.costo; 
                 const puedeComprar = estadoJuego.dinero >= costo;
                 
                 const valorInicialTotal = estado.vecesComprado * item.costo;
                 const perdidaGanancia = estado.valorTotal - valorInicialTotal;
                 const retornoIPS = estado.valorTotal * item.retorno / 10; // 0.5% por segundo (ejemplo)

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item investment-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 elemento.innerHTML = `
                     <h3>${item.icono || 'üìà'} ${item.nombre}</h3>
                     <p>Valor Total: <span style="color: var(--color-acento-celeste);">${formatDinero(estado.valorTotal)}</span></p>
                     <p>Retorno IPS: <span style="font-weight: 700; color: var(--color-inversion);">${formatDinero(retornoIPS)} / s</span></p>
                     <p>P√©rdida/Ganancia: 
                        <span class="${perdidaGanancia >= 0 ? 'text-success' : 'text-danger'}">
                             ${formatDinero(perdidaGanancia, 2)}
                        </span>
                     </p>
                     <p>Costo Paquete: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarInversion('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Invertir (+${formatDinero(item.costo)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        // Dibujo de Crypto View
        function dibujarCryptoView() {
            const contenedor = document.getElementById('crypto-grid');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            const cryptos = [
                { id: 'bitcoin', nombre: 'Bitcoin (BTC)', icono: '‚Çø' },
                { id: 'ethereum', nombre: 'Ethereum (ETH)', icono: 'Œû' }
            ];

            cryptos.forEach(({ id, nombre, icono }) => {
                const cryptoData = estadoJuego.crypto[id];
                const valorActual = cryptoData.valorActual;
                const cantidad = cryptoData.cantidad;
                
                const valorActualTotal = cantidad * valorActual;
                const perdidaGanancia = cantidad > 0 ? (valorActualTotal - (cantidad * cryptoData.costoPromedio)) : 0;
                
                const puedeVender = cantidad > 0;
                const puedeComprar = estadoJuego.dinero >= valorActual;

                const elemento = document.createElement('div');
                elemento.className = 'crypto-item';
                
                elemento.innerHTML = `
                    <div class="crypto-header">
                        <span class="crypto-icon">${icono}</span>
                        <h3>${nombre}</h3>
                    </div>
                    <div class="crypto-info">
                        <p>Valor Actual: <span class="crypto-price">${formatDinero(valorActual, 2)}</span></p>
                        <p>Tu Cantidad: <span class="crypto-amount">${formatCrypto(cantidad)}</span></p>
                        <p>Costo Promedio: <span class="crypto-avg">${formatDinero(cryptoData.costoPromedio, 2)}</span></p>
                        <p>Ganancia No Realizada: 
                            <span class="${perdidaGanancia >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatDinero(perdidaGanancia, 2)}
                            </span>
                        </p>
                    </div>
                    <div class="crypto-actions">
                        <button onclick="comprarCrypto('${id}')" ${!puedeComprar ? 'disabled' : ''} class="buy-btn">
                            Comprar 1 (${formatDinero(valorActual, 2)})
                        </button>
                        <button onclick="venderCrypto('${id}')" ${!puedeVender ? 'disabled' : ''} class="sell-btn">
                            Vender 1 (${formatDinero(valorActual, 2)})
                        </button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
        }
        
        // Dibujo de Estad√≠sticas
        function dibujarStatsView() {
            const stats = estadoJuego.estadisticas;
            const totalDineroGanado = stats.dineroPorClicks + stats.dineroPasivo + stats.dineroCrypto;
            
            document.getElementById('stat-total-clicks').textContent = stats.totalClicks.toLocaleString('es-ES');
            document.getElementById('stat-dinero-clicks').textContent = formatDinero(stats.dineroPorClicks);
            document.getElementById('stat-dinero-pasivo').textContent = formatDinero(stats.dineroPasivo);
            document.getElementById('stat-dinero-crypto').textContent = formatDinero(stats.dineroCrypto);
            
            document.getElementById('stat-total-ganado').textContent = formatDinero(totalDineroGanado);
        }

        // --- FUNCIONES ACCIONABLES (GLOBALES) ---
        
        /** * Funci√≥n p√∫blica para el bot√≥n de clic principal. */
        window.hacerClick = function(e) {
            estadoJuego.dinero += estadoJuego.ipc;
            
            estadoJuego.estadisticas.totalClicks++;
            estadoJuego.estadisticas.dineroPorClicks += estadoJuego.ipc;
            
            const x = e.clientX;
            const y = e.clientY;
            mostrarAnimacion(estadoJuego.ipc, x, y);

            actualizarUI();
            // No guardar aqu√≠, se guarda en el intervalo.
        }

        /**
         * Funci√≥n p√∫blica para comprar Mejoras/Generadores IPS. (Comprobado: Funciona)
         */
        window.comprarItem = function(id, estadoKey, tipo) {
            const item = (tipo === 'ipc' ? mejorasClick[id] : generadoresIPS[id]);
            const estadoActual = estadoJuego[estadoKey][id] || { nivel: 0 };
            const costo = calcularCosto(item.costoBase, item.costoEscalado, estadoActual.nivel);

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estadoActual.nivel++;
                estadoJuego[estadoKey][id] = estadoActual;

                recalcularIPC(); 
                recalcularIPS();
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
            }
        }
        
        /**
         * Funci√≥n p√∫blica para comprar Activos/Lujos. (Comprobado: Funciona)
         */
        window.comprarActivo = function(id) {
            const item = activosLujos[id];
            const estado = estadoJuego.activos[id] || { comprado: false };
            
            if (!estado.comprado && estadoJuego.dinero >= item.costo) {
                estadoJuego.dinero -= item.costo;
                estado.comprado = true;
                estadoJuego.activos[id] = estado;
                
                recalcularIPC(); 
                recalcularIPS();
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
            }
        }
        
        /**
         * Funci√≥n p√∫blica para comprar Empresas predefinidas. (Comprobado: Funciona)
         */
        window.comprarEmpresa = function(id) {
            const item = empresasVistas[id];
            const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
            const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estadoJuego.empresas[id] = estado;
                
                recalcularIPS();
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
            }
        }

        /**
         * Funci√≥n p√∫blica para comprar Inversiones. (Comprobado: Funciona)
         */
        window.comprarInversion = function(id) {
            const item = inversionesVista[id];
            const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
            const costo = item.costo; 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estado.valorTotal += costo; 
                estadoJuego.inversiones[id] = estado;
                
                recalcularIPS(); 
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
            }
        }
        
        /**
         * Funci√≥n p√∫blica para comprar 1 unidad de Crypto. (Comprobado: Funciona)
         */
        window.comprarCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;
            
            if (estadoJuego.dinero >= valor) {
                estadoJuego.dinero -= valor;
                
                const nuevaCantidad = crypto.cantidad + 1;
                const costoTotalAnterior = crypto.cantidad * crypto.costoPromedio;
                const nuevoCostoTotal = costoTotalAnterior + valor;
                
                crypto.costoPromedio = nuevoCostoTotal / nuevaCantidad;
                crypto.cantidad = nuevaCantidad;

                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
                showModal(`Compraste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Compra Exitosa', false);
            } else {
                 showModal(`Necesitas ${formatDinero(valor, 2)} para comprar 1 unidad de ${id.toUpperCase()}.`, 'Dinero Insuficiente', false);
            }
        }

        /**
         * Funci√≥n p√∫blica para vender 1 unidad de Crypto. (Comprobado: Funciona)
         */
        window.venderCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;

            if (crypto.cantidad > 0) {
                const gananciaPerdida = valor - crypto.costoPromedio;
                
                estadoJuego.dinero += valor;
                crypto.cantidad -= 1;
                
                if (crypto.cantidad === 0) {
                     crypto.costoPromedio = 0;
                } 
                
                estadoJuego.estadisticas.dineroCrypto += gananciaPerdida;
                
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
                showModal(`Vendiste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Venta Exitosa', false);
            }
        }
        
        // --- L√ìGICA DE CREACI√ìN DE EMPRESA PERSONALIZADA (Mantenida) ---
        window.mostrarModalCrearEmpresa = function() {
            const modalContent = document.getElementById('company-create-content');
            modalContent.innerHTML = ''; 
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = 'company-name-input';
            nameInput.placeholder = 'Ej: Mi Empresa de Cohetes S.A.';
            nameInput.maxLength = 30;
            nameInput.style.cssText = 'width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: white;';
            
            const conceptSelect = document.createElement('select');
            conceptSelect.id = 'company-concept-select';
            conceptSelect.style.cssText = 'width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: white;';
            
            opcionesCrearEmpresa.forEach((opcion, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${opcion.nombre} (IPS: ${formatDinero(opcion.ips)}, Costo: ${formatDinero(opcion.costo)})`;
                conceptSelect.appendChild(option);
            });

            const fundarButton = document.createElement('button');
            fundarButton.textContent = '¬°Fundar Mi Empresa!';
            fundarButton.onclick = () => crearMiEmpresa(nameInput.value, parseInt(conceptSelect.value));
            fundarButton.style.cssText = 'padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; background-color: var(--color-empresa); color: var(--color-fondo-oscuro);';
            
            modalContent.appendChild(nameInput);
            modalContent.appendChild(conceptSelect);
            modalContent.appendChild(fundarButton);

            showModal('Define el nombre y el concepto de tu empresa', 'Crear Empresa', false, true); 
        }

        window.crearMiEmpresa = function(nombre, conceptoIndex) {
            const opcion = opcionesCrearEmpresa[conceptoIndex];
            if (!opcion) return;

            if (!nombre || nombre.trim() === '') {
                showModal('Debes darle un nombre a tu empresa. Intenta de nuevo.', 'Error', false); 
                return;
            }
            
            if (estadoJuego.dinero >= opcion.costo) {
                estadoJuego.dinero -= opcion.costo;
                
                const nuevaEmpresa = {
                    id: Date.now(),
                    nombrePersonalizado: nombre.substring(0, 30),
                    nombreBase: opcion.nombre,
                    ips: opcion.ips,
                    costoBase: opcion.costo,
                    icono: opcion.icono
                };
                
                estadoJuego.empresasPersonalizadas.push(nuevaEmpresa);
                
                document.getElementById('custom-modal').style.display = 'none';
                
                recalcularIPS();
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
                showModal(`¬°Felicidades! Has fundado "${nuevaEmpresa.nombrePersonalizado}".`, '√âxito de Fundaci√≥n', false);
            } else {
                showModal(`Necesitas ${formatDinero(opcion.costo)} para fundar esta empresa.`, 'Dinero Insuficiente', false);
            }
        }
        
        window.reinvertirEmpresaPersonalizada = function(index) {
            const empresa = estadoJuego.empresasPersonalizadas[index];
            if (!empresa) return;

            const costoReinversion = empresa.ips * 5; 
            
            if (estadoJuego.dinero >= costoReinversion) {
                estadoJuego.dinero -= costoReinversion;
                empresa.ips *= 1.25; 
                
                recalcularIPS();
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
                showModal(`¬°Reinversi√≥n exitosa! El IPS de "${empresa.nombrePersonalizado}" aument√≥ un 25%.`, 'Reinversi√≥n', false);
            } else {
                showModal(`Necesitas ${formatDinero(costoReinversion)} para reinvertir en "${empresa.nombrePersonalizado}".`, 'Dinero Insuficiente', false);
            }
        }
        
        // --- L√ìGICA DE CANJEAR C√ìDIGO [MODIFICACI√ìN: A√ëADIDO] ---

        window.mostrarModalCodigo = function() {
            const modalContent = document.getElementById('company-create-content');
            modalContent.innerHTML = '';
            
            const inputLabel = document.createElement('p');
            inputLabel.textContent = 'Introduce tu c√≥digo de promoci√≥n:';
            inputLabel.style.marginBottom = '10px';
            inputLabel.style.textAlign = 'left';
            
            const codeInput = document.createElement('input');
            codeInput.type = 'text';
            codeInput.id = 'promo-code-input';
            codeInput.placeholder = 'C√ìDIGO';
            codeInput.maxLength = 30;
            codeInput.style.cssText = 'width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: white; text-transform: uppercase;';
            
            const redeemButton = document.createElement('button');
            redeemButton.textContent = 'Canjear C√≥digo';
            redeemButton.onclick = () => canjearCodigo(codeInput.value);
            redeemButton.style.cssText = 'padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; background-color: var(--color-empresa); color: var(--color-fondo-oscuro);';
            
            modalContent.appendChild(inputLabel);
            modalContent.appendChild(codeInput);
            modalContent.appendChild(redeemButton);

            showModal('C√≥digos de Promoci√≥n', 'Canjear C√≥digo', false, true); 
        }

        window.canjearCodigo = function(codigo) {
            const codigoUpper = codigo.trim().toUpperCase();
            
            if (estadoJuego.codigosCanjeados.includes(codigoUpper)) {
                 showModal(`El c√≥digo ${codigoUpper} ya ha sido canjeado.`, 'Error de C√≥digo', false);
                 return;
            }
            
            const monto = CODIGOS_PROMOCIONALES[codigoUpper];
            
            if (monto) {
                estadoJuego.dinero += monto;
                estadoJuego.codigosCanjeados.push(codigoUpper);
                
                // Cerrar el modal personalizado y mostrar el de √©xito
                document.getElementById('custom-modal').style.display = 'none';
                
                actualizarUI();
                // No guardar aqu√≠, se guarda en el intervalo.
                showModal(`¬°C√≥digo canjeado con √©xito! Recibiste ${formatDinero(monto)}.`, '¬°√âxito!', false);
            } else {
                 showModal(`El c√≥digo ${codigoUpper} es inv√°lido.`, 'Error de C√≥digo', false);
            }
        }
        
        // --- FIN L√ìGICA DE CANJEAR C√ìDIGO ---

        
        /** Recalcula el IPC total base + multiplicadores. (Mantenida) */
        function recalcularIPC() {
            let baseIPC = 1; 
            
            for (const id in mejorasClick) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 if (mejorasClick[id].tipo === 'ipc') {
                    baseIPC += nivel * mejorasClick[id].ipcAumento;
                 }
            }
            
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado) {
                    if (activosLujos[id].ipcAumento) {
                         baseIPC += activosLujos[id].ipcAumento;
                    }
                }
            }

            estadoJuego.ipc = baseIPC;
            
            let multiplicador = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPC) {
                    multiplicador *= activosLujos[id].multiplicadorIPC;
                }
            }
            
            estadoJuego.ipc = estadoJuego.ipc * multiplicador;
        }

        /** Recalcula el IPS total de todas las fuentes. (Mantenida) */
        function recalcularIPS() {
            let totalIPS = 0;

            // 1. IPS de Generadores (Tienda)
            for (const id in generadoresIPS) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 totalIPS += nivel * generadoresIPS[id].ipsGenerado;
            }
            
            // 2. IPS de Activos Fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].ipsAumento) {
                    totalIPS += activosLujos[id].ipsAumento;
                }
            }

            // 3. IPS de Empresas PREDEFINIDAS
            for (const id in empresasVistas) {
                 const vecesComprado = estadoJuego.empresas[id]?.vecesComprado || 0;
                 totalIPS += vecesComprado * empresasVistas[id].ipsGenerado;
            }
            
            // 3b. IPS de Empresas PERSONALIZADAS 
            estadoJuego.empresasPersonalizadas.forEach(empresa => {
                totalIPS += empresa.ips;
            });

            
            // 4. IPS de Inversiones (porcentaje de valor total)
            for (const id in inversionesVista) {
                const inversion = inversionesVista[id];
                const estado = estadoJuego.inversiones[id] || { valorTotal: 0 };
                totalIPS += estado.valorTotal * inversion.retorno / 10; 
            }
            
            // Aplicar multiplicadores IPS de Activos
            let multiplicadorIPS = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPS) {
                    multiplicadorIPS *= activosLujos[id].multiplicadorIPS;
                }
            }
            
            totalIPS = totalIPS * multiplicadorIPS;
            estadoJuego.ips = totalIPS;
        }

        /**
         * Funci√≥n p√∫blica para cambiar la vista entre Clicker, Activos, Empresas, etc. (Mantenida)
         */
        window.cambiarVista = function(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${vista}`).classList.add('active');
            
            dibujarTodasLasTiendas(); 
            if (vista === 'crypto') dibujarCryptoView();
            if (vista === 'stats') dibujarStatsView();

            actualizarBotonesVista();
        }

        /**
         * Funci√≥n de inicializaci√≥n principal del juego.
         */
        window.initGame = async function() {
            // Inicializar estructuras de datos si faltan
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            // Cargar estado guardado (Local Storage o Cloud Save)
            await cargarEstado(); 

            recalcularIPC();
            recalcularIPS();

            // Dibuja la UI inicial 
            actualizarUI();

            // Configurar el bucle del juego (1 segundo)
            setInterval(bucleJuego, 1000); 
            // Guardar el estado cada 15 segundos [MODIFICACI√ìN: 10s -> 15s]
            setInterval(guardarEstado, 15000); 

            // Bucles de fluctuaci√≥n
            setInterval(fluctuarCrypto, CRYPTO_UPDATE_INTERVAL); 
            setInterval(fluctuarInversiones, CRYPTO_UPDATE_INTERVAL); 

            // Asegurar que la vista inicial sea 'clicker'
            cambiarVista('clicker');
        };

        // --- FUNCI√ìN DE REINICIO (Mantenida, pero llama a guardarEstado modificado) ---
        window.resetGame = async function() {
            const confirmed = await showModal('¬øEst√°s seguro de que quieres REINICIAR el juego? Perder√°s todo el progreso.', '¬°PELIGRO!', true);
            if (!confirmed) return;

            // Restablecer estado del juego a los valores iniciales
            estadoJuego = {
                dinero: 0,
                ipc: 1,
                ips: 0,
                tiendas: {},
                activos: {},
                empresas: {},
                empresasPersonalizadas: [], 
                inversiones: {},
                crypto: {
                    bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                    ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 }
                },
                estadisticas: {
                    totalClicks: 0,
                    dineroPorClicks: 0,
                    dineroPasivo: 0,
                    dineroCrypto: 0
                },
                codigosCanjeados: [], // Resetear c√≥digos
                ultimosSegundos: Date.now()
            };

            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            recalcularIPC();
            recalcularIPS();
            actualizarUI();
            
            // Guardar el estado limpio (Local + Cloud)
            await guardarEstado(); 

            showModal('Juego Reiniciado con √©xito. ¬°Vuelve a hacerte millonario!', '√âxito', false);
        }

        // --- UTILIDAD: Modal Custom para Reemplazar Alert/Confirm (Mantenida) ---
        let modalResolve;
        function showModal(message, title = 'Confirmaci√≥n', isConfirm = true, isCompanyModal = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const content = document.getElementById('modal-message-container');
                document.getElementById('modal-title').textContent = title;
                
                if (isCompanyModal) {
                    content.style.display = 'block'; // Asegura que el contenedor de inputs/selects sea visible
                } else {
                    content.innerHTML = `<p id="modal-message">${message}</p>`;
                    content.style.display = 'block';
                }
                
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');
                const companyActions = document.getElementById('modal-company-actions'); 

                if (isCompanyModal) {
                     confirmBtn.style.display = 'none'; 
                     cancelBtn.style.display = 'none';
                     companyActions.style.display = 'block';
                } else {
                     companyActions.style.display = 'none';
                     if (isConfirm) {
                         confirmBtn.style.display = 'inline-block';
                         cancelBtn.style.display = 'inline-block';
                         confirmBtn.textContent = 'S√≠, Reiniciar';
                         cancelBtn.textContent = 'Cancelar';
                     } else { 
                         confirmBtn.style.display = 'inline-block';
                         cancelBtn.style.display = 'none';
                         confirmBtn.textContent = 'Aceptar';
                     }
                }
                modal.style.display = 'flex';
                modalResolve = resolve;
            });
        }
        window.handleModalClick = function(action) {
            document.getElementById('custom-modal').style.display = 'none';
            if (modalResolve) {
                if (action === 'confirm' || (action === 'accept' && !document.getElementById('modal-cancel').style.display)) {
                    modalResolve(true);
                } else {
                    modalResolve(false);
                }
                modalResolve = null;
            }
        }
    </script>

    <style>
        /* --- FUENTES Y ESTILOS GENERALES (Mantenidos) --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        :root {
            --color-fondo-oscuro: #121212;
            --color-texto-claro: #f0f0f0;
            --color-acento-celeste: #00bcd4; 
            --color-secundario: #6495ed; 
            --color-exito: #388e3c; 
            --color-advertencia: #d32f2f; 
            --color-empresa: #ffc107; 
            --color-inversion: #9c27b0; 
            --color-crypto: #ff6600; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* [MODIFICACI√ìN: BOT√ìN CANJEAR C√ìDIGO] */
        #redeem-code-btn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: var(--color-secundario);
            color: var(--color-fondo-oscuro);
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s;
        }
        
        #redeem-code-btn:hover {
            background-color: #4a80cc;
        }
        /* FIN MODIFICACI√ìN */


        /* --- CABECERA Y ESTADO (Mantenidos) --- */
        #header-bar {
            background-color: #1e1e1e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--color-acento-celeste);
        }

        #main-title-header {
            font-size: 1.5em;
            color: var(--color-acento-celeste);
            font-weight: 900;
            display: flex; 
            flex-direction: column;
            line-height: 1; 
        }

        #studio-tag {
            font-size: 0.5em; 
            font-weight: 400;
            color: #999; 
            margin-top: 2px;
        }

        #status-panel {
            display: flex;
            gap: 30px;
            font-size: 1.1em;
            align-items: center;
        }

        #status-panel div {
            text-align: right;
            border-left: 3px solid #333;
            padding-left: 15px;
        }
        
        #status-panel span {
            display: block;
            font-size: 1.6em;
            font-weight: 900;
            color: var(--color-texto-claro);
        }

        #dinero-actual-container span {
            color: var(--color-exito);
        }

        #ipc-actual-container span {
            color: var(--color-secundario);
        }

        #ips-actual-container span {
            color: var(--color-empresa);
        }

        /* --- NAVEGACI√ìN (Mantenida) --- */
        #nav-bar {
            background-color: #000;
            display: flex;
            justify-content: center;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        #nav-bar button {
            background-color: #1e1e1e;
            color: var(--color-texto-claro);
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            margin: 0 5px;
            border-radius: 4px;
            border: 2px solid #1e1e1e;
        }

        #nav-bar button:hover {
            background-color: #333;
        }

        #nav-bar button.active {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-fondo-oscuro);
        }

        /* --- VISTA PRINCIPAL (Mantenida) --- */
        main {
            flex-grow: 1;
        }

        .game-view {
            display: none;
            width: 100%;
            height: 100%;
        }

        .game-view.active {
            display: block;
        }
        
        #view-clicker {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr; 
            gap: 15px;
            height: calc(100vh - 120px); 
            padding: 15px;
            overflow: hidden; 
        }

        .shop-container {
            padding: 10px;
            background-color: #1e1e1e; 
            border-radius: 8px;
            overflow-y: auto;
            border: 1px solid #333;
            max-height: 100%; 
            display: flex;
            flex-direction: column;
        }
        
        .shop-container h2 {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #333;
            color: var(--color-secundario);
        }

        #clicker-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* --- BOT√ìN DE CLICK (Mantenido) --- */
        #click-btn {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: var(--color-exito);
            color: var(--color-fondo-oscuro);
            font-size: 1.5em;
            font-weight: 900;
            border: 10px solid var(--color-secundario);
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #click-btn i {
            font-size: 2em;
            display: block;
            margin-bottom: 5px;
        }

        #click-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px var(--color-exito);
        }

        /* --- TIENDA (ITEMS) (Mantenido) --- */
        .tienda-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tienda-item {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            border-left: 5px solid var(--color-acento-celeste);
        }
        
        .personal-company-item {
             border-left: 5px solid var(--color-empresa) !important;
        }
        
        .investment-item {
             border-left: 5px solid var(--color-inversion) !important;
        }


        .tienda-item h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: var(--color-texto-claro);
        }

        .tienda-item p {
            font-size: 0.9em;
            color: #aaa;
            margin: 2px 0;
        }

        .tienda-item button {
            background-color: var(--color-acento-celeste);
            color: var(--color-fondo-oscuro);
            border: none;
            padding: 8px;
            width: 100%;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
        }

        .tienda-item button:hover:not([disabled]) {
            background-color: #008c99;
        }

        .item-bloqueado {
            opacity: 0.5;
            border-left: 5px solid var(--color-advertencia);
        }

        .item-bloqueado button,
        .tienda-item button:disabled {
            cursor: not-allowed;
            background-color: #555;
            color: #ccc;
        }
        
        .item-comprado {
            border-left: 5px solid var(--color-exito);
            opacity: 0.8;
            background-color: #3a3a3a;
        }

        /* --- ANIMACI√ìN DE CLICK (Mantenida) --- */
        .animacion-clic {
            position: fixed;
            font-size: 2em;
            font-weight: 900;
            color: var(--color-secundario);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(0);
            animation: floatUp 1s ease-out forwards;
        }
        
        .animacion-crypto {
            color: var(--color-crypto);
            font-size: 1.8em;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-50px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }
        
        /* --- ESTILOS DE VISTAS ADICIONALES (Mantenidos) --- */
        .shop-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding: 15px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        #view-crypto .crypto-item {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--color-crypto);
            display: flex;
            flex-direction: column;
        }
        
        .crypto-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .crypto-icon {
            font-size: 2em;
            color: var(--color-crypto);
            margin-right: 10px;
        }
        
        .crypto-item h3 {
            margin: 0;
            color: var(--color-crypto);
        }
        
        .crypto-info p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        .crypto-price {
            font-weight: 700;
            color: var(--color-texto-claro);
        }
        
        .crypto-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .crypto-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
        }
        
        .crypto-actions .buy-btn {
            background-color: var(--color-exito);
            color: var(--color-fondo-oscuro);
        }
        
        .crypto-actions .sell-btn {
            background-color: var(--color-advertencia);
            color: var(--color-fondo-oscuro);
        }
        
        .text-success { color: var(--color-exito); }
        .text-danger { color: var(--color-advertencia); }

        /* STATS VIEW */
        #view-stats {
            padding: 15px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-bottom: 4px solid var(--color-secundario);
        }

        .stat-card p {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .stat-card span {
            display: block;
            font-size: 2em;
            font-weight: 900;
            color: var(--color-acento-celeste);
        }
        
        .asset-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        #reset-btn {
            background-color: var(--color-advertencia);
            color: var(--color-texto-claro);
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
        }
        
        /* --- MODAL (Mantenido) --- */
        #custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            text-align: center;
            border-top: 5px solid var(--color-acento-celeste);
        }

        #modal-title {
            color: var(--color-acento-celeste);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        #modal-message-container {
            margin-bottom: 20px;
            color: #ccc;
        }

        .modal-actions button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
        }

        #modal-confirm {
            background-color: var(--color-advertencia);
            color: white;
        }

        #modal-cancel {
            background-color: #444;
            color: white;
        }
        
        /* FOOTER (Mantenido) */
        #user-info-footer {
            padding: 5px 15px;
            background-color: #000;
            color: #555;
            font-size: 0.8em;
            text-align: center;
            border-top: 1px solid #333;
        }
    </style>
</head>
<body>
    
    <button id="redeem-code-btn" onclick="mostrarModalCodigo()">
        <i class="fas fa-ticket-alt"></i> Canjear C√≥digo
    </button>
    
    <div id="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-message-container">
                <p id="modal-message"></p>
                <div id="company-create-content" style="text-align: left;"></div> 
            </div>
            
            <div class="modal-actions">
                <button id="modal-confirm" onclick="handleModalClick('confirm')">Confirmar</button>
                <button id="modal-cancel" onclick="handleModalClick('cancel')">Cancelar</button>
                
                <div id="modal-company-actions" style="display: none;">
                    <button id="modal-company-close" onclick="handleModalClick('cancel')" style="background-color: #444; color: white;">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="header-bar">
        <h1 id="main-title-header">
            Millonario Clicker üí∞
            <small id="studio-tag">By Winted Studios</small>
        </h1>
        <div id="status-panel">
            <div id="dinero-actual-container">
                <p>Dinero Actual</p>
                <span id="dinero-actual">$0.00</span>
            </div>
            <div id="ipc-actual-container">
                <p>Ingreso por Clic (IPC)</p>
                <span id="ipc-actual">$1.00</span>
            </div>
            <div id="ips-actual-container">
                <p>Ingreso Pasivo (IPS)</p>
                <span id="ips-actual">$0.00 / s</span>
            </div>
        </div>
    </div>
    
    <div id="nav-bar">
        <button id="nav-clicker" onclick="cambiarVista('clicker')"><i class="fas fa-hand-pointer"></i> Clicker</button>
        <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-car-side"></i> Activos</button>
        <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Empresas</button>
        <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
        <button id="nav-crypto" onclick="cambiarVista('crypto')"><i class="fas fa-bitcoin"></i> Crypto</button>
        <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-bar"></i> Estad√≠sticas</button>
    </div>

    <main>
        
        <div id="view-clicker" class="game-view active">
            
            <div id="ipc-shop-col" class="shop-container">
                <h2>Mejoras por Clic (IPC) <i class="fas fa-hand-pointer"></i></h2>
                <div id="mejoras-clic-tienda" class="tienda-grid">
                    </div>
            </div>

            <div id="clicker-col">
                <button id="click-btn" onclick="hacerClick(event)">
                    <i class="fas fa-money-bill-wave"></i><br>
                    ¬°Haz Click para ganar!
                </button>
            </div>
            
            <div id="ips-shop-col" class="shop-container">
                <h2>Generadores Pasivos (IPS) <i class="fas fa-money-check-alt"></i></h2>
                <div id="generadores-tienda" class="tienda-grid">
                    </div>
            </div>
        </div>
        
        <div id="view-assets" class="game-view">
            <h2 style="text-align: center; padding: 15px; color: var(--color-secundario);">Activos de Lujo (Compra √önica)</h2>
            <div id="activos-tienda" class="shop-view">
                </div>
        </div>

        <div id="view-companies" class="game-view">
            <h2 style="text-align: center; padding: 15px; color: var(--color-empresa);">Empresas (Fundaci√≥n y Generaci√≥n Pasiva)</h2>
            <div id="empresas-tienda" class="shop-view">
                </div>
        </div>
        
        <div id="view-investments" class="game-view">
            <h2 style="text-align: center; padding: 15px; color: var(--color-inversion);">Inversiones (Sujetas a Volatilidad y Retorno)</h2>
            <div id="inversiones-tienda" class="shop-view">
                </div>
        </div>
        
        <div id="view-crypto" class="game-view">
            <h2 style="text-align: center; padding: 15px; color: var(--color-crypto);">Mercado Crypto (Vol√°til)</h2>
            <div id="crypto-grid" class="shop-view">
                </div>
        </div>

        <div id="view-stats" class="game-view">
            <div class="asset-section">
                <h2 style="color: var(--color-secundario);">M√©tricas de Riqueza</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <p>Total Ganado (Acumulado)</p>
                        <span id="stat-total-ganado">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Total Clics Realizados</p>
                        <span id="stat-total-clicks">0</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Clics</p>
                        <span id="stat-dinero-clicks">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia Pasiva (IPS)</p>
                        <span id="stat-dinero-pasivo">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Crypto</p>
                        <span id="stat-dinero-crypto">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="asset-section" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>Gesti√≥n de Datos (Cloud Save)</h2>
                <p style="text-align: center; margin-bottom: 20px; color: #aaa;">
                    Tu progreso se guarda autom√°ticamente cada 15 segundos en la nube (Firebase) y en tu **navegador** (**Local Storage**).
                </p>
                <button id="reset-btn" onclick="resetGame()">
                    <i class="fas fa-trash-alt"></i> REINICIAR TODO EL PROGRESO
                </button>
            </div>
        </div>
        
    </main>
    
    <div id="user-info-footer">
        </div>

</body>
</html>
