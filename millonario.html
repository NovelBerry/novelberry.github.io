<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker (Edición ROJO)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración global (usa las variables del entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;
        let userId = 'anon';

        /**
         * Llama a la función de inicio principal del juego solo una vez.
         */
        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            console.log("--- INICIO DE UI GARANTIZADO. User ID:", userId, "---");
            if (typeof window.initGame === 'function') {
                window.initGame(); 
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        /**
         * Intenta la autenticación y establece el userId.
         */
        async function attemptAuth() {
            try {
                if (initialAuthToken) {
                    const userCredential = await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await window.firebase.auth.signInAnonymously(window.auth);
                    userId = userCredential.user.uid;
                }
            } catch (error) {
                console.error("Error en autenticación Firebase, usando ID aleatorio:", error);
                userId = crypto.randomUUID();
            }
            window.userId = userId; // Hacer el userId globalmente accesible
            handleInitGame();
        }

        // 2. Observador de estado de autenticación (garantiza el flujo de inicio)
        window.firebase.auth.onAuthStateChanged((user) => {
             if (user) {
                userId = user.uid;
             }
             if (!isGameInitialized) {
                attemptAuth();
             }
        });
    </script>

    <script>
        // ====================================================================
        // --- LÓGICA DEL JUEGO MILLONARIO CLICKER (JavaScript) ---
        // ====================================================================

        // --- MODELO DE ESTADO ---
        let estadoJuego = {
            dinero: 0,
            ipc: 1, // Ingreso por Clic
            ips: 0, // Ingreso por Segundo
            tiendas: {}, // Clave: ID de la tienda, Valor: { nivel: X, vecesComprado: Y }
            activos: {},
            empresas: {},
            inversiones: {},
            crypto: {
                bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 }
            },
            estadisticas: {
                totalClicks: 0,
                dineroPorClicks: 0,
                dineroPasivo: 0,
                dineroCrypto: 0
            },
            ultimosSegundos: Date.now()
        };
        
        // ID de la aplicación para Firebase Firestore
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TIENDA_PATH = `/artifacts/${APP_ID}/users/${window.userId}/tiendaJuego`;
        const LOCAL_STORAGE_KEY = 'millonarioClicker_save'; // Clave para LocalStorage
        
        // --- CONSTANTES GLOBALES DE CRYPTO ---
        const CRYPTO_FLUCTUATION_RATE = 0.05; // 5% de cambio máximo por hora
        const CRYPTO_UPDATE_INTERVAL = 60000; // 60 segundos (1 minuto) para cambios en el valor
        

        // --- DEFINICIÓN DE TIENDAS ---
        const mejorasClick = {
            'dedo-rapido': { nombre: 'Dedo Rápido 🤏', costoBase: 10, costoEscalado: 1.15, ipcAumento: 1, tipo: 'ipc', icono: '👋' },
            'mouse-gamer': { nombre: 'Mouse Gamer 🖱️', costoBase: 100, costoEscalado: 1.15, ipcAumento: 10, tipo: 'ipc', icono: '🎮' },
            'ai-clicker': { nombre: 'Asistente IA 🤖', costoBase: 1000, costoEscalado: 1.15, ipcAumento: 100, tipo: 'ipc', icono: '💡' },
            'bot-autoclick': { nombre: 'Bot Autoclick 🦾', costoBase: 10000, costoEscalado: 1.15, ipcAumento: 1000, tipo: 'ipc', icono: '🤖' },
            'chip-neural': { nombre: 'Chip Neural 🧠', costoBase: 100000, costoEscalado: 1.15, ipcAumento: 10000, tipo: 'ipc', icono: '🧠' } // NUEVO
        };

        const generadoresIPS = {
            'puesto-limonada': { nombre: 'Puesto de Limonada 🍋', costoBase: 50, costoEscalado: 1.15, ipsGenerado: 0.5, tipo: 'ips', icono: '🥤' },
            'vendedor-ambulante': { nombre: 'Vendedor Ambulante 💼', costoBase: 500, costoEscalado: 1.15, ipsGenerado: 5, tipo: 'ips', icono: '🚶' },
            'tienda-online': { nombre: 'Tienda Online 💻', costoBase: 5000, costoEscalado: 1.15, ipsGenerado: 50, tipo: 'ips', icono: '🛒' },
            'granja-solar': { nombre: 'Granja Solar ☀️', costoBase: 50000, costoEscalado: 1.15, ipsGenerado: 500, tipo: 'ips', icono: '⚡' },
            'bienes-raices': { nombre: 'Bienes Raíces 🏘️', costoBase: 500000, costoEscalado: 1.15, ipsGenerado: 5000, tipo: 'ips', icono: '🏠' },
            'planta-nuclear': { nombre: 'Planta Nuclear ☢️', costoBase: 5000000, costoEscalado: 1.15, ipsGenerado: 50000, tipo: 'ips', icono: '☢️' } // NUEVO
        };
        
        const activosLujos = {
             'coche-lujo': { nombre: 'Coche Deportivo 🏎️', costo: 50000, efecto: 'Aumenta IPC en 500', ipcAumento: 500, comprado: false, icono: '🏎️' },
             'apartamento': { nombre: 'Apartamento de Lujo 🏙️', costo: 500000, efecto: 'Aumenta IPS en 50', ipsAumento: 50, comprado: false, icono: '🏙️' },
             'yate': { nombre: 'Yate Privado 🛥️', costo: 5000000, efecto: 'Duplica todo el IPC', multiplicadorIPC: 2, comprado: false, icono: '🛥️' },
             'isla-privada': { nombre: 'Isla Privada 🏝️', costo: 50000000, efecto: 'Multiplica IPS por 1.5', multiplicadorIPS: 1.5, comprado: false, icono: '🏝️' },
             'cohete-personal': { nombre: 'Cohete Personal 🚀', costo: 500000000, efecto: 'Multiplica IPC y IPS por 2', multiplicadorIPC: 2, multiplicadorIPS: 2, comprado: false, icono: '🚀' } // NUEVO
        };
        
        const empresasVistas = {
             'restaurante': { nombre: 'Restaurante Exclusivo 🍽️', costo: 1000000, ipsGenerado: 1000, vecesComprado: 0, icono: '🍽️' },
             'tech-startup': { nombre: 'Tech Startup 🚀', costo: 10000000, ipsGenerado: 10000, vecesComprado: 0, icono: '🚀' },
             'cadena-hoteles': { nombre: 'Cadena de Hoteles 🏨', costo: 100000000, ipsGenerado: 100000, vecesComprado: 0, icono: '🏨' },
             'aerolinea-lowcost': { nombre: 'Aerolínea Low Cost ✈️', costo: 1000000000, ipsGenerado: 1000000, vecesComprado: 0, icono: '✈️' },
             'red-satelital': { nombre: 'Red Satelital 🛰️', costo: 10000000000, ipsGenerado: 10000000, vecesComprado: 0, icono: '🛰️' } // NUEVO
        };
        
        const inversionesVista = {
             'bonos-gobierno': { nombre: 'Bonos Gobierno 🏛️', costo: 100000, retorno: 0.05, vecesComprado: 0, tipo: 'retorno', icono: '🏛️' }, // 5% de retorno
             'crypto-mining': { nombre: 'Crypto Mining ⛏️', costo: 2000000, retorno: 0.1, vecesComprado: 0, tipo: 'retorno', icono: '⛏️' }, // 10% de retorno
             'fondo-indexado': { nombre: 'Fondo Indexado S&P 📈', costo: 5000000, retorno: 0.12, vecesComprado: 0, tipo: 'retorno', icono: '📊' }, // 12% de retorno
             'venture-capital': { nombre: 'Venture Capital 💸', costo: 50000000, retorno: 0.2, vecesComprado: 0, tipo: 'retorno', icono: '💰' }, // 20% de retorno
             'fondo-cobertura': { nombre: 'Fondo de Cobertura 🛡️', costo: 500000000, retorno: 0.3, vecesComprado: 0, tipo: 'retorno', icono: '🛡️' } // NUEVO
        };


        // --- UTILIDADES ---
        
        /** Formatea un número como moneda (K, M, B, T...). */
        function formatDinero(num, decimales = 2) {
            num = parseFloat(num);
            if (num === 0) return '$0.00';
            const sign = num < 0 ? '-' : '';
            const absNum = Math.abs(num);
            
            if (absNum < 1000) return sign + '$' + absNum.toFixed(decimales);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Q', 'S', 'O', 'N', 'D', 'UD'];
            const tier = Math.floor(Math.log10(absNum) / 3);
            const suffix = suffixes[tier] || 'E';
            const scale = Math.pow(10, tier * 3);
            const scaled = absNum / scale;

            // Ajustar decimales para evitar ".0" en números enteros grandes
            let formatted = scaled.toFixed(decimales);
            if (tier > 0 && formatted.endsWith('.00')) {
                formatted = scaled.toFixed(0);
            } else if (tier > 0 && formatted.endsWith('.0')) {
                 formatted = scaled.toFixed(1);
            }
            return sign + '$' + formatted + suffix;
        }
        
        /** Formatea un número para crypto (más decimales para precisión) */
        function formatCrypto(num, decimales = 6) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        /** Calcula el costo de la siguiente compra. */
        function calcularCosto(base, escalado, nivel) {
            return base * Math.pow(escalado, nivel);
        }

        /** Muestra una animación de texto cuando se hace clic o se genera dinero. */
        function mostrarAnimacion(monto, x, y, esCrypto = false) {
            const anim = document.createElement('div');
            anim.textContent = `${monto > 0 ? '+' : ''}${formatDinero(monto)}`;
            anim.classList.add('animacion-clic');
            
            if (esCrypto) {
                 anim.classList.add('animacion-crypto');
            }
            
            // Posicionar con respecto al billete
            anim.style.left = `${x}px`;
            anim.style.top = `${y}px`;

            document.body.appendChild(anim);

            // Eliminar después de la animación
            anim.addEventListener('animationend', () => {
                anim.remove();
            });
        }

        // --- FIREBASE (Guardar/Cargar en Nube) ---
        
        async function cargarEstadoNube() {
            if (!window.db || !window.userId) return null;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const docSnap = await window.firebase.firestore.getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Estado cargado desde Firebase.");
                    return data;
                }
            } catch (e) {
                console.error("Error cargando el estado desde Firebase: ", e);
            }
            return null;
        }

        async function guardarEstadoNube() {
            if (!window.db || !window.userId) return;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                // Solo guardar los valores que cambian
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() // Actualizar el tiempo de guardado
                };
                await window.firebase.firestore.setDoc(docRef, dataToSave);
                // console.log("Estado guardado en Firebase con éxito.");
            } catch (e) {
                console.error("Error guardando el estado en Firebase: ", e);
            }
        }
        
        // --- LOCALSTORAGE (Guardar/Cargar en Navegador) ---
        
        function cargarEstadoLocal() {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    const data = JSON.parse(savedState);
                    console.log("Estado cargado desde LocalStorage.");
                    return data;
                }
            } catch (e) {
                console.error("Error cargando el estado desde LocalStorage: ", e);
            }
            return null;
        }
        
        function guardarEstadoLocal() {
            try {
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                // console.log("Estado guardado en LocalStorage con éxito.");
            } catch (e) {
                console.error("Error guardando el estado en LocalStorage: ", e);
            }
        }
        
        // --- FUNCIÓN DE CARGA UNIFICADA ---
        async function cargarEstado() {
            // 1. Intentar cargar desde LocalStorage (más rápido y reciente)
            let data = cargarEstadoLocal();
            
            // 2. Si no hay LocalStorage, intentar cargar desde Firebase
            if (!data) {
                 data = await cargarEstadoNube();
            }
            
            if (data) {
                // Mapear los datos cargados al estadoJuego
                estadoJuego = {
                    ...estadoJuego,
                    ...data,
                    // Asegurar que los números sean floats
                    dinero: parseFloat(data.dinero || 0),
                    ipc: parseFloat(data.ipc || 1),
                    ips: parseFloat(data.ips || 0),
                    ultimosSegundos: parseFloat(data.ultimosSegundos || Date.now())
                };
                
                // Asegurar que las estructuras anidadas existan
                estadoJuego.crypto = data.crypto || estadoJuego.crypto;
                estadoJuego.estadisticas = data.estadisticas || estadoJuego.estadisticas;
                
                // Forzar el cálculo del progreso offline
                calcularProgresoOffline();
            } else {
                 // Si no existe, inicializar con el estado predeterminado y guardar
                 await guardarEstado();
            }
        }
        
        // --- FUNCIÓN DE GUARDADO UNIFICADA ---
        async function guardarEstado() {
            guardarEstadoLocal(); // Siempre guardar en el navegador
            await guardarEstadoNube(); // Intentar guardar en la nube
        }

        // --- LÓGICA DE JUEGO PRINCIPAL ---

        /** * Inicializa el estado de las tiendas si es la primera vez.
         * Lo hacemos aquí para no sobreescribir los datos cargados.
         */
        function inicializarTiendas(tiendas, estadoKey) {
            for (const id in tiendas) {
                if (!estadoJuego[estadoKey][id]) {
                    estadoJuego[estadoKey][id] = { 
                        nivel: 0, 
                        vecesComprado: 0,
                        comprado: tiendas[id].comprado || false, // Para activos fijos
                        valorTotal: 0 // Para inversiones
                    };
                }
            }
        }
        
        function calcularProgresoOffline() {
            const now = Date.now();
            const elapsedSeconds = (now - estadoJuego.ultimosSegundos) / 1000;
            if (elapsedSeconds > 5) { // Si estuvo ausente por más de 5 segundos
                const dineroGanado = estadoJuego.ips * elapsedSeconds;
                estadoJuego.dinero += dineroGanado;
                console.log(`Ganancia offline: +${formatDinero(dineroGanado)} durante ${Math.round(elapsedSeconds)} segundos.`);
                estadoJuego.estadisticas.dineroPasivo += dineroGanado;
            }
            estadoJuego.ultimosSegundos = now;
        }

        function actualizarUI() {
            document.getElementById('dinero-actual').textContent = formatDinero(estadoJuego.dinero);
            document.getElementById('ipc-actual').textContent = formatDinero(estadoJuego.ipc);
            document.getElementById('ips-actual').textContent = formatDinero(estadoJuego.ips) + " / s";
            
            // Actualizar todas las vistas
            dibujarTodasLasTiendas();
            dibujarCryptoView();
            dibujarStatsView();
            
            // Mostrar User ID en el pie de página
            document.getElementById('user-info-footer').textContent = `ID de Sesión: ${window.userId}`;
        }
        
        /** * Llama a las funciones de dibujo de todas las vistas activas/paneles.
         */
        function dibujarTodasLasTiendas() {
            dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas');
            dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas');
            dibujarActivos();
            dibujarEmpresas();
            dibujarInversiones();
            actualizarBotonesVista();
        }

        /** Actualiza el estado de los botones de navegación según la vista activa */
        function actualizarBotonesVista() {
             const vistaActivaElement = document.querySelector('.game-view.active');
             if (!vistaActivaElement) return;
             
             const vistaActiva = vistaActivaElement.id.replace('view-', '');
             document.querySelectorAll('#nav-bar button').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.id.includes(vistaActiva)) {
                     btn.classList.add('active');
                 }
             });
        }

        // Lógica de fluctuación de Crypto (se ejecuta cada minuto)
        function fluctuarCrypto() {
            const now = Date.now();
            const factor = Math.random() * (CRYPTO_FLUCTUATION_RATE * 2) - CRYPTO_FLUCTUATION_RATE; // Rango: -5% a +5%
            
            // Fluctación de Bitcoin
            const oldBtcValue = estadoJuego.crypto.bitcoin.valorActual;
            let newBtcValue = oldBtcValue * (1 + factor);
            newBtcValue = Math.max(1, newBtcValue); // Evitar valor negativo o cero
            estadoJuego.crypto.bitcoin.valorActual = newBtcValue;
            
            // Fluctación de Ethereum (un poco más volátil, ej: factor * 1.2)
            const oldEthValue = estadoJuego.crypto.ethereum.valorActual;
            let newEthValue = oldEthValue * (1 + (factor * 1.2));
            newEthValue = Math.max(1, newEthValue);
            estadoJuego.crypto.ethereum.valorActual = newEthValue;
            
            // No guardar estado, solo actualizar la vista de crypto si está activa
            if (document.getElementById('view-crypto').classList.contains('active')) {
                 dibujarCryptoView();
            }
            // console.log("Crypto fluctuado. BTC:", formatDinero(newBtcValue, 2));
        }

        /** Lógica para el bucle de ingresos pasivos (IPS) */
        function bucleJuego() {
            const ganancia = estadoJuego.ips;
            estadoJuego.dinero += ganancia;
            estadoJuego.estadisticas.dineroPasivo += ganancia;
            actualizarUI();
        }

        // --- LÓGICA DE VISTAS ---

        /** * Dibuja los items de mejora o generadores. */
        function dibujarTienda(items, contenedorId, estadoKey) {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) return;

            contenedor.innerHTML = '';
            
            for (const id in items) {
                const item = items[id];
                const nivel = estadoJuego[estadoKey][id]?.nivel || 0;
                const costo = calcularCosto(item.costoBase, item.costoEscalado, nivel);
                const puedeComprar = estadoJuego.dinero >= costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                let efectoTexto = '';
                if (item.tipo === 'ipc') {
                    efectoTexto = `+${formatDinero(item.ipcAumento)} IPC por nivel`;
                } else if (item.tipo === 'ips') {
                    efectoTexto = `+${formatDinero(item.ipsGenerado)} IPS por nivel`;
                }
                
                elemento.innerHTML = `
                    <h3>${item.icono} ${item.nombre}</h3>
                    <p>Nivel: <span style="color: var(--color-empresa);">${nivel}</span></p>
                    <p>Efecto: ${efectoTexto}</p>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                    <button onclick="comprarItem('${id}', '${estadoKey}', '${item.tipo}')" ${!puedeComprar ? 'disabled' : ''}>
                        Comprar (Nivel ${nivel + 1})
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Activos (Compra única)
        function dibujarActivos() {
            const contenedor = document.getElementById('activos-tienda');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            for (const id in activosLujos) {
                const item = activosLujos[id];
                const estado = estadoJuego.activos[id] || { comprado: false };
                const comprado = estado.comprado;
                const puedeComprar = !comprado && estadoJuego.dinero >= item.costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item asset-item ${comprado ? 'item-comprado' : ''} ${!puedeComprar && !comprado ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                elemento.innerHTML = `
                    <h3>${item.icono || '✨'} ${item.nombre}</h3>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(item.costo)}</span></p>
                    <p>Efecto: <span style="color: var(--color-inversion);">${item.efecto}</span></p>
                    <button onclick="comprarActivo('${id}')" ${comprado || !puedeComprar ? 'disabled' : ''}>
                        ${comprado ? 'Comprado' : 'Comprar Lujo'}
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        // Dibujo de Empresas (Generan IPS)
        function dibujarEmpresas() {
             const contenedor = document.getElementById('empresas-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in empresasVistas) {
                 const item = empresasVistas[id];
                 const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
                 
                 // Costo de la empresa: 10% de aumento por cada compra (ejemplo simple)
                 const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item company-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const ipsTotal = estado.vecesComprado * item.ipsGenerado;

                 elemento.innerHTML = `
                     <h3>${item.icono || '🏢'} ${item.nombre}</h3>
                     <p>Compradas: <span style="color: var(--color-empresa);">${estado.vecesComprado}</span></p>
                     <p>IPS Total: <span style="font-weight: 700;">${formatDinero(ipsTotal)} / s</span></p>
                     <p>Costo Próxima: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarEmpresa('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Fundar Nueva (IPS: +${formatDinero(item.ipsGenerado)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        // Dibujo de Inversiones (Generan Retorno %)
        function dibujarInversiones() {
             const contenedor = document.getElementById('inversiones-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
                 
                 // El costo es fijo por paquete de inversión
                 const costo = item.costo; 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item investment-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 // Retorno IPS = Valor total * Tasa de retorno anual / 10
                 const retornoIPS = estado.valorTotal * item.retorno / 10; 
                 
                 elemento.innerHTML = `
                     <h3>${item.icono || '📈'} ${item.nombre}</h3>
                     <p>Valor Total: <span style="color: var(--color-acento-celeste);">${formatDinero(estado.valorTotal)}</span></p>
                     <p>Retorno IPS: <span style="font-weight: 700;">${formatDinero(retornoIPS)} / s</span></p>
                     <p>Costo Paquete: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarInversion('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Invertir (+${formatDinero(item.costo)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        // Dibujo de Crypto View
        function dibujarCryptoView() {
            const contenedor = document.getElementById('crypto-grid');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            const cryptos = [
                { id: 'bitcoin', nombre: 'Bitcoin (BTC)', icono: '₿', fluctuation: CRYPTO_FLUCTUATION_RATE * 1.5 },
                { id: 'ethereum', nombre: 'Ethereum (ETH)', icono: 'Ξ', fluctuation: CRYPTO_FLUCTUATION_RATE * 1.8 }
            ];

            cryptos.forEach(({ id, nombre, icono }) => {
                const cryptoData = estadoJuego.crypto[id];
                const valorActual = cryptoData.valorActual;
                const cantidad = cryptoData.cantidad;
                
                // Pérdida/Ganancia no realizada
                const valorActualTotal = cantidad * valorActual;
                const perdidaGanancia = cantidad > 0 ? (valorActualTotal - (cantidad * cryptoData.costoPromedio)) : 0;
                
                const puedeVender = cantidad > 0;
                const puedeComprar = estadoJuego.dinero >= valorActual;

                const elemento = document.createElement('div');
                elemento.className = 'crypto-item';
                
                elemento.innerHTML = `
                    <div class="crypto-header">
                        <span class="crypto-icon">${icono}</span>
                        <h3>${nombre}</h3>
                    </div>
                    <div class="crypto-info">
                        <p>Valor Actual: <span class="crypto-price">${formatDinero(valorActual, 2)}</span></p>
                        <p>Tu Cantidad: <span class="crypto-amount">${formatCrypto(cantidad)}</span></p>
                        <p>Costo Promedio: <span class="crypto-avg">${formatDinero(cryptoData.costoPromedio, 2)}</span></p>
                        <p>Ganancia No Realizada: 
                            <span class="${perdidaGanancia >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatDinero(perdidaGanancia, 2)}
                            </span>
                        </p>
                    </div>
                    <div class="crypto-actions">
                        <button onclick="comprarCrypto('${id}')" ${!puedeComprar ? 'disabled' : ''} class="buy-btn">
                            Comprar 1 (${formatDinero(valorActual, 2)})
                        </button>
                        <button onclick="venderCrypto('${id}')" ${!puedeVender ? 'disabled' : ''} class="sell-btn">
                            Vender 1 (${formatDinero(valorActual, 2)})
                        </button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
        }
        
        // Dibujo de Estadísticas
        function dibujarStatsView() {
            const stats = estadoJuego.estadisticas;
            const totalDineroGanado = stats.dineroPorClicks + stats.dineroPasivo + stats.dineroCrypto;
            
            // Actualizar el valor del dinero actual en el panel de stats
            document.getElementById('stat-dinero-actual').textContent = formatDinero(estadoJuego.dinero); 
            
            document.getElementById('stat-total-clicks').textContent = stats.totalClicks.toLocaleString('es-ES');
            document.getElementById('stat-dinero-clicks').textContent = formatDinero(stats.dineroPorClicks);
            document.getElementById('stat-dinero-pasivo').textContent = formatDinero(stats.dineroPasivo);
            document.getElementById('stat-dinero-crypto').textContent = formatDinero(stats.dineroCrypto);
            
            document.getElementById('stat-total-ganado').textContent = formatDinero(totalDineroGanado);
        }

        // --- FUNCIONES ACCIONABLES (GLOBALES) ---

        /** * Función pública para el botón de clic principal.
         * @param {Event} e - Evento de clic para obtener posición.
         */
        window.hacerClick = function(e) {
            estadoJuego.dinero += estadoJuego.ipc;
            
            // Actualizar estadísticas
            estadoJuego.estadisticas.totalClicks++;
            estadoJuego.estadisticas.dineroPorClicks += estadoJuego.ipc;
            
            const x = e.clientX;
            const y = e.clientY;
            mostrarAnimacion(estadoJuego.ipc, x, y);

            actualizarUI();
            guardarEstado(); // Guardado automático
        }

        /**
         * Función pública para comprar Mejoras/Generadores IPS.
         */
        window.comprarItem = function(id, estadoKey, tipo) {
            const item = (tipo === 'ipc' ? mejorasClick[id] : generadoresIPS[id]);
            const estadoActual = estadoJuego[estadoKey][id] || { nivel: 0 };
            const costo = calcularCosto(item.costoBase, item.costoEscalado, estadoActual.nivel);

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estadoActual.nivel++;
                estadoJuego[estadoKey][id] = estadoActual;

                if (tipo === 'ipc') {
                    // No ajustamos IPC aquí, se recalcula con recalcularIPC
                } else if (tipo === 'ips') {
                    // No ajustamos IPS aquí, se recalcula con recalcularIPS
                }
                
                recalcularIPC(); 
                recalcularIPS();
                actualizarUI();
                guardarEstado(); // Guardado automático
            }
        }
        
        /**
         * Función pública para comprar Activos/Lujos.
         */
        window.comprarActivo = function(id) {
            const item = activosLujos[id];
            const estado = estadoJuego.activos[id] || { comprado: false };
            
            if (!estado.comprado && estadoJuego.dinero >= item.costo) {
                estadoJuego.dinero -= item.costo;
                estado.comprado = true;
                estadoJuego.activos[id] = estado;
                
                recalcularIPC(); 
                recalcularIPS();
                actualizarUI();
                guardarEstado(); // Guardado automático
            }
        }
        
        /**
         * Función pública para comprar Empresas.
         */
        window.comprarEmpresa = function(id) {
            const item = empresasVistas[id];
            const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
            const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estadoJuego.empresas[id] = estado;
                
                recalcularIPS();
                actualizarUI();
                guardarEstado(); // Guardado automático
            }
        }

        /**
         * Función pública para comprar Inversiones (bonos/crypto).
         */
        window.comprarInversion = function(id) {
            const item = inversionesVista[id];
            const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
            const costo = item.costo; 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estado.valorTotal += costo; // Añadir el costo al valor total invertido
                estadoJuego.inversiones[id] = estado;
                
                recalcularIPS(); // El IPS cambiará por el nuevo valor total
                actualizarUI();
                guardarEstado(); // Guardado automático
            }
        }
        
        /**
         * Función pública para comprar 1 unidad de Crypto.
         */
        window.comprarCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;
            
            if (estadoJuego.dinero >= valor) {
                estadoJuego.dinero -= valor;
                
                // Recalcular costo promedio
                const nuevaCantidad = crypto.cantidad + 1;
                const costoTotalAnterior = crypto.cantidad * crypto.costoPromedio;
                const nuevoCostoTotal = costoTotalAnterior + valor;
                
                crypto.costoPromedio = nuevoCostoTotal / nuevaCantidad;
                crypto.cantidad = nuevaCantidad;

                actualizarUI();
                guardarEstado(); // Guardado automático
                showModal(`Compraste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Compra Exitosa', false);
            } else {
                 showModal(`Necesitas ${formatDinero(valor, 2)} para comprar 1 unidad de ${id.toUpperCase()}.`, 'Dinero Insuficiente', false);
            }
        }

        /**
         * Función pública para vender 1 unidad de Crypto.
         */
        window.venderCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;

            if (crypto.cantidad > 0) {
                estadoJuego.dinero += valor;
                crypto.cantidad -= 1;
                
                // Si la cantidad llega a cero, restablecer el costo promedio
                if (crypto.cantidad === 0) {
                     crypto.costoPromedio = 0;
                } else {
                     // No es necesario recalcular el promedio después de una venta
                }
                
                // Actualizar estadísticas de ganancia/pérdida
                const gananciaPerdida = valor - crypto.costoPromedio;
                estadoJuego.estadisticas.dineroCrypto += gananciaPerdida;
                
                actualizarUI();
                guardarEstado(); // Guardado automático
                showModal(`Vendiste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Venta Exitosa', false);
            }
        }


        
        /** Recalcula el IPC total base + multiplicadores. */
        function recalcularIPC() {
            let baseIPC = 1; // IPC base de inicio (1 por defecto)
            
            // 1. IPC base de Mejoras Click
            for (const id in mejorasClick) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 if (mejorasClick[id].tipo === 'ipc') {
                    baseIPC += nivel * mejorasClick[id].ipcAumento;
                 }
            }
            
            // 2. IPC de Activos fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado) {
                    if (activosLujos[id].ipcAumento) {
                         baseIPC += activosLujos[id].ipcAumento;
                    }
                }
            }

            // Establecer el nuevo IPC (antes de multiplicadores)
            estadoJuego.ipc = baseIPC;
            
            // 3. Multiplicadores de Activos
            let multiplicador = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPC) {
                    multiplicador *= activosLujos[id].multiplicadorIPC;
                }
            }
            
            // Aplicar multiplicador
            estadoJuego.ipc = estadoJuego.ipc * multiplicador;
        }

        /** Recalcula el IPS total de todas las fuentes. */
        function recalcularIPS() {
            let totalIPS = 0;

            // 1. IPS de Generadores (Tienda)
            for (const id in generadoresIPS) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 totalIPS += nivel * generadoresIPS[id].ipsGenerado;
            }
            
            // 2. IPS de Activos Fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].ipsAumento) {
                    totalIPS += activosLujos[id].ipsAumento;
                }
            }

            // 3. IPS de Empresas
            for (const id in empresasVistas) {
                 const vecesComprado = estadoJuego.empresas[id]?.vecesComprado || 0;
                 totalIPS += vecesComprado * empresasVistas[id].ipsGenerado;
            }
            
            // 4. IPS de Inversiones (porcentaje de valor total)
            for (const id in inversionesVista) {
                 const inversion = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { valorTotal: 0 };
                 
                 // **CORRECCIÓN DE IPS:** Se elimina el divisor para que la ganancia sea visible. 
                 // Ahora el retorno es (Valor total * Tasa de retorno anual / 10).
                 totalIPS += estado.valorTotal * inversion.retorno / 10; 
            }
            
            // Aplicar multiplicadores IPS de Activos (ej. Isla Privada)
            let multiplicadorIPS = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPS) {
                    multiplicadorIPS *= activosLujos[id].multiplicadorIPS;
                }
            }
            totalIPS = totalIPS * multiplicadorIPS;


            estadoJuego.ips = totalIPS;
        }


        /**
         * Función pública para cambiar la vista entre Clicker, Activos, Empresas, etc.
         */
        window.cambiarVista = function(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${vista}`).classList.add('active');
            
            // Dibuja las tiendas específicas de la vista
            dibujarTodasLasTiendas();
            if (vista === 'crypto') dibujarCryptoView();
            if (vista === 'stats') dibujarStatsView();

            // Actualizar botones de navegación
            actualizarBotonesVista();
        }

        /** * Función de inicialización principal del juego.
         * Se llama desde el módulo de Firebase una vez que la autenticación está lista.
         */
        window.initGame = async function() {
            // Inicializar estructuras de datos si faltan
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            await cargarEstado(); // Carga unificada (Local > Nube)
            
            // Recalcular IPC y IPS después de cargar el estado
            recalcularIPC();
            recalcularIPS();
            
            // Dibuja la UI inicial (incluyendo los botones de tienda)
            actualizarUI(); 
            
            // Configurar el bucle del juego (1 segundo)
            setInterval(bucleJuego, 1000); 
            
            // Guardar el estado cada 10 segundos
            setInterval(guardarEstado, 10000); // Guardado automático (Local + Nube)
            
            // Bucle de fluctuación de crypto (1 minuto)
            setInterval(fluctuarCrypto, CRYPTO_UPDATE_INTERVAL);
            
            // Asegurar que la vista inicial sea 'clicker'
            cambiarVista('clicker');
        };
        
        // --- FUNCIÓN DE REINICIO ---
        window.resetGame = async function() {
            // Usamos un modal para la confirmación en lugar de alert/confirm.
            const confirmed = await showModal('¿Estás seguro de que quieres REINICIAR el juego? Perderás todo el progreso (Local y Nube).', '¡PELIGRO!', true);
            if (!confirmed) return;
            
            estadoJuego = {
                dinero: 0,
                ipc: 1, 
                ips: 0, 
                tiendas: {}, 
                activos: {},
                empresas: {},
                inversiones: {},
                crypto: {
                    bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                    ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 }
                },
                estadisticas: {
                    totalClicks: 0,
                    dineroPorClicks: 0,
                    dineroPasivo: 0,
                    dineroCrypto: 0
                },
                ultimosSegundos: Date.now()
            };
            
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');
            
            recalcularIPC();
            recalcularIPS();
            actualizarUI();
            
            // Forzar la eliminación del LocalStorage antes de guardar el estado vacío
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            await guardarEstado();
            
            // Mostrar modal de éxito
            showModal('Juego Reiniciado con éxito. ¡Vuelve a hacerte millonario!', 'Éxito', false);
        }
        
        // --- UTILIDAD: Modal Custom para Reemplazar Alert/Confirm ---
        
        let modalResolve;

        /** Muestra un modal personalizado para confirmación o mensaje. */
        function showModal(message, title = 'Confirmación', isConfirm = true) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                if (isConfirm) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    confirmBtn.textContent = 'Sí, Reiniciar';
                    cancelBtn.textContent = 'Cancelar';
                } else {
                    // Para mensajes de éxito o info (solo botón de cerrar)
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                    confirmBtn.textContent = 'Aceptar';
                }

                modal.style.display = 'flex';
                modalResolve = resolve;
            });
        }
        
        window.handleModalClick = function(action) {
            document.getElementById('custom-modal').style.display = 'none';
            if (modalResolve) {
                if (action === 'confirm' || !document.getElementById('modal-cancel').style.display || document.getElementById('modal-cancel').style.display === 'none') {
                     // Si es confirmación, resuelve true. Si es solo un mensaje (sin cancelar), también.
                     modalResolve(true); 
                } else {
                     modalResolve(false);
                }
                modalResolve = null;
            }
        }


    </script>
    
    <style>
        /* --- FUENTES Y ESTILOS GENERALES --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        :root {
            /* Colores inspirados en el fondo_rojo.jpg */
            --color-fondo-oscuro: #0a0a0a; 
            --color-texto-claro: #f0f0f0;
            --color-acento-principal: #e30022; /* Rojo Intenso (Acento principal/Gamer) */
            --color-acento-secundario: #00bcd4; /* Cian (Contraste de datos) */
            --color-secundario: #6495ed; /* Azul para el IPC del clicker y títulos de panel */
            --color-exito: #388e3c; /* Verde para el botón de clic y items comprados */
            --color-advertencia: #e30022; /* Rojo para reiniciar/peligro */
            --color-empresa: #ffc107; /* Amarillo para empresas */
            --color-inversion: #9c27b0; /* Púrpura para inversiones */
            --color-crypto: #ff6600; /* Naranja para Crypto */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            transition: color 0.2s, background-color 0.2s, border-color 0.2s;
        }

        /* --- REGLAS MODIFICADAS PARA PERMITIR EL SCROLL --- */
        html, body {
            width: 100%;
            min-height: 100vh;
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            overflow-y: auto; /* Permite el scroll vertical si el contenido desborda. */
            overflow-x: hidden; /* Previene el scroll horizontal no deseado */
        }
        
        /* Utilidades de texto */
        .text-success { color: var(--color-exito); font-weight: 700; }
        .text-danger { color: var(--color-advertencia); font-weight: 700; }


        /* --- MODAL CUSTOM --- */
        #custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--color-acento-principal);
        }
        
        #modal-title {
            color: var(--color-acento-principal);
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        
        #modal-message {
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 700;
            margin: 0 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #modal-confirm {
            background-color: var(--color-advertencia);
            color: var(--color-texto-claro);
        }
        #modal-confirm:hover {
            background-color: #ff5252;
        }

        #modal-cancel {
            background-color: #555;
            color: var(--color-texto-claro);
        }
        #modal-cancel:hover {
            background-color: #777;
        }


        /* --- DECORACIÓN DE FONDO (SIMULACIÓN DE fondo_rojo.jpg) --- */
        #fondo-decoracion {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(45deg, rgba(227, 0, 34, 0.3) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(227, 0, 34, 0.3) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(227, 0, 34, 0.3) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(227, 0, 34, 0.3) 75%);
            background-size: 50px 50px;
            opacity: 0.15; 
            z-index: -1;
            background-color: #0d0d0d;
        }

        /* --- BARRA DE NAVEGACIÓN --- */
        #nav-bar {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 20px;
            background-color: #0d0d0d;
            border-bottom: 3px solid var(--color-acento-principal);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            z-index: 50; 
            flex-wrap: wrap;
        }

        #nav-bar button {
            padding: 10px 15px;
            border: 2px solid var(--color-acento-secundario);
            background-color: #1a1a1a;
            color: var(--color-texto-claro);
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            flex-grow: 1;
            max-width: 150px;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #nav-bar button:hover {
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            box-shadow: 0 0 10px var(--color-acento-secundario);
        }

        #nav-bar button.active {
            background-color: var(--color-acento-principal);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-acento-principal);
            box-shadow: 0 0 15px rgba(227, 0, 34, 0.8);
        }

        /* --- CONTENEDORES DE VISTAS Y LAYOUT --- */
        #game-view-container {
            padding-top: 20px; 
            min-height: calc(100vh - 60px); 
        }

        .game-view {
            padding: 20px;
            display: none; 
            min-height: 80vh; 
        }
        
        .game-view.active {
            display: block;
        }

        .view-title {
            text-align: center;
            color: var(--color-acento-principal);
            font-size: 2.2em;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(227, 0, 34, 0.5);
            padding-bottom: 10px;
        }
        
        .grid-3-cols {
            display: grid;
            grid-template-columns: repeat(1, 1fr); /* Default a 1 columna para móviles */
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Sección general para Activos/Empresas/Inversiones/Stats */
        .asset-section, .company-section, .investment-section, .stats-panel, .crypto-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-acento-secundario);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%; 
        }
        
        .company-section { border-color: var(--color-empresa); }
        .investment-section { border-color: var(--color-inversion); }
        .crypto-section { border-color: var(--color-crypto); }

        .asset-section h2, .company-section h2, .investment-section h2, .stats-panel h2, .crypto-section h2 {
            color: var(--color-acento-principal);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(227, 0, 34, 0.5);
            text-align: center;
            font-size: 1.5em;
        }
        
        .company-section h2 { color: var(--color-empresa); }
        .investment-section h2 { color: var(--color-inversion); }
        .crypto-section h2 { color: var(--color-crypto); }
        
        .asset-shop, .company-shop, .investment-shop, .crypto-shop {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px 0;
            flex-grow: 1;
        }
        
        .company-shop, .investment-shop, .asset-shop {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        
        .company-shop .tienda-item, .investment-shop .tienda-item, .asset-shop .tienda-item {
             width: 48%; /* Dos columnas en desktop */
        }
        
        /* Stats Grid */
        #stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: #2e2e2e;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--color-acento-principal);
        }
        
        .stat-card p {
            font-size: 1em;
            color: #ccc;
        }
        
        .stat-card span {
            display: block;
            font-size: 1.8em;
            font-weight: 900;
            color: var(--color-exito);
            margin-top: 5px;
        }
        
        .stat-card:nth-child(2) { border-left-color: var(--color-acento-secundario); }
        .stat-card:nth-child(3) { border-left-color: var(--color-empresa); }
        .stat-card:nth-child(4) { border-left-color: var(--color-crypto); }
        .stat-card:nth-child(5) { border-left-color: var(--color-inversion); }
        .stat-card:nth-child(6) { border-left-color: var(--color-secundario); } /* Nuevo color para stat 6 */


        /* Crypto Items */
        .crypto-grid {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }
        
        .crypto-item {
            flex-basis: 48%;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-crypto);
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.4);
            text-align: center;
        }
        
        .crypto-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .crypto-icon {
            font-size: 2.5em;
            color: var(--color-crypto);
            margin-right: 10px;
            font-weight: 900;
        }
        
        .crypto-item h3 {
            font-size: 1.5em;
            color: var(--color-crypto);
        }
        
        .crypto-info p {
            text-align: left;
            margin: 5px 0;
            font-size: 1.1em;
        }
        
        .crypto-info span {
            float: right;
            font-weight: 700;
        }
        
        .crypto-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .crypto-actions button {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .buy-btn {
            background-color: var(--color-exito);
            color: #fff;
        }
        .buy-btn:hover:not(:disabled) {
            background-color: #4CAF50;
        }
        
        .sell-btn {
            background-color: var(--color-advertencia);
            color: #fff;
        }
        .sell-btn:hover:not(:disabled) {
            background-color: #f44336;
        }


        /* ================================================== */
        /* --- LAYOUT PRINCIPAL CLICKER (3 Columnas) --- */
        /* ================================================== */

        #main-game-layout {
            display: grid;
            /* Grid de 3 columnas: Panel Izq (280px), Centro (Auto), Panel Der (280px) */
            grid-template-columns: 280px auto 280px; 
            width: 100%;
            max-width: 1400px; 
            margin: 0 auto;
            min-height: calc(100vh - 60px); 
        }

        /* --- ESTILOS DEL PANEL LATERAL (Tienda/Mejoras) --- */

        .side-panel {
            background-color: #1e1e1e;
            border-right: 2px solid var(--color-acento-principal);
            padding: 10px 5px;
            overflow-y: auto; 
            height: calc(100vh - 60px); 
            position: sticky;
            top: 0;
        }

        #generadores-panel {
            border-right: none;
            border-left: 2px solid var(--color-acento-principal);
            grid-column: 3;
        }

        /* Título del Panel */
        .side-panel h2 {
            text-align: center;
            color: var(--color-acento-secundario); 
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0, 188, 212, 0.5);
            padding-bottom: 5px;
            font-size: 1.3em;
            position: sticky;
            top: 0; 
            background-color: #1e1e1e;
            z-index: 10;
        }

        /* Estilo de cada elemento de tienda */
        .tienda-item {
            border: 1px solid #333;
            background-color: #242424; 
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.1s, opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .tienda-item:hover {
            background-color: #2e2e2e;
        }

        .tienda-item p {
            font-size: 0.9em;
            margin: 3px 0;
        }

        .tienda-item h3 {
            font-size: 1em;
            color: var(--color-secundario);
            margin-bottom: 5px;
            font-weight: 900;
        }


        /* Estilo para items que no se pueden comprar (bloqueados por gating o costo) */
        .item-bloqueado {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #1a1a1a !important;
            border: 1px dashed #555;
            transform: scale(0.98);
        }

        .item-comprado {
            border: 2px solid var(--color-exito); 
            background-color: #2e3d30;
            opacity: 0.8;
            cursor: default !important;
        }
        
        .item-comprado button {
            cursor: default !important;
        }


        /* --- ESTILOS DEL ÁREA CENTRAL (Clicker y Stats) --- */

        #clicker-area {
            padding: 20px;
            text-align: center;
            grid-column: 2; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
        }

        #clicker-area h1 {
            color: var(--color-acento-principal);
            font-size: 2.5em;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* Sección de Información */
        #info-dinero {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid var(--color-acento-principal);
            box-shadow: 0 0 15px rgba(227, 0, 34, 0.6);
            min-width: 300px;
        }

        #info-dinero p {
            font-size: 1.4em;
            font-weight: 700;
            margin: 5px 0;
        }

        #info-dinero span {
            color: var(--color-acento-secundario);
            font-weight: 900;
        }

        /* Botón de Clic */
        #billete-btn {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background-color: var(--color-exito);
            color: var(--color-texto-claro);
            font-size: 1.5em;
            cursor: pointer;
            border: 10px solid #2e7d32;
            box-shadow: 0 0 35px rgba(56, 142, 60, 0.9);
            transition: transform 0.1s, box-shadow 0.3s;
            outline: none;
            margin-top: 50px;
            font-weight: 900;
        }

        #billete-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 15px rgba(56, 142, 60, 1);
        }

        .emoji-billete {
            display: block;
            font-size: 6em; 
        }

        /* Botones generales */
        .tienda-item button {
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            font-weight: 700;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            font-size: 0.9em;
            transition: background-color 0.1s;
        }
        
        .tienda-item button:hover:not(:disabled) {
            background-color: #00e5ff;
        }

        .tienda-item button:disabled {
            background-color: #444; 
            color: #888;
            cursor: not-allowed;
            opacity: 0.9;
        }

        /* Animación de Clic */
        @keyframes floatAndFade {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -80px); opacity: 0; }
        }

        .animacion-clic {
            position: absolute;
            font-size: 2em;
            font-weight: 900;
            color: #ffd700; 
            text-shadow: 0 0 5px #ff8c00;
            pointer-events: none; 
            animation: floatAndFade 0.8s ease-out;
            z-index: 1000; 
        }
        
        .animacion-crypto {
            color: var(--color-crypto);
            text-shadow: 0 0 5px var(--color-crypto);
        }
        
        /* Reiniciar Juego */
        #reset-btn {
            background-color: var(--color-advertencia);
            color: var(--color-texto-claro);
            padding: 10px;
            border: 2px solid var(--color-advertencia);
            border-radius: 6px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s;
            font-weight: 700;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        #reset-btn:hover {
            background-color: #ff5252;
        }
        
        /* Mensaje de Usuario */
        #user-info-footer {
            text-align: center;
            font-size: 0.8em; 
            color: #888;
            padding: 10px;
        }


        /* ================================================== */
        /* --- MEDIA QUERIES (RESPONSIVENESS) --- */
        /* ================================================== */

        @media (min-width: 1024px) {
            .grid-3-cols {
                grid-template-columns: repeat(3, 1fr); 
            }
             .company-shop .tienda-item, .investment-shop .tienda-item, .asset-shop .tienda-item {
                 width: 32%; /* Tres columnas en desktop */
            }
        }

        @media (max-width: 1023px) {
            
            #nav-bar {
                gap: 5px;
                flex-wrap: wrap; 
                padding: 10px;
            }
            #nav-bar button {
                flex-grow: 1; 
                padding: 8px 10px;
                font-size: 0.8em;
                max-width: none;
            }
            
            #main-game-layout {
                grid-template-columns: 1fr;
                padding-top: 0;
                min-height: auto; 
            }

            #clicker-area {
                grid-row: 1;
                padding-top: 10px;
            }

            /* Los paneles laterales ahora van abajo y se hacen estáticos */
            #mejoras-clic-panel {
                grid-row: 2;
                border-right: none;
                border-bottom: 2px solid var(--color-acento-principal);
            }
            
            #generadores-panel {
                grid-column: 1;
                grid-row: 3;
                border-left: none;
                border-top: 2px solid var(--color-acento-principal);
            }

            .side-panel {
                height: auto; 
                position: static;
                padding: 10px;
            }
            
            /* Tiendas en dos columnas para móviles */
            #mejoras-clic-tienda, #generadores-tienda {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                gap: 10px;
            }

            .tienda-item {
                width: 47%; 
                margin: 5px 0;
            }
            
            #billete-btn {
                width: 200px;
                height: 200px;
                margin-top: 20px;
            }

            /* Activos/Empresas/Inversiones/Crypto en una columna (vertical) */
            .grid-3-cols, .crypto-grid {
                grid-template-columns: 1fr; 
                max-width: 90%;
                flex-direction: column;
            }
            
            .company-shop .tienda-item, .investment-shop .tienda-item, .asset-shop .tienda-item {
                width: 100%; 
            }
            
            .crypto-item {
                flex-basis: 100%;
            }
            
            #stats-grid {
                 grid-template-columns: repeat(2, 1fr); /* 2 columnas en móvil */
            }
        }
        
        @media (max-width: 480px) {
            #stats-grid {
                 grid-template-columns: 1fr; /* 1 columna en móvil pequeño */
            }
        }
    </style>
</head>
<body>
    <div id="fondo-decoracion"></div>

    <div id="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirmación</h3>
            <p id="modal-message">Mensaje del modal.</p>
            <div class="modal-buttons">
                <button id="modal-confirm" onclick="handleModalClick('confirm')">Aceptar</button>
                <button id="modal-cancel" onclick="handleModalClick('cancel')">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="nav-bar">
        <button id="nav-clicker" onclick="cambiarVista('clicker')" class="active"><i class="fas fa-hand-pointer"></i> Clic & Negocios</button>
        <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-car"></i> Activos & Lujos</button>
        <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Mis Empresas</button>
        <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
        <button id="nav-crypto" onclick="cambiarVista('crypto')"><i class="fab fa-bitcoin"></i> Crypto Trading</button>
        <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-pie"></i> Estadísticas</button>
    </div>

    <div id="game-view-container">

        <div id="view-clicker" class="game-view active">
            <div id="main-game-layout">

                <div id="mejoras-clic-panel" class="side-panel">
                    <h2>Mejoras de Clic (IPC)</h2>
                    <div id="mejoras-clic-tienda">
                        </div>
                </div>

                <div id="clicker-area">
                    <h1 style="margin-top: 0;">¡Conviértete en Millonario!</h1>
                    
                    <div id="info-dinero">
                        <p>DINERO: <span id="dinero-actual">$0.00</span></p>
                        <p>IPC (por Clic): <span id="ipc-actual">$1.00</span></p>
                        <p>IPS (por Seg): <span id="ips-actual">$0.00 / s</span></p>
                    </div>

                    <button id="billete-btn" onclick="hacerClick(event)">
                        <span class="emoji-billete">💵</span>
                        HACER CLIC
                    </button>
                    
                </div>

                <div id="generadores-panel" class="side-panel">
                    <h2>Generadores Pasivos (IPS)</h2>
                    <div id="generadores-tienda">
                        </div>
                </div>

            </div>
        </div>

        <div id="view-assets" class="game-view">
            <h1 class="view-title">Activos y Lujos (Efectos Únicos)</h1>
            <div class="grid-3-cols">
                <div class="asset-section" style="grid-column: 1 / -1;">
                    <h2>Mis Lujos Personales (Compra Única)</h2>
                    <div id="activos-tienda" class="asset-shop">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-companies" class="game-view">
             <h1 class="view-title">Empresas (Ingresos Pasivos Sostenidos)</h1>
             <div class="grid-3-cols">
                 <div class="company-section" style="grid-column: 1 / -1;">
                     <h2>Fundar y Escalar Negocios</h2>
                     <div id="empresas-tienda" class="company-shop">
                         </div>
                 </div>
             </div>
        </div>

        <div id="view-investments" class="game-view">
             <h1 class="view-title">Inversiones (Retorno Porcentual)</h1>
             <div class="grid-3-cols">
                 <div class="investment-section" style="grid-column: 1 / -1;">
                     <h2>Instrumentos de Inversión (Apalancamiento)</h2>
                     <div id="inversiones-tienda" class="investment-shop">
                         </div>
                 </div>
             </div>
        </div>

        <div id="view-crypto" class="game-view">
             <h1 class="view-title">Crypto Trading (Volatilidad y Riesgo)</h1>
             <div class="grid-3-cols">
                 <div class="crypto-section" style="grid-column: 1 / -1;">
                     <h2>Mercado de Criptomonedas (Actualiza cada minuto)</h2>
                     <div id="crypto-grid" class="crypto-shop">
                         </div>
                 </div>
             </div>
        </div>


        <div id="view-stats" class="game-view">
            <h1 class="view-title">Estadísticas y Gestión</h1>
            <div class="grid-3-cols">
                
                <div class="stats-panel" style="grid-column: 1 / -1;">
                    <h2>Resumen de Progreso y Dinero</h2>
                    <div id="stats-grid">
                        <div class="stat-card">
                            <p>Dinero Actual</p>
                            <span id="stat-dinero-actual">$0.00</span>
                        </div>
                         <div class="stat-card">
                            <p>Total Dinero Ganado</p>
                            <span id="stat-total-ganado">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <p>Total Clics Realizados</p>
                            <span id="stat-total-clicks">0</span>
                        </div>
                        <div class="stat-card">
                            <p>Ganancia por Clics</p>
                            <span id="stat-dinero-clicks">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <p>Ganancia Pasiva (IPS)</p>
                            <span id="stat-dinero-pasivo">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <p>Ganancia por Crypto</p>
                            <span id="stat-dinero-crypto">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="asset-section" style="grid-column: 1 / -1; margin-top: 20px;">
                    <h2>Gestión de Datos</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: #aaa;">
                        Tu progreso se guarda automáticamente en el navegador y en la nube (si estás conectado).
                    </p>
                    <button id="reset-btn" onclick="resetGame()">
                        <i class="fas fa-trash-alt"></i> REINICIAR TODO EL PROGRESO
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="user-info-footer">
        </div>

</body>
</html>
