<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millonario Clicker (Unificado y Vol√°til)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --color-fondo-oscuro: #121212;
            --color-texto-claro: #E0E0E0;
            --color-acento-principal: #FF5733; /* Rojo para acentos de alto impacto */
            --color-acento-secundario: #33A0FF; /* Cian/Azul para botones de acci√≥n */
            --color-clicker: #6200EE;
            --color-ips: #03DAC6;
            --color-empresa: #FFC107;
            --color-inversion: #2196F3;
            --color-crypto: #F7931A;
        }

        /* FONDO DE IMAGEN: Usando fondo_rojo.jpg como solicitado */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-y: auto;
            overflow-x: hidden;
            background-image: url('fondo_rojo.jpg'); 
            background-size: cover; 
            background-repeat: no-repeat;
            background-attachment: fixed; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .game-container {
            max-width: 1200px;
            width: 95%;
            margin-top: 20px;
            margin-bottom: 70px; 
            background: rgba(0, 0, 0, 0.85); 
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        /* HEADER y STATS */
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-acento-principal);
            padding-bottom: 10px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat {
            text-align: center;
            padding: 10px 15px;
        }

        .stat h2 {
            margin: 5px 0;
            font-size: 1.5em;
            color: var(--color-acento-secundario);
        }

        .stat small {
            color: #999;
            font-size: 0.8em;
        }

        /* NAVEGACI√ìN */
        #nav-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        #nav-bar button {
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-claro);
            border: 2px solid var(--color-acento-secundario);
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            border-radius: 8px;
        }

        #nav-bar button:hover, #nav-bar button.active {
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            border-color: var(--color-acento-secundario);
        }

        /* VISTAS DE JUEGO */
        .game-view {
            display: none;
            padding: 10px;
        }

        .game-view.active {
            display: block;
        }
        
        /* Estilos para la VISTA UNIFICADA CLICKER + TIENDA */
        #view-clicker {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Clicker 1/3, Tienda 2/3 */
            gap: 20px;
            align-items: flex-start;
        }
        
        #click-section {
            text-align: center;
            padding: 20px;
        }

        #click-area button {
            background: var(--color-acento-principal);
            border: none;
            padding: 50px;
            border-radius: 50%;
            font-size: 3em;
            color: var(--color-texto-claro);
            cursor: pointer;
            box-shadow: 0 0 20px var(--color-acento-principal);
            transition: transform 0.1s;
            width: 180px;
            height: 180px;
            margin-top: 50px;
        }

        #click-area button:active {
            transform: scale(0.95);
        }
        
        #store-section {
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
            border-left: 1px solid #333;
        }
        
        .asset-section h3 {
             color: var(--color-acento-principal);
             margin-top: 20px;
             padding-bottom: 5px;
             border-bottom: 1px dashed #555;
        }


        /* TIENDA */
        .tienda-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columnas en la tienda unificada */
            gap: 15px;
            margin-top: 15px;
        }

        .tienda-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border-left: 5px solid var(--color-acento-secundario);
        }

        .tienda-item h3 {
            margin-top: 0;
            color: var(--color-acento-secundario);
            font-size: 1.1em;
        }

        .tienda-item p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .tienda-item button {
            width: 100%;
            padding: 8px;
            background-color: var(--color-acento-secundario); /* Azul/Cian */
            color: var(--color-fondo-oscuro);
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .tienda-item button:hover:not([disabled]) {
            background-color: #66CCFF;
        }

        .item-bloqueado button, .tienda-item button[disabled] {
            background-color: #555;
            cursor: not-allowed;
            color: #AAA;
        }
        
        .item-comprado {
             border-left-color: var(--color-acento-principal);
             opacity: 0.6;
        }

        /* VISTA CRYPTO */
        .crypto-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
             gap: 20px;
        }
        /* ... (otros estilos crypto, stats, modal, footer se mantienen) ... */

        .crypto-item {
             background: rgba(247, 147, 26, 0.1); 
             padding: 20px;
             border-radius: 10px;
             border: 2px solid var(--color-crypto);
        }
        
        .crypto-header {
             display: flex;
             align-items: center;
             margin-bottom: 10px;
        }
        
        .crypto-icon {
             font-size: 1.8em;
             margin-right: 10px;
             color: var(--color-crypto);
        }
        
        .crypto-info p {
             font-size: 1em;
             margin: 8px 0;
        }
        
        .crypto-price { color: var(--color-acento-secundario); font-weight: bold; }
        .crypto-amount { color: var(--color-crypto); font-weight: bold; }
        .text-success { color: #4CAF50; }
        .text-danger { color: #F44336; }
        
        .crypto-actions button {
             padding: 8px 15px;
             margin-right: 10px;
             border: none;
             border-radius: 5px;
             font-weight: bold;
             cursor: pointer;
             transition: background-color 0.2s;
             color: var(--color-fondo-oscuro);
        }
        
        .crypto-actions .buy-btn { background-color: #4CAF50; }
        .crypto-actions .sell-btn { background-color: #F44336; }
        .crypto-actions button:disabled { background-color: #555; cursor: not-allowed; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--color-acento-secundario);
        }

        .stat-card p {
            margin: 0;
            font-size: 0.8em;
            color: #AAA;
        }

        .stat-card span {
            display: block;
            font-size: 1.6em;
            font-weight: bold;
            color: var(--color-acento-principal);
            margin-top: 5px;
        }
        
        #winted-footer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }
        
        /* MODAL */
        #custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            padding-top: 60px;
        }

        .modal-content {
            background-color: var(--color-fondo-oscuro);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--color-acento-principal);
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 87, 51, 0.5);
        }

        .modal-content h3 {
            color: var(--color-acento-principal);
        }

        .modal-content button {
            background-color: var(--color-acento-secundario);
            color: var(--color-fondo-oscuro);
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n global (usa las variables del entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Inicializar servicios y hacerlos accesibles globalmente
        window.firebase = {
            firestore: { getFirestore, doc, getDoc, setDoc, setLogLevel },
            auth: { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged },
            app: initializeApp(firebaseConfig)
        };

        window.db = window.firebase.firestore.getFirestore(window.firebase.app);
        window.auth = window.firebase.auth.getAuth(window.firebase.app);
        
        window.firebase.firestore.setLogLevel('silent'); 

        let isGameInitialized = false;
        let userId = 'anon';

        /**
         * Llama a la funci√≥n de inicio principal del juego solo una vez.
         */
        function handleInitGame() {
            if (isGameInitialized) return; 
            isGameInitialized = true;
            console.log("--- INICIO DE UI GARANTIZADO. User ID:", userId, "---");
            if (typeof window.initGame === 'function') {
                window.initGame(); 
            } else {
                setTimeout(handleInitGame, 50);
            }
        }

        /**
         * Intenta la autenticaci√≥n y establece el userId.
         */
        async function attemptAuth() {
            try {
                if (initialAuthToken) {
                    const userCredential = await window.firebase.auth.signInWithCustomToken(window.auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await window.firebase.auth.signInAnonymously(window.auth);
                    userId = userCredential.user.uid;
                }
            } catch (error) {
                console.error("Error en autenticaci√≥n Firebase, usando ID aleatorio:", error);
                userId = crypto.randomUUID();
            }
            window.userId = userId; // Hacer el userId globalmente accesible
            handleInitGame();
        }

        // 2. Observador de estado de autenticaci√≥n (garantiza el flujo de inicio)
        window.firebase.auth.onAuthStateChanged((user) => {
             if (user) {
                userId = user.uid;
             }
             if (!isGameInitialized) {
                attemptAuth();
             }
        });
    </script>

    <script>
        // ====================================================================
        // --- L√ìGICA DEL JUEGO MILLONARIO CLICKER (JavaScript) ---
        // ====================================================================

        // --- MODELO DE ESTADO ---
        let estadoJuego = {
            dinero: 0,
            ipc: 1, 
            ips: 0, 
            tiendas: {}, 
            activos: {},
            empresas: {},
            inversiones: {},
            crypto: {
                // Cryptos con alta volatilidad
                bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 },
                cardano: { cantidad: 0, valorActual: 0.50, costoPromedio: 0 }, 
                dogecoin: { cantidad: 0, valorActual: 0.10, costoPromedio: 0 },
                litecoin: { cantidad: 0, valorActual: 80, costoPromedio: 0 }, 
                solana: { cantidad: 0, valorActual: 50, costoPromedio: 0 }  
            },
            estadisticas: {
                totalClicks: 0,
                dineroPorClicks: 0,
                dineroPasivo: 0,
                dineroCrypto: 0
            },
            ultimosSegundos: Date.now()
        };
        
        // ID de la aplicaci√≥n para Firebase Firestore
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TIENDA_PATH = `/artifacts/${APP_ID}/users/${window.userId}/tiendaJuego`;
        const LOCAL_STORAGE_KEY = 'millonarioClicker_save'; 
        
        // --- CONSTANTES GLOBALES DE VOLATILIDAD ---
        const CRYPTO_FLUCTUATION_MAX = 0.15; // 15% de cambio m√°ximo base por minuto
        const INVESTMENT_FLUCTUATION_MAX = 0.05; // 5% de cambio m√°ximo base por minuto
        const FLUCTUATION_INTERVAL = 60000; // 60 segundos (1 minuto) para cambios en el valor

        
        // --- DEFINICI√ìN DE TIENDAS ---
        const mejorasClick = {
            'dedo-rapido': { nombre: 'Dedo R√°pido ü§è', costoBase: 10, costoEscalado: 1.15, ipcAumento: 1, tipo: 'ipc', icono: 'üëã' },
            'mouse-gamer': { nombre: 'Mouse Gamer üñ±Ô∏è', costoBase: 100, costoEscalado: 1.15, ipcAumento: 10, tipo: 'ipc', icono: 'üéÆ' },
            'ai-clicker': { nombre: 'Asistente IA ü§ñ', costoBase: 1000, costoEscalado: 1.15, ipcAumento: 100, tipo: 'ipc', icono: 'üí°' },
            'bot-autoclick': { nombre: 'Bot Autoclick ü¶æ', costoBase: 10000, costoEscalado: 1.15, ipcAumento: 1000, tipo: 'ipc', icono: 'ü§ñ' },
            'chip-neural': { nombre: 'Chip Neural üß†', costoBase: 100000, costoEscalado: 1.15, ipcAumento: 10000, tipo: 'ipc', icono: 'üß†' }
        };

        const generadoresIPS = {
            'puesto-limonada': { nombre: 'Puesto de Limonada üçã', costoBase: 50, costoEscalado: 1.15, ipsGenerado: 0.5, tipo: 'ips', icono: 'ü•§' },
            'vendedor-ambulante': { nombre: 'Vendedor Ambulante üíº', costoBase: 500, costoEscalado: 1.15, ipsGenerado: 5, tipo: 'ips', icono: 'üö∂' },
            'tienda-online': { nombre: 'Tienda Online üíª', costoBase: 5000, costoEscalado: 1.15, ipsGenerado: 50, tipo: 'ips', icono: 'üõí' },
            'granja-solar': { nombre: 'Granja Solar ‚òÄÔ∏è', costoBase: 50000, costoEscalado: 1.15, ipsGenerado: 500, tipo: 'ips', icono: '‚ö°' },
            'bienes-raices': { nombre: 'Bienes Ra√≠ces üèòÔ∏è', costoBase: 500000, costoEscalado: 1.15, ipsGenerado: 5000, tipo: 'ips', icono: 'üè†' },
            'planta-nuclear': { nombre: 'Planta Nuclear ‚ò¢Ô∏è', costoBase: 5000000, costoEscalado: 1.15, ipsGenerado: 50000, tipo: 'ips', icono: '‚ò¢Ô∏è' } 
        };
        
        const activosLujos = {
             'coche-lujo': { nombre: 'Coche Deportivo üèéÔ∏è', costo: 50000, efecto: 'Aumenta IPC en 500', ipcAumento: 500, comprado: false, icono: 'üèéÔ∏è' },
             'apartamento': { nombre: 'Apartamento de Lujo üèôÔ∏è', costo: 500000, efecto: 'Aumenta IPS en 50', ipsAumento: 50, comprado: false, icono: 'üèôÔ∏è' },
             'yate': { nombre: 'Yate Privado üõ•Ô∏è', costo: 5000000, efecto: 'Duplica todo el IPC', multiplicadorIPC: 2, comprado: false, icono: 'üõ•Ô∏è' },
             'isla-privada': { nombre: 'Isla Privada üèùÔ∏è', costo: 50000000, efecto: 'Multiplica IPS por 1.5', multiplicadorIPS: 1.5, comprado: false, icono: 'üèùÔ∏è' },
             'cohete-personal': { nombre: 'Cohete Personal üöÄ', costo: 500000000, efecto: 'Multiplica IPC y IPS por 2', multiplicadorIPC: 2, multiplicadorIPS: 2, comprado: false, icono: 'üöÄ' } 
        };
        
        const empresasVistas = {
             'restaurante': { nombre: 'Restaurante Exclusivo üçΩÔ∏è', costo: 1000000, ipsGenerado: 1000, vecesComprado: 0, icono: 'üçΩÔ∏è' },
             'tech-startup': { nombre: 'Tech Startup üöÄ', costo: 10000000, ipsGenerado: 10000, vecesComprado: 0, icono: 'üöÄ' },
             'cadena-hoteles': { nombre: 'Cadena de Hoteles üè®', costo: 100000000, ipsGenerado: 100000, vecesComprado: 0, icono: 'üè®' },
             'aerolinea-lowcost': { nombre: 'Aerol√≠nea Low Cost ‚úàÔ∏è', costo: 1000000000, ipsGenerado: 1000000, vecesComprado: 0, icono: '‚úàÔ∏è' },
             'red-satelital': { nombre: 'Red Satelital üõ∞Ô∏è', costo: 10000000000, ipsGenerado: 10000000, vecesComprado: 0, icono: 'üõ∞Ô∏è' } 
        };
        
        const inversionesVista = {
             'bonos-gobierno': { nombre: 'Bonos Gobierno üèõÔ∏è', costo: 100000, retorno: 0.05, vecesComprado: 0, tipo: 'retorno', icono: 'üèõÔ∏è' }, 
             'crypto-mining': { nombre: 'Crypto Mining ‚õèÔ∏è', costo: 2000000, retorno: 0.1, vecesComprado: 0, tipo: 'retorno', icono: '‚õèÔ∏è' }, 
             'fondo-indexado': { nombre: 'Fondo Indexado S&P üìà', costo: 5000000, retorno: 0.12, vecesComprado: 0, tipo: 'retorno', icono: 'üìä' }, 
             'venture-capital': { nombre: 'Venture Capital üí∏', costo: 50000000, retorno: 0.2, vecesComprado: 0, tipo: 'retorno', icono: 'üí∞' },
             'fondo-cobertura': { nombre: 'Fondo de Cobertura üõ°Ô∏è', costo: 500000000, retorno: 0.3, vecesComprado: 0, tipo: 'retorno', icono: 'üõ°Ô∏è' },
             'commodities': { nombre: 'Materias Primas ‚öôÔ∏è', costo: 1000000000, retorno: 0.25, vecesComprado: 0, tipo: 'retorno', icono: 'üõ¢Ô∏è' },
             'ai-biotech': { nombre: 'Acciones de IA/Bio üß¨', costo: 5000000000, retorno: 0.4, vecesComprado: 0, tipo: 'retorno', icono: 'üß™' },
             'global-risk': { nombre: 'Fondos de Riesgo Global üåç', costo: 10000000000, retorno: 0.5, vecesComprado: 0, tipo: 'retorno', icono: 'üåê' }
        };


        // --- UTILIDADES ---
        
        /** Formatea un n√∫mero como moneda (K, M, B, T...). */
        function formatDinero(num, decimales = 2) {
            num = parseFloat(num);
            if (num === 0) return '$0.00';
            const sign = num < 0 ? '-' : '';
            const absNum = Math.abs(num);
            
            if (absNum < 1000) return sign + '$' + absNum.toFixed(decimales);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Q', 'S', 'O', 'N', 'D', 'UD'];
            const tier = Math.floor(Math.log10(absNum) / 3);
            const suffix = suffixes[tier] || 'E';
            const scale = Math.pow(10, tier * 3);
            const scaled = absNum / scale;

            let formatted = scaled.toFixed(decimales);
            if (tier > 0 && formatted.endsWith('.00')) {
                formatted = scaled.toFixed(0);
            } else if (tier > 0 && formatted.endsWith('.0')) {
                 formatted = scaled.toFixed(1);
            }
            return sign + '$' + formatted + suffix;
        }
        
        /** Formatea un n√∫mero para crypto (m√°s decimales para precisi√≥n) */
        function formatCrypto(num, decimales = 6) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        /** Calcula el costo de la siguiente compra. */
        function calcularCosto(base, escalado, nivel) {
            return base * Math.pow(escalado, nivel);
        }

        /** Muestra una animaci√≥n de texto cuando se hace clic o se genera dinero. */
        function mostrarAnimacion(monto, x, y, esCrypto = false) {
            const anim = document.createElement('div');
            anim.textContent = `${monto > 0 ? '+' : ''}${formatDinero(monto)}`;
            anim.classList.add('animacion-clic');
            
            if (esCrypto) {
                 anim.classList.add('animacion-crypto');
            }
            
            anim.style.left = `${x}px`;
            anim.style.top = `${y}px`;

            document.body.appendChild(anim);

            anim.addEventListener('animationend', () => {
                anim.remove();
            });
        }
        
        // --- FIREBASE & LOCALSTORAGE (Guardar/Cargar) ---
        
        // (Funciones de cargarEstadoNube, guardarEstadoNube, cargarEstadoLocal, guardarEstadoLocal, cargarEstado, guardarEstado se mantienen sin cambios)
        
        async function cargarEstadoNube() {
            if (!window.db || !window.userId) return null;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const docSnap = await window.firebase.firestore.getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Estado cargado desde Firebase.");
                    return docSnap.data();
                }
            } catch (e) {
                console.error("Error cargando el estado desde Firebase: ", e);
            }
            return null;
        }

        async function guardarEstadoNube() {
            if (!window.db || !window.userId) return;
            const docRef = window.firebase.firestore.doc(window.db, TIENDA_PATH);
            try {
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() 
                };
                await window.firebase.firestore.setDoc(docRef, dataToSave);
            } catch (e) {
                console.error("Error guardando el estado en Firebase: ", e);
            }
        }
        
        function cargarEstadoLocal() {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    console.log("Estado cargado desde LocalStorage.");
                    return JSON.parse(savedState);
                }
            } catch (e) {
                console.error("Error cargando el estado desde LocalStorage: ", e);
            }
            return null;
        }
        
        function guardarEstadoLocal() {
            try {
                const dataToSave = {
                    dinero: estadoJuego.dinero,
                    ipc: estadoJuego.ipc,
                    ips: estadoJuego.ips,
                    tiendas: estadoJuego.tiendas,
                    activos: estadoJuego.activos,
                    empresas: estadoJuego.empresas,
                    inversiones: estadoJuego.inversiones,
                    crypto: estadoJuego.crypto,
                    estadisticas: estadoJuego.estadisticas,
                    ultimosSegundos: Date.now() 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Error guardando el estado en LocalStorage: ", e);
            }
        }
        
        async function cargarEstado() {
            let data = cargarEstadoLocal();
            
            if (!data) {
                 data = await cargarEstadoNube();
            }
            
            if (data) {
                estadoJuego = {
                    ...estadoJuego,
                    ...data,
                    dinero: parseFloat(data.dinero || 0),
                    ipc: parseFloat(data.ipc || 1),
                    ips: parseFloat(data.ips || 0),
                    ultimosSegundos: parseFloat(data.ultimosSegundos || Date.now())
                };
                
                estadoJuego.crypto = data.crypto || estadoJuego.crypto;
                estadoJuego.estadisticas = data.estadisticas || estadoJuego.estadisticas;
                
                calcularProgresoOffline();
            } else {
                 await guardarEstado();
            }
        }
        
        async function guardarEstado() {
            guardarEstadoLocal(); 
            await guardarEstadoNube(); 
        }

        // --- L√ìGICA DE JUEGO PRINCIPAL Y VOLATILIDAD ---

        /** * Inicializa el estado de las tiendas si es la primera vez. */
        function inicializarTiendas(tiendas, estadoKey) {
            for (const id in tiendas) {
                if (!estadoJuego[estadoKey][id]) {
                    estadoJuego[estadoKey][id] = { 
                        nivel: 0, 
                        vecesComprado: 0,
                        comprado: tiendas[id].comprado || false, 
                        valorTotal: 0 
                    };
                }
            }
        }
        
        function calcularProgresoOffline() {
            const now = Date.now();
            const elapsedSeconds = (now - estadoJuego.ultimosSegundos) / 1000;
            if (elapsedSeconds > 5) { 
                const dineroGanado = estadoJuego.ips * elapsedSeconds;
                estadoJuego.dinero += dineroGanado;
                console.log(`Ganancia offline: +${formatDinero(dineroGanado)} durante ${Math.round(elapsedSeconds)} segundos.`);
                estadoJuego.estadisticas.dineroPasivo += dineroGanado;
            }
            estadoJuego.ultimosSegundos = now;
        }

        function actualizarUI() {
            document.getElementById('dinero-actual').textContent = formatDinero(estadoJuego.dinero);
            document.getElementById('ipc-actual').textContent = formatDinero(estadoJuego.ipc);
            document.getElementById('ips-actual').textContent = formatDinero(estadoJuego.ips) + " / s";
            
            // Actualizar todas las vistas relevantes, incluyendo la Tienda Unificada
            dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas');
            dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas');
            
            dibujarActivos();
            dibujarEmpresas();
            dibujarInversiones();
            dibujarCryptoView();
            dibujarStatsView(); // ¬°Stats instant√°neos!
            
            document.getElementById('user-info-footer').textContent = `ID de Sesi√≥n: ${window.userId}`;
        }
        
        // L√≥gica de fluctuaci√≥n de Crypto (se ejecuta cada 60 segundos)
        function fluctuarCrypto() {
            
            for (const id in estadoJuego.crypto) {
                const cryptoData = estadoJuego.crypto[id];
                const factor = (Math.random() * (CRYPTO_FLUCTUATION_MAX * 2)) - CRYPTO_FLUCTUATION_MAX; 
                
                let newPrice = cryptoData.valorActual * (1 + factor);
                
                // --- VOLATILIDAD EXTREMA (SIN L√çMITES) ---
                if (id === 'bitcoin' && Math.random() < 0.10) { 
                     newPrice *= (1 + ((Math.random() * 0.8) - 0.4)); 
                } else if (id === 'dogecoin' && Math.random() < 0.15) { 
                     newPrice *= (1 + ((Math.random() * 2.0) - 1.0)); 
                }
                // ----------------------------------------
                
                newPrice = Math.max(0.000001, newPrice); 
                
                cryptoData.valorActual = newPrice;
            }
            
            // Actualizar solo si la vista crypto est√° activa para ahorrar rendimiento
            if (document.getElementById('view-crypto').classList.contains('active')) {
                 dibujarCryptoView();
            }
        }
        
        // L√≥gica de fluctuaci√≥n de Inversiones (se ejecuta cada 60 segundos)
        function fluctuarInversiones() {
            let ipsRecalculado = false; 

            for (const id in inversionesVista) {
                const estado = estadoJuego.inversiones[id];
                if (estado.valorTotal > 0) {
                    
                    let factor = (Math.random() * (INVESTMENT_FLUCTUATION_MAX * 2)) - INVESTMENT_FLUCTUATION_MAX;
                    
                    if (id === 'global-risk' && Math.random() < 0.10) { 
                        factor += ((Math.random() * 0.6) - 0.3);
                    }
                    
                    estado.valorTotal *= (1 + factor);
                    estado.valorTotal = Math.max(0, estado.valorTotal); 
                    
                    ipsRecalculado = true;
                }
            }
            
            if (ipsRecalculado) {
                recalcularIPS();
                // Actualizar solo si la vista de inversiones est√° activa
                if (document.getElementById('view-investments').classList.contains('active')) {
                     dibujarInversiones();
                }
            }
        }


        /** L√≥gica para el bucle de ingresos pasivos (IPS) */
        function bucleJuego() {
            const ganancia = estadoJuego.ips;
            // REQUISITO: Asegurar que se sume al dinero total
            estadoJuego.dinero += ganancia; 
            estadoJuego.estadisticas.dineroPasivo += ganancia;
            
            // REQUISITO: Las estad√≠sticas se actualizan instant√°neamente
            actualizarUI(); 
        }

        // --- L√ìGICA DE DIBUJO DE VISTAS ---
        
        function dibujarTienda(items, contenedorId, estadoKey) {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) return;

            contenedor.innerHTML = '';
            
            for (const id in items) {
                const item = items[id];
                const nivel = estadoJuego[estadoKey][id]?.nivel || 0;
                const costo = calcularCosto(item.costoBase, item.costoEscalado, nivel);
                const puedeComprar = estadoJuego.dinero >= costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                let efectoTexto = '';
                if (item.tipo === 'ipc') {
                    efectoTexto = `+${formatDinero(item.ipcAumento)} IPC por nivel`;
                } else if (item.tipo === 'ips') {
                    efectoTexto = `+${formatDinero(item.ipsGenerado)} IPS por nivel`;
                }
                
                elemento.innerHTML = `
                    <h3>${item.icono} ${item.nombre}</h3>
                    <p>Nivel: <span style="color: var(--color-empresa);">${nivel}</span></p>
                    <p>Efecto: ${efectoTexto}</p>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                    <button onclick="comprarItem('${id}', '${estadoKey}', '${item.tipo}')" ${!puedeComprar ? 'disabled' : ''}>
                        Comprar (Nivel ${nivel + 1})
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        function dibujarActivos() {
            const contenedor = document.getElementById('activos-tienda');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            for (const id in activosLujos) {
                const item = activosLujos[id];
                const estado = estadoJuego.activos[id] || { comprado: false };
                const comprado = estado.comprado;
                const puedeComprar = !comprado && estadoJuego.dinero >= item.costo;

                const elemento = document.createElement('div');
                elemento.className = `tienda-item asset-item ${comprado ? 'item-comprado' : ''} ${!puedeComprar && !comprado ? 'item-bloqueado' : ''}`;
                elemento.dataset.id = id;

                elemento.innerHTML = `
                    <h3>${item.icono || '‚ú®'} ${item.nombre}</h3>
                    <p>Costo: <span style="font-weight: 700;">${formatDinero(item.costo)}</span></p>
                    <p>Efecto: <span style="color: var(--color-inversion);">${item.efecto}</span></p>
                    <button onclick="comprarActivo('${id}')" ${comprado || !puedeComprar ? 'disabled' : ''}>
                        ${comprado ? 'Comprado' : 'Comprar Lujo'}
                    </button>
                `;
                contenedor.appendChild(elemento);
            }
        }
        
        function dibujarEmpresas() {
             const contenedor = document.getElementById('empresas-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in empresasVistas) {
                 const item = empresasVistas[id];
                 const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
                 
                 const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item company-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const ipsTotal = estado.vecesComprado * item.ipsGenerado;

                 elemento.innerHTML = `
                     <h3>${item.icono || 'üè¢'} ${item.nombre}</h3>
                     <p>Compradas: <span style="color: var(--color-empresa);">${estado.vecesComprado}</span></p>
                     <p>IPS Total: <span style="font-weight: 700;">${formatDinero(ipsTotal)} / s</span></p>
                     <p>Costo Pr√≥xima: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarEmpresa('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Fundar Nueva (IPS: +${formatDinero(item.ipsGenerado)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        function dibujarInversiones() {
             const contenedor = document.getElementById('inversiones-tienda');
             if (!contenedor) return;
             contenedor.innerHTML = '';

             for (const id in inversionesVista) {
                 const item = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
                 
                 const costo = item.costo; 
                 const puedeComprar = estadoJuego.dinero >= costo;

                 const elemento = document.createElement('div');
                 elemento.className = `tienda-item investment-item ${!puedeComprar ? 'item-bloqueado' : ''}`;
                 elemento.dataset.id = id;

                 const retornoIPS = estado.valorTotal * item.retorno / 10; 
                 
                 elemento.innerHTML = `
                     <h3>${item.icono || 'üìà'} ${item.nombre}</h3>
                     <p>Valor Total: <span style="color: var(--color-acento-secundario);">${formatDinero(estado.valorTotal)}</span></p>
                     <p>Retorno IPS: <span style="font-weight: 700;">${formatDinero(retornoIPS)} / s</span></p>
                     <p>Costo Paquete: <span style="font-weight: 700;">${formatDinero(costo)}</span></p>
                     <button onclick="comprarInversion('${id}')" ${!puedeComprar ? 'disabled' : ''}>
                         Invertir (+${formatDinero(item.costo)})
                     </button>
                 `;
                 contenedor.appendChild(elemento);
             }
        }
        
        function dibujarCryptoView() {
            const contenedor = document.getElementById('crypto-grid');
            if (!contenedor) return;
            contenedor.innerHTML = '';

            const cryptos = [
                { id: 'bitcoin', nombre: 'Bitcoin (BTC)', icono: '‚Çø' },
                { id: 'ethereum', nombre: 'Ethereum (ETH)', icono: 'Œû' },
                { id: 'cardano', nombre: 'Cardano (ADA)', icono: '‚Ç≥' },
                { id: 'dogecoin', nombre: 'Dogecoin (DOGE)', icono: '∆â' },
                { id: 'litecoin', nombre: 'Litecoin (LTC)', icono: '≈Å' },
                { id: 'solana', nombre: 'Solana (SOL)', icono: '‚óé' }
            ];

            cryptos.forEach(({ id, nombre, icono }) => {
                const cryptoData = estadoJuego.crypto[id];
                const valorActual = cryptoData.valorActual;
                const cantidad = cryptoData.cantidad;
                
                const valorActualTotal = cantidad * valorActual;
                const perdidaGanancia = cantidad > 0 ? (valorActualTotal - (cantidad * cryptoData.costoPromedio)) : 0;
                
                const puedeVender = cantidad > 0;
                const puedeComprar = estadoJuego.dinero >= valorActual;

                const elemento = document.createElement('div');
                elemento.className = 'crypto-item';
                
                elemento.innerHTML = `
                    <div class="crypto-header">
                        <span class="crypto-icon">${icono}</span>
                        <h3>${nombre}</h3>
                    </div>
                    <div class="crypto-info">
                        <p>Valor Actual: <span class="crypto-price">${formatDinero(valorActual, valorActual < 10 ? 4 : 2)}</span></p>
                        <p>Tu Cantidad: <span class="crypto-amount">${formatCrypto(cantidad)}</span></p>
                        <p>Costo Promedio: <span class="crypto-avg">${formatDinero(cryptoData.costoPromedio, 2)}</span></p>
                        <p>Ganancia No Realizada: 
                            <span class="${perdidaGanancia >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatDinero(perdidaGanancia, 2)}
                            </span>
                        </p>
                    </div>
                    <div class="crypto-actions">
                        <button onclick="comprarCrypto('${id}')" ${!puedeComprar ? 'disabled' : ''} class="buy-btn">
                            Comprar 1 (${formatDinero(valorActual, 2)})
                        </button>
                        <button onclick="venderCrypto('${id}')" ${!puedeVender ? 'disabled' : ''} class="sell-btn">
                            Vender 1 (${formatDinero(valorActual, 2)})
                        </button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
        }
        
        function dibujarStatsView() {
            const stats = estadoJuego.estadisticas;
            const totalDineroGanado = stats.dineroPorClicks + stats.dineroPasivo + stats.dineroCrypto;
            
            document.getElementById('stat-dinero-actual').textContent = formatDinero(estadoJuego.dinero); 
            
            document.getElementById('stat-total-clicks').textContent = stats.totalClicks.toLocaleString('es-ES');
            document.getElementById('stat-dinero-clicks').textContent = formatDinero(stats.dineroPorClicks);
            document.getElementById('stat-dinero-pasivo').textContent = formatDinero(stats.dineroPasivo);
            document.getElementById('stat-dinero-crypto').textContent = formatDinero(stats.dineroCrypto);
            
            document.getElementById('stat-total-ganado').textContent = formatDinero(totalDineroGanado);
        }

        // --- FUNCIONES ACCIONABLES (GLOBALES) ---
        
        window.hacerClick = function(e) {
            estadoJuego.dinero += estadoJuego.ipc;
            
            estadoJuego.estadisticas.totalClicks++;
            estadoJuego.estadisticas.dineroPorClicks += estadoJuego.ipc;
            
            const x = e.clientX;
            const y = e.clientY;
            mostrarAnimacion(estadoJuego.ipc, x, y);

            actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
            guardarEstado(); 
        }

        window.comprarItem = function(id, estadoKey, tipo) {
            const item = (tipo === 'ipc' ? mejorasClick[id] : generadoresIPS[id]);
            const estadoActual = estadoJuego[estadoKey][id] || { nivel: 0 };
            const costo = calcularCosto(item.costoBase, item.costoEscalado, estadoActual.nivel);

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estadoActual.nivel++;
                estadoJuego[estadoKey][id] = estadoActual;

                recalcularIPC(); 
                recalcularIPS();
                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
            }
        }
        
        window.comprarActivo = function(id) {
            const item = activosLujos[id];
            const estado = estadoJuego.activos[id] || { comprado: false };
            
            if (!estado.comprado && estadoJuego.dinero >= item.costo) {
                estadoJuego.dinero -= item.costo;
                estado.comprado = true;
                estadoJuego.activos[id] = estado;
                
                recalcularIPC(); 
                recalcularIPS();
                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
            }
        }
        
        window.comprarEmpresa = function(id) {
            const item = empresasVistas[id];
            const estado = estadoJuego.empresas[id] || { vecesComprado: 0 };
            const costo = item.costo * Math.pow(1.1, estado.vecesComprado); 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estadoJuego.empresas[id] = estado;
                
                recalcularIPS();
                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
            }
        }

        window.comprarInversion = function(id) {
            const item = inversionesVista[id];
            const estado = estadoJuego.inversiones[id] || { vecesComprado: 0, valorTotal: 0 };
            const costo = item.costo; 

            if (estadoJuego.dinero >= costo) {
                estadoJuego.dinero -= costo;
                estado.vecesComprado++;
                estado.valorTotal += costo; 
                estadoJuego.inversiones[id] = estado;
                
                recalcularIPS(); 
                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
            }
        }
        
        window.comprarCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;
            
            if (estadoJuego.dinero >= valor) {
                estadoJuego.dinero -= valor;
                
                const nuevaCantidad = crypto.cantidad + 1;
                const costoTotalAnterior = crypto.cantidad * crypto.costoPromedio;
                const nuevoCostoTotal = costoTotalAnterior + valor;
                
                crypto.costoPromedio = nuevoCostoTotal / nuevaCantidad;
                crypto.cantidad = nuevaCantidad;

                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
                showModal(`Compraste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Compra Exitosa', false);
            } else {
                 showModal(`Necesitas ${formatDinero(valor, 2)} para comprar 1 unidad de ${id.toUpperCase()}.`, 'Dinero Insuficiente', false);
            }
        }

        window.venderCrypto = function(id) {
            const crypto = estadoJuego.crypto[id];
            const valor = crypto.valorActual;

            if (crypto.cantidad > 0) {
                estadoJuego.dinero += valor;
                crypto.cantidad -= 1;
                
                if (crypto.cantidad === 0) {
                     crypto.costoPromedio = 0;
                } 
                
                const gananciaPerdida = valor - crypto.costoPromedio;
                estadoJuego.estadisticas.dineroCrypto += gananciaPerdida;
                
                actualizarUI(); // REQUISITO: Actualizar stats instant√°neamente
                guardarEstado(); 
                showModal(`Vendiste 1 unidad de ${id.toUpperCase()} a ${formatDinero(valor, 2)}`, 'Venta Exitosa', false);
            }
        }

        /** Recalcula el IPC total base + multiplicadores. */
        function recalcularIPC() {
            let baseIPC = 1; 
            
            for (const id in mejorasClick) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 if (mejorasClick[id].tipo === 'ipc') {
                    baseIPC += nivel * mejorasClick[id].ipcAumento;
                 }
            }
            
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado) {
                    if (activosLujos[id].ipcAumento) {
                         baseIPC += activosLujos[id].ipcAumento;
                    }
                }
            }

            estadoJuego.ipc = baseIPC;
            
            let multiplicador = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPC) {
                    multiplicador *= activosLujos[id].multiplicadorIPC;
                }
            }
            
            estadoJuego.ipc = estadoJuego.ipc * multiplicador;
        }

        /** Recalcula el IPS total de todas las fuentes, incluyendo el valor din√°mico de las inversiones. */
        function recalcularIPS() {
            let totalIPS = 0;

            // 1. IPS de Generadores (Tienda Unificada)
            for (const id in generadoresIPS) {
                 const nivel = estadoJuego.tiendas[id]?.nivel || 0;
                 totalIPS += nivel * generadoresIPS[id].ipsGenerado;
            }
            
            // 2. IPS de Activos Fijos (suma)
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].ipsAumento) {
                    totalIPS += activosLujos[id].ipsAumento;
                }
            }

            // 3. IPS de Empresas
            for (const id in empresasVistas) {
                 const vecesComprado = estadoJuego.empresas[id]?.vecesComprado || 0;
                 totalIPS += vecesComprado * empresasVistas[id].ipsGenerado;
            }
            
            // 4. IPS de Inversiones (porcentaje de valor TOTAL DIN√ÅMICO)
            for (const id in inversionesVista) {
                 const inversion = inversionesVista[id];
                 const estado = estadoJuego.inversiones[id] || { valorTotal: 0 };
                 
                 totalIPS += estado.valorTotal * inversion.retorno / 10; 
            }
            
            // Aplicar multiplicadores IPS de Activos
            let multiplicadorIPS = 1;
            for (const id in activosLujos) {
                if (estadoJuego.activos[id]?.comprado && activosLujos[id].multiplicadorIPS) {
                    multiplicadorIPS *= activosLujos[id].multiplicadorIPS;
                }
            }
            totalIPS = totalIPS * multiplicadorIPS;


            estadoJuego.ips = totalIPS;
        }


        // --- Vistas y Control ---
        
        window.cambiarVista = function(vista) {
            document.querySelectorAll('.game-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${vista}`).classList.add('active');
            
            // Se actualizan todas las vistas al cambiar
            if (vista === 'clicker') {
                dibujarTienda(mejorasClick, 'mejoras-clic-tienda', 'tiendas');
                dibujarTienda(generadoresIPS, 'generadores-tienda', 'tiendas');
            }
            if (vista === 'assets') dibujarActivos();
            if (vista === 'companies') dibujarEmpresas();
            if (vista === 'investments') dibujarInversiones();
            if (vista === 'crypto') dibujarCryptoView();
            if (vista === 'stats') dibujarStatsView();

            document.querySelectorAll('#nav-bar button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id.includes(vista)) {
                    btn.classList.add('active');
                }
            });
        }

        /** * Funci√≥n de inicializaci√≥n principal del juego. */
        window.initGame = async function() {
            // Inicializar estructuras de datos si faltan
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');

            await cargarEstado(); 
            
            recalcularIPC();
            recalcularIPS();
            
            actualizarUI(); 
            
            // Configurar el bucle del juego (1 segundo)
            setInterval(bucleJuego, 1000); 
            
            // Guardar el estado cada 30 segundos (REQUISITO)
            setInterval(guardarEstado, 30000); 
            
            // Bucle de fluctuaci√≥n de crypto (1 minuto)
            setInterval(fluctuarCrypto, FLUCTUATION_INTERVAL);
            
            // Bucle de fluctuaci√≥n de inversiones (1 minuto)
            setInterval(fluctuarInversiones, FLUCTUATION_INTERVAL);
            
            cambiarVista('clicker');
        };
        
        window.resetGame = async function() {
            // (La l√≥gica de resetGame se mantiene sin cambios)
            const confirmed = await showModal('¬øEst√°s seguro de que quieres REINICIAR el juego? Perder√°s todo el progreso (Local y Nube).', '¬°PELIGRO!', true);
            if (!confirmed) return;
            
            estadoJuego = {
                dinero: 0,
                ipc: 1, 
                ips: 0, 
                tiendas: {}, 
                activos: {},
                empresas: {},
                inversiones: {},
                crypto: {
                    bitcoin: { cantidad: 0, valorActual: 20000, costoPromedio: 0 },
                    ethereum: { cantidad: 0, valorActual: 1500, costoPromedio: 0 },
                    cardano: { cantidad: 0, valorActual: 0.50, costoPromedio: 0 }, 
                    dogecoin: { cantidad: 0, valorActual: 0.10, costoPromedio: 0 },
                    litecoin: { cantidad: 0, valorActual: 80, costoPromedio: 0 },
                    solana: { cantidad: 0, valorActual: 50, costoPromedio: 0 }
                },
                estadisticas: {
                    totalClicks: 0,
                    dineroPorClicks: 0,
                    dineroPasivo: 0,
                    dineroCrypto: 0
                },
                ultimosSegundos: Date.now()
            };
            
            inicializarTiendas(mejorasClick, 'tiendas');
            inicializarTiendas(generadoresIPS, 'tiendas');
            inicializarTiendas(activosLujos, 'activos');
            inicializarTiendas(empresasVistas, 'empresas');
            inicializarTiendas(inversionesVista, 'inversiones');
            
            recalcularIPC();
            recalcularIPS();
            actualizarUI();
            
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            await guardarEstado();
            
            showModal('Juego Reiniciado con √©xito. ¬°Vuelve a hacerte millonario!', '√âxito', false);
        }
        
        // --- UTILIDAD: Modal Custom para Reemplazar Alert/Confirm ---
        
        let modalResolve;

        function showModal(message, title = 'Confirmaci√≥n', isConfirm = true) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                if (isConfirm) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    confirmBtn.textContent = 'S√≠, Reiniciar';
                    cancelBtn.textContent = 'Cancelar';
                } else {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                    confirmBtn.textContent = 'Aceptar';
                }

                modalResolve = resolve;
                modal.style.display = 'block';
            });
        }
        
        window.handleModalClick = function(action) {
            document.getElementById('custom-modal').style.display = 'none';
            if (modalResolve) {
                modalResolve(action === 'confirm');
                modalResolve = null;
            }
        }
    </script>
</head>
<body>

    <div class="game-container">
        
        <header>
            <h1>Millonario Clicker üí∞</h1>
            <div class="stats-bar">
                <div class="stat">
                    <small>Dinero Actual</small>
                    <h2 id="dinero-actual">$0.00</h2>
                </div>
                <div class="stat">
                    <small>Ingreso por Clic (IPC)</small>
                    <h2 id="ipc-actual">$1.00</h2>
                </div>
                <div class="stat">
                    <small>Ingreso Pasivo (IPS)</small>
                    <h2 id="ips-actual">$0.00 / s</h2>
                </div>
            </div>
        </header>

        <nav id="nav-bar">
            <button id="nav-clicker" onclick="cambiarVista('clicker')"><i class="fas fa-home"></i> Principal</button>
            <button id="nav-assets" onclick="cambiarVista('assets')"><i class="fas fa-gem"></i> Activos</button>
            <button id="nav-companies" onclick="cambiarVista('companies')"><i class="fas fa-building"></i> Empresas</button>
            <button id="nav-investments" onclick="cambiarVista('investments')"><i class="fas fa-chart-line"></i> Inversiones</button>
            <button id="nav-crypto" onclick="cambiarVista('crypto')"><i class="fab fa-bitcoin"></i> Crypto</button>
            <button id="nav-stats" onclick="cambiarVista('stats')"><i class="fas fa-chart-bar"></i> Estad√≠sticas</button>
        </nav>
        
        <div id="view-clicker" class="game-view active">
            
            <div id="click-section">
                <h2>Hacer Click üëÜ</h2>
                <div id="click-area">
                    <button onclick="hacerClick(event)">
                        $$$
                    </button>
                </div>
                 <div id="winted-footer">
                    echo por winted studios
                </div>
            </div>

            <div id="store-section">
                <h2>Comprar Mejoras Instant√°neas</h2>
                
                <div class="asset-section">
                    <h3>Mejoras de Ingreso por Clic (IPC)</h3>
                    <div id="mejoras-clic-tienda" class="tienda-grid">
                        </div>
                </div>

                <div class="asset-section">
                    <h3>Generadores de Ingreso Pasivo (IPS)</h3>
                    <div id="generadores-tienda" class="tienda-grid">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-assets" class="game-view">
            <h2>Activos de Lujo (Multiplicadores y Bonos)</h2>
            <div id="activos-tienda" class="tienda-grid">
                </div>
        </div>

        <div id="view-companies" class="game-view">
            <h2>Compra de Empresas (IPS Fijo por Unidad)</h2>
            <div id="empresas-tienda" class="tienda-grid">
                </div>
        </div>
        
        <div id="view-investments" class="game-view">
            <h2>Inversiones y Acciones (Valor Fluct√∫a cada 60s)</h2>
            <p style="text-align: center; color: var(--color-acento-principal);">‚ö†Ô∏è **MERCADO VOL√ÅTIL:** El valor de tu inversi√≥n (y el IPS que genera) sube y baja cada minuto.</p>
            <div id="inversiones-tienda" class="tienda-grid">
                </div>
        </div>

        <div id="view-crypto" class="game-view">
            <h2>Criptomonedas (Compra/Venta)</h2>
            <p style="text-align: center; color: var(--color-acento-principal);">üìà **VOLATILIDAD EXTREMA:** El precio cambia cada minuto. ¬°Compra barato, vende caro!</p>
            <div id="crypto-grid" class="crypto-grid">
                </div>
        </div>

        <div id="view-stats" class="game-view">
            <div class="asset-section">
                <h2>Resumen de Riqueza</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: var(--color-acento-principal);">
                        <p>Valor Total Ganado</p>
                        <span id="stat-total-ganado">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Dinero Actual</p>
                        <span id="stat-dinero-actual">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Total Clics Realizados</p>
                        <span id="stat-total-clicks">0</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Clics</p>
                        <span id="stat-dinero-clicks">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia Pasiva (IPS)</p>
                        <span id="stat-dinero-pasivo">$0.00</span>
                    </div>
                    <div class="stat-card">
                        <p>Ganancia por Crypto</p>
                        <span id="stat-dinero-crypto">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="asset-section" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>Gesti√≥n de Datos</h2>
                <p style="text-align: center; margin-bottom: 20px; color: #aaa;">
                    Tu progreso se guarda autom√°ticamente cada 30 segundos en LocalStorage y la Nube.
                </p>
                <button id="reset-btn" onclick="resetGame()">
                    <i class="fas fa-trash-alt"></i> REINICIAR TODO EL PROGRESO
                </button>
            </div>
        </div>
        
    </div>
    
    <div id="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title">T√≠tulo</h3>
            <p id="modal-message">Mensaje...</p>
            <button id="modal-confirm" onclick="handleModalClick('confirm')">Confirmar</button>
            <button id="modal-cancel" onclick="handleModalClick('cancel')">Cancelar</button>
        </div>
    </div>
    
    <div id="user-info-footer" style="position: fixed; bottom: 5px; left: 5px; font-size: 0.7em; color: #666;">
        </div>

</body>
</html>
