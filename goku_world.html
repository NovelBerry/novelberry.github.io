<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goku World by Winted Studios</title>
<style>
  html,body{height:100%;margin:0;background:linear-gradient(#87ceeb,#bfe9ff);font-family:Arial,Helvetica,sans-serif}
  canvas{display:block;margin:0 auto;background:linear-gradient(#9be6ff,#6ec6ff);box-shadow:0 8px 30px rgba(0,0,0,0.25);border-radius:8px}
  #ui{width:900px;margin:12px auto;text-align:center;color:#012}
  #title{font-weight:700;font-size:28px;margin-bottom:6px}
  #info{display:flex;justify-content:space-between;align-items:center}
  button{padding:8px 12px;border-radius:6px;border:none;background:#0b84ff;color:white;cursor:pointer}
</style>
</head>
<body>
<div id="ui">
  <div id="title">Goku World <small>by Winted Studios</small></div>
  <div id="info">
    <div>Vidas: <span id="lives">8</span> &nbsp; Nivel: <span id="level">1</span> &nbsp; Estado: <span id="state">Normal</span></div>
    <div><button id="startBtn">Iniciar / Reiniciar</button></div>
  </div>
</div>
<canvas id="game" width="900" height="500"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let levelIndex=0,lives=8,keys={},gameRunning=false;
const TILE=40;

let player={x:80,y:H-150,w:28,h:40,dx:0,dy:0,speed:3.2,jumpPow:-11,onGround:false,facing:1,powered:false,big:false,hitBuffer:0,invuln:0};
let projectiles=[],enemies=[],powerups=[];let camX=0;

function makeEmptyMap(){
  const cols=Math.floor(W/TILE)+20;const rows=Math.floor(H/TILE);
  let map=[];for(let r=0;r<rows;r++){map[r]=Array(cols).fill(0);}return map;
}

let maps=[];
for(let i=1;i<=15;i++){
  let map=makeEmptyMap();
  for(let c=0;c<map[0].length;c++)map[map.length-1][c]=1; // piso base
  // plataformas simples
  let platCount=3+Math.floor(i/2);
  for(let p=0;p<platCount;p++){
    let row=map.length-3-Math.floor(Math.random()*3);
    let col=8+p*6;
    for(let k=0;k<4;k++)map[row][col+k]=1;
  }
  map[map.length-2][map[0].length-4]=9; // bandera
  maps.push(map);
}

function loadLevel(idx){
  levelIndex=idx;enemies=[];projectiles=[];powerups=[];
  let map=maps[idx];
  // enemigos
  for(let e=0;e<3+Math.floor(idx/2);e++){
    let ex=300+e*160;let ey=H-80-((e%2)*TILE);
    enemies.push({x:ex,y:ey,w:30,h:36,dx:Math.random()>0.5?1.2:-1.2,hp:1,type:'grunt'});
  }
  // powerup en lugar obvio
  if(idx%3===0){
    powerups.push({x:200+idx*60,y:H-150,type:'blueflower',picked:false});
  }
  // miniboss en nivel 10 y 15
  if(idx===9||idx===14){
    enemies.push({x:map[0].length*TILE-300,y:H-110,w:70,h:70,dx:0,hp:3,type:'miniboss',hitCount:0});
  }
  player.x=80;player.y=H-150;player.dx=player.dy=0;player.onGround=false;player.powered=false;player.big=false;player.hitBuffer=0;player.invuln=0;
  document.getElementById('lives').textContent=lives;
  document.getElementById('level').textContent=idx+1;
  document.getElementById('state').textContent='Normal';
}

window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(e.code==='Space')e.preventDefault();});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});

function rectsOverlap(a,b){return a.x<a.x+a.w&&a.x+a.w>b.x&&a.y<a.y+a.h&&a.y+a.h>b.y}

function handlePlayerHit(){
  if(player.invuln>0)return;
  if(player.powered&&player.hitBuffer>1){player.hitBuffer--;player.invuln=40;return;}
  lives--;player.invuln=60;player.powered=false;player.big=false;player.hitBuffer=0;
  if(lives<=0){alert('Game Over');lives=8;loadLevel(0);}document.getElementById('lives').textContent=lives;
}

function step(){if(!gameRunning)return;
  let left=keys['a']||keys['arrowleft'];let right=keys['d']||keys['arrowright'];
  if(left){player.dx=-player.speed;player.facing=-1;}else if(right){player.dx=player.speed;player.facing=1;}else player.dx=0;
  if((keys[' ']||keys['w']||keys['arrowup'])&&player.onGround){player.dy=player.jumpPow;player.onGround=false;}
  if(keys['x']&&player.powered){if(!player.lastShot||Date.now()-player.lastShot>300){projectiles.push({x:player.x+(player.facing>0?player.w:-8),y:player.y+player.h/2,dx:player.facing*8,w:18,h:8});player.lastShot=Date.now();}}
  player.dy+=0.6;if(player.dy>12)player.dy=12;player.x+=player.dx;player.y+=player.dy;
  // colision piso
  if(player.y+player.h>H-TILE){player.y=H-TILE-player.h;player.dy=0;player.onGround=true;}
  camX=Math.max(0,player.x-200);
  // enemigos
  for(let en of enemies){
    if(en.type==='grunt')en.x+=en.dx;
    if(rectsOverlap(player,en)){
      if(player.dy>0&&player.y+player.h-en.y<20){
        // salto sobre enemigo
        if(en.type==='miniboss'){en.hitCount++;if(en.hitCount>=3)en.hp=0;}
        else en.hp=0;player.dy=-8;player.onGround=false;
      }else handlePlayerHit();
    }
  }
  enemies=enemies.filter(e=>e.hp>0);
  // proyectiles
  for(let i=projectiles.length-1;i>=0;i--){
    let p=projectiles[i];p.x+=p.dx;
    for(let en of enemies){if(p.x<en.x+en.w&&p.x+p.w>en.x&&p.y<en.y+en.h&&p.y+p.h>en.y){en.hp-=1;projectiles.splice(i,1);}}
    if(p.x<camX-50||p.x>camX+W+50)projectiles.splice(i,1);
  }
  // powerups
  for(let i=powerups.length-1;i>=0;i--){
    let pu=powerups[i];if(player.x<pu.x+24&&player.x+player.w>pu.x&&player.y<pu.y+24&&player.y+player.h>pu.y){
      if(pu.type==='blueflower'){player.powered=true;player.big=true;player.hitBuffer=2;}
      powerups.splice(i,1);
    }
  }
}

function draw(){ctx.clearRect(0,0,W,H);drawMap(maps[levelIndex]);for(let pu of powerups)drawFlower(pu.x-camX,pu.y);for(let en of enemies)drawEnemy(en.x-camX,en.y,en);for(let p of projectiles){ctx.fillStyle='#0af';ctx.fillRect(p.x-camX,p.y,p.w,p.h);}drawPlayer(player.x-camX,player.y);drawFlag((maps[levelIndex][0].length-4)*TILE-camX,H-120);}

function drawMap(map){for(let r=0;r<map.length;r++){for(let c=0;c<map[0].length;c++){let t=map[r][c];let x=c*TILE-camX,y=r*TILE;if(t===1){ctx.fillStyle='#7e5a2f';ctx.fillRect(x,y,TILE,TILE);}}}}
function drawFlag(x,y){ctx.fillStyle='#8b4513';ctx.fillRect(x+6,y,8,60);ctx.fillStyle='#ff1a1a';ctx.fillRect(x+14,y,40,20);}
function drawPlayer(sx,sy){ctx.save();ctx.translate(sx,sy);if(player.big)ctx.scale(1.2,1.2);ctx.fillStyle='#fce0b0';ctx.fillRect(4,2,18,18);ctx.fillStyle=player.powered?'#00f':'#ff7f00';ctx.beginPath();ctx.moveTo(6,6);ctx.lineTo(2,-4);ctx.lineTo(12,8);ctx.lineTo(18,-6);ctx.lineTo(24,10);ctx.closePath();ctx.fill();ctx.fillStyle='#ff8c00';ctx.fillRect(2,20,22,20);ctx.fillStyle='#003';ctx.fillRect(2,34,22,6);ctx.fillStyle='#fce0b0';ctx.fillRect(player.facing>0?20:-8,22,8,8);ctx.restore();}
function drawEnemy(x,y,en){ctx.fillStyle=en.type==='miniboss'?'#802':'#255';ctx.fillRect(x,y,en.w,en.h);}
function drawFlower(x,y){ctx.save();ctx.translate(x,y);ctx.fillStyle='#0af';ctx.beginPath();ctx.arc(12,8,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.fillRect(10,16,4,8);ctx.restore();}

function loop(){step();draw();requestAnimationFrame(loop);}document.getElementById('startBtn').addEventListener('click',()=>{lives=8;loadLevel(0);gameRunning=true;});
loadLevel(0);loop();
</script>
</body>
</html>
