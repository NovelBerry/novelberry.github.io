<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goku World by Winted Studios</title>
<style>
  html,body {
    height: 100%;
    margin: 0;
    background: #87ceeb;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  canvas {
    display: block;
    background: linear-gradient(#9be6ff,#6ec6ff);
    box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    border-radius: 10px;
  }
</style>
</head>
<body>
<canvas id="game" width="1280" height="720"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;

const W = canvas.width, H = canvas.height, TILE = 48;

// Estado del juego
let maps = [], levelIndex = 0, lives = 8, coins = 0, gameRunning = false;
let keys = {};
let player = {
  x: 100, y: H-5*TILE, w: 32, h: 40,
  dx: 0, dy: 0, speed: 4, jumpPow: -14,
  onGround: false, facing: 1, powered: false, big: false,
  hitBuffer: 0, invuln: 0, lastShot: 0, powerStart: 0
};
let camX = 0;
let enemies = [], projectiles = [], powerups = [], animations = [];

// Audio
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
function beep(freq, dur, type='square', vol=0.2){
  try {
    ensureAudio();
    let o = audioCtx.createOscillator();
    let g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur/1000);
  } catch(e){}
}
const coinSound = ()=>{beep(1000,80);beep(1500,80,'triangle',0.15);}
const blockSound = ()=>beep(400,100,'sawtooth');
const powerupSound = ()=>beep(700,200,'square');
const hitSound = ()=>beep(200,150,'sawtooth');
const kameSound = ()=>beep(1200,100,'square');

// Mapas
function makeEmptyMap(cols){ 
  cols = cols || Math.floor(W/TILE) + 40;
  const rows = Math.floor(H/TILE);
  return Array.from({length:rows},()=>Array(cols).fill(0));
}
function createLevels(){
  for(let i=0;i<15;i++){
    let cols = Math.floor(W/TILE) + 40 + i*2;
    let map = makeEmptyMap(cols);
    for(let c=0;c<cols;c++) map[map.length-1][c] = 1; // suelo
    // plataformas alcanzables
    for(let p=0;p<6;p++){
      let col = 8 + p*6;
      let row = map.length-3 - Math.floor(Math.random()*3);
      for(let k=0;k<3;k++) if(col+k < cols-4) map[row][col+k] = 1;
    }
    // bloques y flor
    let r = map.length-5;
    map[r][10] = 3; map[r][12] = 3; map[r][14] = 4;
    // hueco
    let hole = Math.floor(cols/2)-1;
    map[map.length-1][hole] = 0; map[map.length-1][hole+1]=0;
    // bandera
    map[map.length-2][cols-4] = 9;
    maps.push(map);
  }
}
function populateLevel(idx){
  enemies=[]; projectiles=[]; powerups=[]; animations=[];
  const map = maps[idx]; const cols = map[0].length;
  for(let g=0;g<3+Math.floor(idx/2);g++){
    let spawnX = 300+g*200; 
    enemies.push({x:spawnX,y:H-2*TILE,w:32,h:36,dx:1.2,hp:1,type:'grunt'});
  }
  if(idx===9||idx===14){
    enemies.push({x:cols*TILE-420,y:H-3*TILE,w:96,h:96,dx:0,hp:3,type:'miniboss',hitCount:0,hitsRequired:3});
  }
}
function loadLevel(i){
  levelIndex = i; 
  player.x=100; player.y=H-4*TILE; player.dy=0;
  player.powered=false; player.big=false; player.hitBuffer=0;
  populateLevel(i);
}

// Entradas
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.code==='Space') e.preventDefault();
  if(e.code==='Enter'){gameRunning=true;ensureAudio();}
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// Física
function rectsOverlap(a,b){
  return a.x<a.x+a.w && a.x+a.w>b.x && a.y<a.y+a.h && a.y+a.h>b.y;
}
function handleMapCollisions(){
  const map = maps[levelIndex];
  let left = Math.floor(player.x/TILE), right=Math.floor((player.x+player.w)/TILE);
  let top=Math.floor(player.y/TILE), bottom=Math.floor((player.y+player.h)/TILE);
  player.onGround=false;
  // vertical
  if(player.dy>=0){
    let r=bottom;
    for(let c=left;c<=right;c++){
      if(map[r]&&map[r][c]===1){
        player.y=r*TILE-player.h; player.dy=0; player.onGround=true;
      }
    }
  }
  if(player.dy<0){
    let r=top;
    for(let c=left;c<=right;c++){
      if(map[r]&&map[r][c]){
        if(map[r][c]===3){ coins++; coinSound(); map[r][c]=0; }
        if(map[r][c]===4){ map[r][c]=0; blockSound(); powerups.push({x:c*TILE,y:r*TILE-40,type:'blueflower'}); }
        player.dy=0;
      }
    }
  }
}
function handlePlayerHit(){
  if(player.invuln>0) return;
  if(player.powered && player.hitBuffer>1){
    player.hitBuffer--; player.invuln=40; hitSound(); return;
  }
  lives--; hitSound();
  if(lives<=0){lives=8;coins=0;loadLevel(levelIndex);}
}

// Game step
function step(){
  if(!gameRunning) return;
  let left=keys['a']||keys['arrowleft'], right=keys['d']||keys['arrowright'];
  let jump=keys[' ']||keys['w']||keys['arrowup'];
  if(left){player.dx=-player.speed;player.facing=-1;}
  else if(right){player.dx=player.speed;player.facing=1;}
  else player.dx=0;
  if(jump && player.onGround){player.dy=player.jumpPow;player.onGround=false;}
  if(keys['x']&&player.powered){
    if(Date.now()-player.lastShot>260){
      projectiles.push({x:player.x+(player.facing>0?player.w:-14),y:player.y+player.h/2,dx:player.facing*10,w:20,h:8});
      kameSound(); player.lastShot=Date.now();
    }
  }
  player.dy+=0.8;if(player.dy>20)player.dy=20;
  player.x+=player.dx;player.y+=player.dy;
  handleMapCollisions();
  camX=Math.max(0,player.x-400);

  // enemigos
  enemies.forEach(en=>{
    if(en.type==='grunt'){en.x+=en.dx;if(en.x<60||en.x>maps[levelIndex][0].length*TILE-80)en.dx*=-1;}
  });

  enemies.forEach((en,i)=>{
    if(player.x<en.x+en.w&&player.x+player.w>en.x&&player.y<en.y+en.h&&player.y+player.h>en.y){
      if(player.dy>0){ // salto
        if(en.type==='miniboss'){en.hitCount++;if(en.hitCount>=en.hitsRequired)enemies.splice(i,1);}
        else enemies.splice(i,1);
        player.dy=-10;
      } else handlePlayerHit();
    }
  });

  // bandera
  let flagX=(maps[levelIndex][0].length-4)*TILE;
  if(player.x+player.w>flagX&&player.y<H-3*TILE){
    if(levelIndex<maps.length-1)loadLevel(levelIndex+1);
    else {alert('¡Ganaste!');loadLevel(0);}
  }
}

// Dibujo
function drawMap(map){
  for(let r=0;r<map.length;r++)for(let c=0;c<map[0].length;c++){
    let t=map[r][c]; let x=c*TILE-camX,y=r*TILE;
    if(t===1){ctx.fillStyle='#6b4322';ctx.fillRect(x,y,TILE,TILE);}
    if(t===3){ctx.fillStyle='#ffd84d';ctx.fillRect(x,y,TILE,TILE);}
    if(t===4){ctx.fillStyle='#ffd000';ctx.fillRect(x,y,TILE,TILE);}
    if(t===9){ctx.fillStyle='#6b4322';ctx.fillRect(x,y,TILE,TILE);}
  }
}
function drawPlayer(){
  let sx=player.x-camX, sy=player.y;
  ctx.fillStyle=player.powered?'#2ea3ff':'#ff7f00';
  ctx.fillRect(sx,sy,player.w,player.h);
}
function drawHUD(){
  ctx.fillStyle='rgba(0,0,0,0.3)';
  ctx.fillRect(10,10,400,60);
  ctx.fillStyle='#fff';
  ctx.font='20px monospace';
  ctx.fillText(`Vidas: ${lives}  Nivel: ${levelIndex+1}  Monedas: ${coins}`,20,40);
  ctx.font='16px monospace';
  ctx.fillText('Mover: Flechas/WASD  Saltar: Espacio/W/↑  Disparar: X',20,H-20);
}
function draw(){
  ctx.fillStyle='#87ceeb';ctx.fillRect(0,0,W,H);
  drawMap(maps[levelIndex]);
  powerups.forEach(p=>{ctx.fillStyle='#0ea3ff';ctx.fillRect(p.x-camX,p.y,32,32);});
  enemies.forEach(en=>{ctx.fillStyle=en.type==='miniboss'?'#802':'#2b5';ctx.fillRect(en.x-camX,en.y,en.w,en.h);});
  projectiles.forEach(p=>{ctx.fillStyle='#2ea3ff';ctx.fillRect(p.x-camX,p.y,p.w,p.h);});
  drawPlayer();
  drawHUD();
}

function loop(){step();draw();requestAnimationFrame(loop);}
createLevels();loadLevel(0);loop();
</script>
</body>
</html>
