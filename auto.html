<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèéÔ∏è Carrera a la Playa 3.0 (Corregido)</title>
    <style>
        body {
            margin: 0;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            user-select: none;
        }
        canvas {
            border: 5px solid #000;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            display: block;
            background: #4CAF50; /* Color de fondo fuera de la carretera */
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #FFEB3B;
            background: rgba(0,0,0,0.8);
            padding: 8px 18px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px #000;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            color: white;
            padding: 30px;
            border-radius: 15px;
            border: 5px solid #FFEB3B;
            display: none;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 235, 59, 0.7);
        }
        #message h2 {
            margin-top: 0;
            color: #FFEB3B;
        }
        #message button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #message button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <canvas id="game" width="480" height="640"></canvas>
    <div id="hud">Nivel: <span id="level">1</span> | Km: <span id="km">0</span> | Escudo: <span id="shield-hits">0</span></div>
    <div id="message">
        <h2 id="msg-title"></h2>
        <button onclick="restartGame()">Reiniciar</button>
    </div>
    <audio id="level-sound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
    <audio id="crash-sound" src="https://www.soundjay.com/transportation/sounds/car-crash-1.mp3" preload="auto"></audio>
    <audio id="powerup-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const hudLevel = document.getElementById('level');
        const hudKm = document.getElementById('km');
        const hudShield = document.getElementById('shield-hits');
        const message = document.getElementById('message');
        const levelSound = document.getElementById('level-sound');
        const crashSound = document.getElementById('crash-sound');
        const powerSound = document.getElementById('powerup-sound');

        // --- Configuraci√≥n del juego ---
        const lanes = 6;
        const roadWidth = 360;
        const laneWidth = roadWidth / lanes;
        const playerSize = {width: 40, height: 80};
        
        let player = {
            x: canvas.width/2 - playerSize.width/2, 
            y: canvas.height - 100, 
            width: playerSize.width, 
            height: playerSize.height, 
            shieldHits: 0
        };

        let obstacles = [];
        let objects = [];
        let keys = {};
        let km = 0;
        let level = 1;
        let baseSpeed = 4;
        let speed = baseSpeed;
        let gameOver = false;
        let turboTimer = 0;

        // --- Carga de im√°genes (Pixel Art) ---
        // URLs ACTUALIZADAS para autos m√°s "reales" y potenciadores
        const playerImg = new Image();
        playerImg.src = 'https://i.imgur.com/rN9eS4M.png'; // Coche Jugador (Amarillo)

        const obstacleImg = new Image();
        obstacleImg.src = 'https://i.imgur.com/vH9iVjL.png'; // Coche Enemigo (Rojo/Azul, mejor aspecto de auto)

        const shieldImg = new Image();
        shieldImg.src = 'https://i.imgur.com/c1h5N8X.png'; // Potenciador Escudo (S√≠mbolo de Escudo)

        const turboImg = new Image();
        turboImg.src = 'https://i.imgur.com/Qh15O2C.png'; // Potenciador Turbo (Rayo/Fuego)

        let imagesLoaded = false;
        let loadedCount = 0;
        const totalImages = 4;
        function imageLoaded() {
            loadedCount++;
            if (loadedCount === totalImages) {
                imagesLoaded = true;
                updateGame();
            }
        }
        playerImg.onload = imageLoaded;
        obstacleImg.onload = imageLoaded;
        shieldImg.onload = imageLoaded;
        turboImg.onload = imageLoaded;


        // --- Funciones de Dibujo (Se mantienen igual) ---

        function drawRoad(offset){
            ctx.fillStyle = '#555';
            ctx.fillRect(canvas.width/2 - roadWidth/2, 0, roadWidth, canvas.height);
            
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 5;
            ctx.setLineDash([40, 25]);
            
            for(let i = 1; i < lanes; i++){
                ctx.beginPath();
                const dashY = (offset % 65) - 65;
                ctx.moveTo(canvas.width/2 - roadWidth/2 + i * laneWidth, dashY);
                ctx.lineTo(canvas.width/2 - roadWidth/2 + i * laneWidth, canvas.height + dashY);
                ctx.stroke();
            }
            ctx.setLineDash([]);
        }

        function drawCar(car){
            let img = playerImg;
            if (turboTimer > 0) {
                 ctx.shadowColor = 'orange';
                 ctx.shadowBlur = 15;
            }
            
            ctx.drawImage(img, car.x, car.y, car.width, car.height);
            
            if (player.shieldHits > 0) {
                ctx.strokeStyle = `rgba(0, 191, 255, ${0.5 + Math.sin(Date.now() / 100) * 0.3})`;
                ctx.lineWidth = 5;
                ctx.strokeRect(car.x, car.y, car.width, car.height);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.shieldHits, car.x + car.width / 2, car.y + car.height + 20);
            }

            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
        }

        function drawObstacles(){
            obstacles.forEach(o => {
                ctx.drawImage(obstacleImg, o.x, o.y, o.width, o.height);
            });
        }

        function drawObjects(){
            objects.forEach(obj => {
                let img;
                if(obj.type === 1) img = shieldImg;
                if(obj.type === 3) img = turboImg;
                
                // Los objetos son un poco m√°s peque√±os para no chocar con ellos tan f√°cil
                const objSize = 35;
                ctx.drawImage(img, obj.x + (40 - objSize)/2, obj.y + (40 - objSize)/2, objSize, objSize);
            });
        }


        // --- L√≥gica del Juego (Modificada para m√°s frecuencia) ---

        function updateObstacles(){
            const currentSpeed = speed + (turboTimer > 0 ? 3 : 0);

            obstacles.forEach(o => o.y += currentSpeed);
            obstacles = obstacles.filter(o => o.y < canvas.height + 100);
            
            // Generaci√≥n de obst√°culos
            const obstacleSpawnChance = 0.015;
            if (Math.random() < obstacleSpawnChance) {
                const lane = Math.floor(Math.random() * lanes);
                
                // Evitar generar si hay un auto muy cerca verticalmente
                const isLaneOccupied = obstacles.some(o => 
                    o.y > -200 && o.y < 0 && 
                    Math.floor((o.x - (canvas.width/2 - roadWidth/2)) / laneWidth) === lane
                );
                
                // Evitar colisi√≥n adyacente (a menos que ya haya muchos km)
                const adjacentConflict = obstacles.some(o => 
                    o.y > -250 && o.y < 0 && 
                    (Math.floor((o.x - (canvas.width/2 - roadWidth/2)) / laneWidth) === lane + 1 || 
                     Math.floor((o.x - (canvas.width/2 - roadWidth/2)) / laneWidth) === lane - 1)
                );
                
                if (!isLaneOccupied && (!adjacentConflict || Math.random() < 0.2 + (level * 0.002))) {
                    obstacles.push({
                        x: canvas.width/2 - roadWidth/2 + lane*laneWidth + laneWidth/2 - 20,
                        y: -100,
                        width: 40,
                        height: 80
                    });
                }
            }
        }

        function updateObjects(){
            const currentSpeed = speed + (turboTimer > 0 ? 3 : 0);
            objects.forEach(o => o.y += currentSpeed);
            objects = objects.filter(o => o.y < canvas.height + 50);
            
            // PROBABILIDAD DE APARICI√ìN AUMENTADA
            const objectSpawnChance = 0.01; // Antes 0.005. Ahora el doble de probable.
            if (Math.random() < objectSpawnChance){
                const lane = Math.floor(Math.random() * lanes);
                const type = Math.random() < 0.5 ? 1 : 3; // 1: Escudo, 3: Turbo
                
                // Evitar generar sobre un obst√°culo que aparece al mismo tiempo
                const isLaneOccupied = obstacles.some(o => o.y > -100 && o.y < 0 && Math.floor((o.x - (canvas.width/2 - roadWidth/2)) / laneWidth) === lane);
                
                if (!isLaneOccupied) {
                    objects.push({
                        x: canvas.width/2 - roadWidth/2 + lane*laneWidth + laneWidth/2 - 20,
                        y: -50,
                        type,
                        width: 40,
                        height: 40
                    });
                }
            }
        }

        function checkCollision(){
            // Colisi√≥n con Obst√°culos
            for(let i = 0; i < obstacles.length; i++){
                let o = obstacles[i];
                if(player.x < o.x + o.width && player.x + player.width > o.x && player.y < o.y + o.height && player.y + player.height > o.y){
                    if(player.shieldHits > 0){
                        player.shieldHits--;
                        hudShield.textContent = player.shieldHits;
                        levelSound.currentTime = 0;
                        levelSound.play();
                        obstacles.splice(i, 1);
                        i--;
                    } else {
                        crashSound.play();
                        endGame();
                        return;
                    }
                }
            }
            
            // Colisi√≥n con Objetos (Power-ups)
            for(let i = 0; i < objects.length; i++){
                let obj = objects[i];
                // Chequeo de colisi√≥n m√°s preciso para los objetos (40x40)
                if(player.x < obj.x + 40 && player.x + player.width > obj.x && player.y < obj.y + 40 && player.y + player.height > obj.y){
                    powerSound.play();
                    
                    if(obj.type === 1){ // Escudo (Hits)
                        player.shieldHits = Math.min(player.shieldHits + 4, 10); // M√°ximo 10 golpes
                        hudShield.textContent = player.shieldHits;
                    }
                    if(obj.type === 3){ // Turbo (Velocidad)
                        turboTimer = 300; // 5 segundos de turbo
                    }
                    
                    objects.splice(i, 1);
                    i--;
                }
            }
        }

        function movePlayer(){
            const moveSpeed = 7;
            if(keys['ArrowLeft'] || keys['a']) player.x -= moveSpeed;
            if(keys['ArrowRight'] || keys['d']) player.x += moveSpeed;
            if(keys['ArrowUp'] || keys['w']) player.y -= moveSpeed * 0.5;
            if(keys['ArrowDown'] || keys['s']) player.y += moveSpeed * 0.5;
            
            const roadLeft = canvas.width / 2 - roadWidth / 2;
            const roadRight = canvas.width / 2 + roadWidth / 2;
            
            if(player.x < roadLeft) player.x = roadLeft;
            if(player.x + player.width > roadRight) player.x = roadRight - player.width;
            if(player.y < 0) player.y = 0;
            if(player.y + player.height > canvas.height) player.y = canvas.height - player.height;
        }

        let roadOffset = 0;
        function updateGame(){
            if(gameOver || !imagesLoaded) {
                if (!imagesLoaded) {
                     ctx.fillStyle = 'white';
                     ctx.font = '20px Arial';
                     ctx.textAlign = 'center';
                     ctx.fillText("Cargando Pixel Art...", canvas.width/2, canvas.height/2);
                }
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const currentSpeed = speed + (turboTimer > 0 ? 3 : 0);
            roadOffset = (roadOffset + currentSpeed) % 65;
            
            drawRoad(roadOffset);
            drawObstacles();
            drawObjects();
            drawCar(player);
            
            movePlayer();
            updateObstacles();
            updateObjects();
            checkCollision();

            if (turboTimer > 0) turboTimer--;
            
            km += currentSpeed * 0.05;
            hudKm.textContent = Math.floor(km);
            
            if(Math.floor(km) >= level * 100){
                level++;
                speed += 0.3;
                hudLevel.textContent = level;
                levelSound.play();
                
                if(level > 100){
                    winGame();
                    return;
                }
            }
            
            requestAnimationFrame(updateGame);
        }

        function endGame(){
            gameOver = true;
            document.getElementById('msg-title').innerHTML = "üí• ¬°Choque! Kil√≥metros: " + Math.floor(km);
            message.style.display = 'block';
        }

        function winGame(){
            gameOver = true;
            document.getElementById('msg-title').innerHTML = "üèñÔ∏è ¬°Llegaste a la Playa en Nivel 100!";
            message.style.display = 'block';
        }

        window.restartGame = function(){
            player.x = canvas.width / 2 - playerSize.width / 2;
            player.y = canvas.height - 100;
            obstacles = [];
            objects = [];
            km = 0;
            level = 1;
            speed = baseSpeed;
            gameOver = false;
            player.shieldHits = 0;
            turboTimer = 0;
            hudLevel.textContent = 1;
            hudKm.textContent = 0;
            hudShield.textContent = 0;
            message.style.display = 'none';
            
            if (imagesLoaded) {
                updateGame();
            }
        }

        // --- Eventos de teclado ---
        document.addEventListener('keydown', e => keys[e.key] = true);
        document.addEventListener('keyup', e => keys[e.key] = false);

        if (!imagesLoaded) {
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("Cargando Pixel Art...", canvas.width/2, canvas.height/2);
        }
    </script>
</body>
</html>
