<script type="module">
        // Importa la clase GoogleGenAI
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // ***************************************************************
        //  ADVERTENCIA DE SEGURIDAD: CLAVE API INCLUIDA PÚBLICAMENTE.
        //  Cualquiera que vea este código podrá usar tu clave.
        // ***************************************************************
        // LA CLAVE API ESTÁ AQUÍ
        const API_KEY = "AIzaSyDCk3sH_mOcd2SSPYF8s32cc9Xgmsz_6mw"; 
        
        // Verificación: Solo inicializamos si la clave es una cadena válida
        let ai = null;
        try {
             if (!API_KEY || API_KEY.length < 20) {
                throw new Error("La clave API no está configurada o es demasiado corta.");
             }
             ai = new GoogleGenAI(API_KEY);
        } catch (e) {
             console.error("Error de inicialización de Gemini:", e.message);
        }

        const model = "gemini-2.5-flash"; // El modelo solicitado

        // 1. EL PROMPT DE PERSONALIDAD BASE (CAPA DE PERSONALIDAD)
        const PERSONALITY_PROMPT = `
            Eres un asistente de desarrollo y programación altamente especializado que atiende en nombre de **NovelBerry**.
            Tu misión es ayudar a los usuarios con código, algoritmos, depuración, diseño de sistemas y tecnologías de desarrollo web/software.
            Tu tono debe ser profesional, preciso, amigable y muy enfocado en la solución de problemas de programación.
            Cuando respondas, empieza siempre con una frase que refleje tu rol (ej: "Hola, soy el especialista de NovelBerry al habla", "Como asistente de desarrollo para NovelBerry...").
            Tu respuesta debe ser en español.
        `;

        // 2. FUNCIÓN DE CHAT PRINCIPAL
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const outputDiv = document.getElementById('output');
            const message = userInput.value.trim();

            if (message === "") return;

            // Bloquea el envío si la inicialización falló
            if (!ai) {
                 outputDiv.innerHTML += `<div class="ai-message" style="color: red;">**Error Fatal:** El cliente de Gemini no se pudo inicializar. Revisa la Consola para ver el error de la clave API.</div>`;
                 outputDiv.scrollTop = outputDiv.scrollHeight;
                 return;
            }

            // Mostrar el mensaje del usuario
            outputDiv.innerHTML += `<div class="user-message">**Tú:** ${message}</div>`;
            userInput.value = '';

            // Mostrar indicador de carga y asegurar el scroll
            outputDiv.innerHTML += `<div id="loading" class="ai-message">El asistente de NovelBerry está pensando...</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;

            // 3. CAPA DE PRE-PERSONALIZACIÓN: Se combina la personalidad con la solicitud del usuario.
            const fullPrompt = `${PERSONALITY_PROMPT}\n\n---SOLICITUD DEL USUARIO---\n\n${message}`;

            try {
                // Llamada a la API de Gemini
                const response = await ai.models.generateContent({
                    model: model,
                    contents: fullPrompt
                });
                
                const aiResponseText = response.text;

                // Eliminar el indicador de carga
                const loadingIndicator = document.getElementById('loading');
                if (loadingIndicator) loadingIndicator.remove();

                // Mostrar la respuesta de la IA
                outputDiv.innerHTML += `<div class="ai-message">**NovelBerry Assistant:** ${aiResponseText}</div>`;

            } catch (error) {
                // Eliminar el indicador de carga en caso de error
                const loadingIndicator = document.getElementById('loading');
                if (loadingIndicator) loadingIndicator.remove();
                
                console.error("Error al comunicarse con la API de Gemini:", error);
                outputDiv.innerHTML += `<div class="ai-message" style="color: red;">**Error de API:** Lo siento, ocurrió un error (${error.message}). Revisa tu clave y restricciones.</div>`;
            }

            outputDiv.scrollTop = outputDiv.scrollHeight; // Scroll al fondo
        }

        // Asignar la función al botón y a la tecla Enter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            // Mensaje de bienvenida inicial
            if (ai) {
                document.getElementById('output').innerHTML = `<div class="ai-message">**NovelBerry Assistant:** ¡Hola! Soy el especialista de desarrollo que atiende en nombre de NovelBerry. Estoy listo para ayudarte.</div>`;
            } else {
                document.getElementById('output').innerHTML = `<div class="ai-message" style="color: red;">**ERROR:** No se pudo iniciar la conexión con Gemini. Revisa la Consola para la razón.</div>`;
            }
        });
    </script>
